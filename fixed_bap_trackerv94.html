<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Workflow Tracker - Working Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .add-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .sample-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        input, select, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .sample-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sample-info {
            flex: 1;
        }
        
        .sample-actions {
            display: flex;
            gap: 10px;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-received { background: #e9ecef; color: #495057; }
        .status-bap-complete { background: #d4edda; color: #155724; }
        .status-tsb-complete { background: #fff3cd; color: #856404; }
        .status-extraction-complete { background: #f3e5f5; color: #7b1fa2; }
        .status-clean-extraction-complete { background: #e8f5e8; color: #2e7d32; }
        .status-indexing-complete { background: #e3f2fd; color: #1976d2; }
        .status-qubit-complete { background: #fff3e0; color: #f57c00; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .btn-cancel {
            background: #6c757d;
        }
        
        .batch-controls {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }
        
        .batch-controls h4 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .sample-checkbox {
            margin-right: 8px;
        }
        
        .btn-batch {
            background: #ff9800;
            color: white;
        }
        
        .btn-batch:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ§ª Complete Lab Workflow Tracker</h1>
        <p>BAP â†’ TSB â†’ Extraction â†’ Clean Extraction â†’ Indexing â†’ Qubit</p>
    </div>

    <div class="add-section">
        <h3>Add New Samples</h3>
        
        <!-- Single Sample Input -->
        <div id="singleInput">
            <h4>Single Sample:</h4>
            <input type="text" id="sampleId" placeholder="Sample ID">
            <input type="text" id="initials" placeholder="Initials" maxlength="3">
            <button onclick="addSample()">Add Sample</button>
        </div>
        
        <!-- Toggle Button -->
        <div style="margin: 20px 0; text-align: center;">
            <button id="toggleBulk" onclick="toggleBulkInput()">Switch to Bulk Input</button>
        </div>
        
        <!-- Bulk Sample Input -->
        <div id="bulkInput" style="display: none;">
            <h4>Bulk Sample Input:</h4>
            <p><small>Paste sample IDs (one per line). Your initials will be applied to all samples.</small></p>
            <input type="text" id="bulkInitials" placeholder="Your initials (for all samples)" maxlength="3">
            <textarea id="bulkSamples" rows="6" placeholder="Paste sample IDs here, one per line:&#10;25KS01-001&#10;25KS01-002&#10;25KS01-003" style="width: 100%; margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button onclick="addBulkSamples()">Add All Samples</button>
        </div>
    </div>

    <div class="sample-list">
        <h3>Samples</h3>
        
        <div class="batch-controls" id="batchControls" style="display: none;">
            <h4>ðŸ§ª Batch Processing</h4>
            <p><span id="selectedCount">0</span> samples selected</p>
            <button class="btn-batch" id="batchBtn" disabled onclick="startBatchProcess()">Start Batch</button>
            <button onclick="clearSelection()">Clear Selection</button>
        </div>
        
        <div id="sampleContainer"></div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBatchModal()">&times;</span>
            <h3 id="batchModalTitle">Batch Processing</h3>
            <p>Processing <strong id="batchSampleCount">0</strong> samples</p>
            <p id="batchNumbers"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="batchTechInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="batchLotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="batchTemperature">
                    <option value="37">37Â°C</option>
                    <option value="35">35Â°C</option>
                    <option value="42">42Â°C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="batchIncubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>
            
            <button onclick="completeBatchProcess()">Complete Batch</button>
            <button class="btn-cancel" onclick="closeBatchModal()">Cancel</button>
        </div>
    </div>

    <!-- Individual Modal -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Process Sample</h3>
            <p>Sample: <strong id="modalSampleId"></strong></p>
            <p id="modalNumber"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="techInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="lotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="temperature">
                    <option value="37">37Â°C</option>
                    <option value="35">35Â°C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="incubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>
            
            <div id="specificFields"></div>
            
            <button onclick="completeProcess()">Complete</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        var samples = [];
        var nextBapNumber = 1;
        var nextTsbNumber = 1;
        var nextExtractionNumber = 1;
        var nextExtractionRun = 1;
        var nextCleanExtractionNumber = 1;
        var nextCleanExtractionPlate = 1;
        var nextIndexingNumber = 1;
        var nextIndexingPlate = 1;
        var currentProcessType = '';
        var selectedSamples = [];
        var currentBatchSamples = [];
        var currentBatchType = '';

        function generateWellPosition(index) {
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var row = rows[index % 8];
            var col = String(Math.floor(index / 8) + 1);
            if (col.length === 1) col = '0' + col;
            return row + col;
        }

        function createReferenceTable(sampleIds, sourceType, targetType, targetStartNumber) {
            var html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Sample ID</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Use ' + sourceType.toUpperCase() + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">New ' + targetType.toUpperCase() + '</th>';
            html += '</tr>';
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                var sourceNumber = 'N/A';
                var targetNumber = 'N/A';
                
                if (sourceType === 'bap' && sample && sample.bapNumber) {
                    sourceNumber = sample.bapNumber;
                } else if (sourceType === 'tsb' && sample && sample.tsbNumber) {
                    sourceNumber = sample.tsbNumber;
                } else if (sourceType === 'extraction' && sample && sample.extractionNumber) {
                    sourceNumber = sample.extractionNumber;
                } else if (sourceType === 'cleanExtraction' && sample && sample.cleanExtractionNumber) {
                    sourceNumber = sample.cleanExtractionNumber;
                } else if (sourceType === 'indexing' && sample && sample.indexingNumber) {
                    sourceNumber = sample.indexingNumber;
                }
                
                if (targetType === 'TSB') {
                    targetNumber = '25T' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Extraction') {
                    targetNumber = '25E' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Clean Extraction') {
                    targetNumber = '25CE' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Indexing') {
                    targetNumber = '25XT' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Qubit') {
                    targetNumber = 'Qubit Analysis';
                }
                
                html += '<tr>';
                html += '<td style="padding: 8px; border: 1px solid #ddd;"><strong>' + sampleId + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #1976d2;"><strong>' + sourceNumber + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #2e7d32;"><strong>' + targetNumber + '</strong></td>';
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            return html;
        }

        function addSample() {
            var sampleId = document.getElementById('sampleId').value.trim();
            var initials = document.getElementById('initials').value.trim().toUpperCase();
            
            if (!sampleId || !initials) {
                alert('Please fill in both fields');
                return;
            }
            
            // Check for duplicates
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    alert('Sample ' + sampleId + ' already exists!');
                    return;
                }
            }
            
            var newSample = {
                id: sampleId,
                initials: initials,
                status: 'Received',
                dateAdded: new Date().toLocaleDateString(),
                bapNumber: null,
                bapDetails: null,
                tsbNumber: null,
                tsbDetails: null,
                extractionNumber: null,
                extractionDetails: null,
                cleanExtractionNumber: null,
                cleanExtractionDetails: null,
                indexingNumber: null,
                indexingDetails: null,
                qubitDetails: null
            };
            
            samples.push(newSample);
            renderSamples();
            
            document.getElementById('sampleId').value = '';
            document.getElementById('initials').value = '';
        }

        function toggleBulkInput() {
            var single = document.getElementById('singleInput');
            var bulk = document.getElementById('bulkInput');
            var btn = document.getElementById('toggleBulk');
            
            if (single.style.display === 'none') {
                single.style.display = 'block';
                bulk.style.display = 'none';
                btn.textContent = 'Switch to Bulk Input';
            } else {
                single.style.display = 'none';
                bulk.style.display = 'block';
                btn.textContent = 'Switch to Single Input';
            }
        }

        function addBulkSamples() {
            var text = document.getElementById('bulkSamples').value.trim();
            var initials = document.getElementById('bulkInitials').value.trim().toUpperCase();
            
            if (!text || !initials) {
                alert('Please enter initials and paste sample IDs');
                return;
            }
            
            var lines = text.split('\n');
            var sampleIds = [];
            
            // Clean up the input lines
            for (var i = 0; i < lines.length; i++) {
                var id = lines[i].trim();
                if (id.length > 0) {
                    sampleIds.push(id);
                }
            }
            
            if (sampleIds.length === 0) {
                alert('No valid sample IDs found');
                return;
            }
            
            var added = 0;
            var duplicates = [];
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                
                // Check for duplicates
                var isDuplicate = false;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        duplicates.push(sampleId);
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    var newSample = {
                        id: sampleId,
                        initials: initials,
                        status: 'Received',
                        dateAdded: new Date().toLocaleDateString(),
                        bapNumber: null,
                        bapDetails: null,
                        tsbNumber: null,
                        tsbDetails: null,
                        extractionNumber: null,
                        extractionDetails: null,
                        cleanExtractionNumber: null,
                        cleanExtractionDetails: null,
                        indexingNumber: null,
                        indexingDetails: null,
                        qubitDetails: null
                    };
                    
                    samples.push(newSample);
                    added++;
                }
            }
            
            renderSamples();
            
            // Clear the form
            document.getElementById('bulkSamples').value = '';
            document.getElementById('bulkInitials').value = '';
            
            // Show results
            var message = 'Successfully added ' + added + ' new samples!';
            if (duplicates.length > 0) {
                message += '\n\nSkipped ' + duplicates.length + ' duplicates: ' + duplicates.join(', ');
            }
            alert(message);
        }

        function startProcess(sampleId, type) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;
            
            currentProcessType = type;
            var number = '';
            
            if (type === 'BAP') {
                number = '25B' + String(nextBapNumber).padStart(3, '0');
            } else if (type === 'TSB') {
                number = '25T' + String(nextTsbNumber).padStart(3, '0');
            } else if (type === 'Extraction') {
                number = '25E' + String(nextExtractionNumber).padStart(3, '0');
            } else if (type === 'Clean Extraction') {
                number = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
            } else if (type === 'Indexing') {
                number = '25XT' + String(nextIndexingNumber).padStart(3, '0');
            } else if (type === 'Qubit') {
                number = 'Qubit Analysis';
            }
            
            document.getElementById('modalTitle').textContent = 'Start ' + type;
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';
            
            showSpecificFields(type);
            document.getElementById('processModal').style.display = 'block';
        }

        function showSpecificFields(type) {
            var container = document.getElementById('specificFields');
            var html = '';
            
            if (type === 'TSB') {
                // Add BAP reference for TSB
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.bapDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ðŸ“‹ BAP Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use BAP:</strong> ' + sample.bapNumber + '</div>';
                    html += '<div><strong>BAP Tech:</strong> ' + sample.bapDetails.technician + '</div>';
                    html += '<div><strong>BAP Date:</strong> ' + sample.bapDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Extraction') {
                // Add TSB reference for Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.tsbDetails) {
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #856404;">ðŸ§« TSB Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use TSB:</strong> ' + sample.tsbNumber + '</div>';
                    html += '<div><strong>TSB Tech:</strong> ' + sample.tsbDetails.technician + '</div>';
                    html += '<div><strong>TSB Date:</strong> ' + sample.tsbDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Clean Extraction') {
                // Add Extraction reference for Clean Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.extractionDetails) {
                    html += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #9c27b0;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">ðŸ§¬ Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Extraction:</strong> ' + sample.extractionNumber + '</div>';
                    html += '<div><strong>Extraction Tech:</strong> ' + sample.extractionDetails.technician + '</div>';
                    html += '<div><strong>Extraction Date:</strong> ' + sample.extractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Indexing') {
                // Add Clean Extraction reference for Indexing
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.cleanExtractionDetails) {
                    html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ§½ Clean Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
                    html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
                    html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '<div class="form-group">';
                html += '<label>i5 Index:</label>';
                html += '<input type="text" id="i5Index" placeholder="i5-001">';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label>i7 Index:</label>';
                html += '<input type="text" id="i7Index" placeholder="i7-001">';
                html += '</div>';
            } else if (type === 'Qubit') {
                // Add Indexing reference for Qubit
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.indexingDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ðŸ”¬ Indexing Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Indexing:</strong> ' + sample.indexingNumber + '</div>';
                    html += '<div><strong>Indexing Tech:</strong> ' + sample.indexingDetails.technician + '</div>';
                    html += '<div><strong>Indexing Date:</strong> ' + sample.indexingDetails.completedDate + '</div>';
                    if (sample.indexingDetails.i5 && sample.indexingDetails.i7) {
                        html += '<div><strong>i5 Index:</strong> ' + sample.indexingDetails.i5 + '</div>';
                        html += '<div><strong>i7 Index:</strong> ' + sample.indexingDetails.i7 + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '<div class="form-group">';
                html += '<label>Concentration (ng/uL):</label>';
                html += '<input type="number" id="qubitConcentration" step="0.1">';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function completeProcess() {
            var tech = document.getElementById('techInitials').value.trim();
            var lot = document.getElementById('lotNumber').value.trim();
            var temp = document.getElementById('temperature').value;
            var inc = document.getElementById('incubator').value;
            
            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var sampleId = document.getElementById('modalSampleId').textContent;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            
            if (sample) {
                var today = new Date().toLocaleDateString();
                
                if (currentProcessType === 'BAP') {
                    sample.bapNumber = '25B' + String(nextBapNumber).padStart(3, '0');
                    sample.status = 'BAP Complete';
                    sample.bapDetails = { technician: tech, lot: lot, completedDate: today };
                    nextBapNumber++;
                } else if (currentProcessType === 'TSB') {
                    sample.tsbNumber = '25T' + String(nextTsbNumber).padStart(3, '0');
                    sample.status = 'TSB Complete';
                    sample.tsbDetails = { technician: tech, lot: lot, completedDate: today };
                    nextTsbNumber++;
                } else if (currentProcessType === 'Extraction') {
                    sample.extractionNumber = '25E' + String(nextExtractionNumber).padStart(3, '0');
                    sample.status = 'Extraction Complete';
                    sample.extractionDetails = { technician: tech, lot: lot, completedDate: today };
                    nextExtractionNumber++;
                } else if (currentProcessType === 'Clean Extraction') {
                    sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
                    sample.status = 'Clean Extraction Complete';
                    sample.cleanExtractionDetails = { technician: tech, lot: lot, completedDate: today };
                    nextCleanExtractionNumber++;
                } else if (currentProcessType === 'Indexing') {
                    sample.indexingNumber = '25XT' + String(nextIndexingNumber).padStart(3, '0');
                    sample.status = 'Indexing Complete';
                    sample.indexingDetails = { 
                        technician: tech, 
                        lot: lot, 
                        completedDate: today,
                        i5: document.getElementById('i5Index').value,
                        i7: document.getElementById('i7Index').value
                    };
                    nextIndexingNumber++;
                } else if (currentProcessType === 'Qubit') {
                    sample.status = 'Qubit Complete';
                    sample.qubitDetails = { 
                        concentration: document.getElementById('qubitConcentration').value,
                        technician: tech,
                        completedDate: today
                    };
                }
                
                renderSamples();
                closeModal();
                alert(currentProcessType + ' completed!');
            }
        }

        function startBatchProcess() {
            console.log('Batch process started');
            
            var receivedSamples = [];
            var bapSamples = [];
            var tsbSamples = [];
            var extractionSamples = [];
            var cleanExtractionSamples = [];
            var indexingSamples = [];
            
            for (var i = 0; i < selectedSamples.length; i++) {
                var id = selectedSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === id) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
                    if (sample.status === 'Received') receivedSamples.push(id);
                    else if (sample.status === 'BAP Complete') bapSamples.push(id);
                    else if (sample.status === 'TSB Complete') tsbSamples.push(id);
                    else if (sample.status === 'Extraction Complete') extractionSamples.push(id);
                    else if (sample.status === 'Clean Extraction Complete') cleanExtractionSamples.push(id);
                    else if (sample.status === 'Indexing Complete') indexingSamples.push(id);
                }
            }
            
            console.log('Batch counts: received=' + receivedSamples.length + ' indexing=' + indexingSamples.length);
            
            if (receivedSamples.length >= 2) {
                openBatchModal(receivedSamples, 'BAP');
            } else if (bapSamples.length >= 2) {
                openBatchModal(bapSamples, 'TSB');
            } else if (tsbSamples.length >= 2) {
                openBatchModal(tsbSamples, 'Extraction');
            } else if (extractionSamples.length >= 2) {
                openBatchModal(extractionSamples, 'Clean Extraction');
            } else if (cleanExtractionSamples.length >= 2) {
                openBatchModal(cleanExtractionSamples, 'Indexing');
            } else if (indexingSamples.length >= 2) {
                console.log('Opening Qubit batch modal');
                openBatchModal(indexingSamples, 'Qubit');
            } else {
                alert('Please select samples of the same type');
            }
        }

        function openBatchModal(sampleIds, type) {
            console.log('Opening batch modal for type: ' + type);
            currentBatchSamples = sampleIds;
            currentBatchType = type;
            
            document.getElementById('batchModalTitle').textContent = 'Batch ' + type;
            document.getElementById('batchSampleCount').textContent = sampleIds.length;
            
            var numbersHtml = '<strong>Processing ' + sampleIds.length + ' samples</strong>';
            
            // Add reference tables for each workflow step
            if (type === 'TSB') {
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ðŸ“‹ BAP â†’ TSB Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'bap', 'TSB', nextTsbNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the BAP plates listed above for each corresponding TSB</p>';
                numbersHtml += '</div>';
            } else if (type === 'Extraction') {
                numbersHtml += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #856404;">ðŸ§« TSB â†’ Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'tsb', 'Extraction', nextExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the TSB plates listed above for each corresponding Extraction</p>';
                numbersHtml += '</div>';
            } else if (type === 'Clean Extraction') {
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">ðŸ§¬ Extraction â†’ Clean Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'extraction', 'Clean Extraction', nextCleanExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Extraction plates listed above for each corresponding Clean Extraction</p>';
                numbersHtml += '</div>';
            } else if (type === 'Indexing') {
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">ðŸ§½ Clean Extraction â†’ Indexing Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Indexing', nextIndexingNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Indexing</p>';
                numbersHtml += '</div>';
            } else if (type === 'Qubit') {
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ðŸ”¬ Indexing â†’ Qubit Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'indexing', 'Qubit', 0);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Indexing plates listed above for each corresponding Qubit</p>';
                numbersHtml += '</div>';
            }
            
            document.getElementById('batchNumbers').innerHTML = numbersHtml;
            document.getElementById('batchModal').style.display = 'block';
        }

        function completeBatchProcess() {
            var tech = document.getElementById('batchTechInitials').value.trim();
            var lot = document.getElementById('batchLotNumber').value.trim();
            
            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var today = new Date().toLocaleDateString();
            
            for (var i = 0; i < currentBatchSamples.length; i++) {
                var sampleId = currentBatchSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
                    if (currentBatchType === 'BAP') {
                        sample.bapNumber = '25B' + String(nextBapNumber + i).padStart(3, '0');
                        sample.status = 'BAP Complete';
                        sample.bapDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'TSB') {
                        sample.tsbNumber = '25T' + String(nextTsbNumber + i).padStart(3, '0');
                        sample.status = 'TSB Complete';
                        sample.tsbDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'Extraction') {
                        sample.extractionNumber = '25E' + String(nextExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Extraction Complete';
                        sample.extractionDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'Clean Extraction') {
                        sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Clean Extraction Complete';
                        sample.cleanExtractionDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'Indexing') {
                        sample.indexingNumber = '25XT' + String(nextIndexingNumber + i).padStart(3, '0');
                        sample.status = 'Indexing Complete';
                        sample.indexingDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'Qubit') {
                        sample.status = 'Qubit Complete';
                        sample.qubitDetails = { technician: tech, completedDate: today, concentration: '0.0' };
                    }
                }
            }
            
            if (currentBatchType === 'BAP') nextBapNumber += currentBatchSamples.length;
            else if (currentBatchType === 'TSB') nextTsbNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Extraction') nextExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Clean Extraction') nextCleanExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Indexing') nextIndexingNumber += currentBatchSamples.length;
            
            clearSelection();
            renderSamples();
            closeBatchModal();
            alert('Batch ' + currentBatchType + ' completed!');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            currentBatchSamples = [];
            currentBatchType = '';
        }

        function closeModal() {
            document.getElementById('processModal').style.display = 'none';
        }

        function updateSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            selectedSamples = [];
            for (var i = 0; i < checkboxes.length; i++) {
                selectedSamples.push(checkboxes[i].value);
            }
            
            console.log('Selected samples: ' + selectedSamples.join(','));
            
            var count = document.getElementById('selectedCount');
            var batchBtn = document.getElementById('batchBtn');
            var batchControls = document.getElementById('batchControls');
            
            count.textContent = selectedSamples.length;
            
            if (selectedSamples.length >= 2) {
                batchControls.style.display = 'block';
                batchBtn.disabled = false;
                batchBtn.textContent = 'Start Batch Processing';
            } else {
                batchControls.style.display = 'none';
                batchBtn.disabled = true;
            }
        }

        function clearSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            selectedSamples = [];
            updateSelection();
        }

        function viewSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;
            
            var chain = 'SAMPLE: ' + sample.id + '\n';
            chain += 'Status: ' + sample.status + '\n';
            chain += 'Added: ' + sample.dateAdded + ' by ' + sample.initials + '\n\n';
            
            if (sample.bapDetails) chain += 'BAP: ' + sample.bapNumber + '\n';
            if (sample.tsbDetails) chain += 'TSB: ' + sample.tsbNumber + '\n';
            if (sample.extractionDetails) chain += 'Extraction: ' + sample.extractionNumber + '\n';
            if (sample.cleanExtractionDetails) chain += 'Clean Extraction: ' + sample.cleanExtractionNumber + '\n';
            if (sample.indexingDetails) chain += 'Indexing: ' + sample.indexingNumber + '\n';
            if (sample.qubitDetails) chain += 'Qubit: ' + sample.qubitDetails.concentration + ' ng/uL\n';
            
            alert(chain);
        }

        function renderSamples() {
            var container = document.getElementById('sampleContainer');
            
            if (samples.length === 0) {
                container.innerHTML = '<p>No samples yet. Add one above!</p>';
                return;
            }
            
            var receivedCount = 0;
            var bapCount = 0;
            var tsbCount = 0;
            var extractionCount = 0;
            var cleanExtractionCount = 0;
            var indexingCount = 0;
            
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].status === 'Received') receivedCount++;
                else if (samples[i].status === 'BAP Complete') bapCount++;
                else if (samples[i].status === 'TSB Complete') tsbCount++;
                else if (samples[i].status === 'Extraction Complete') extractionCount++;
                else if (samples[i].status === 'Clean Extraction Complete') cleanExtractionCount++;
                else if (samples[i].status === 'Indexing Complete') indexingCount++;
            }
            
            var html = '';
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var showCheckbox = false;
                
                if (receivedCount >= 2 && sample.status === 'Received') showCheckbox = true;
                else if (bapCount >= 2 && sample.status === 'BAP Complete') showCheckbox = true;
                else if (tsbCount >= 2 && sample.status === 'TSB Complete') showCheckbox = true;
                else if (extractionCount >= 2 && sample.status === 'Extraction Complete') showCheckbox = true;
                else if (cleanExtractionCount >= 2 && sample.status === 'Clean Extraction Complete') showCheckbox = true;
                else if (indexingCount >= 2 && sample.status === 'Indexing Complete') showCheckbox = true;
                
                html += '<div class="sample-item">';
                html += '<div class="sample-info">';
                
                if (showCheckbox) {
                    html += '<input type="checkbox" class="sample-checkbox" value="' + sample.id + '" onchange="updateSelection()">';
                }
                
                html += '<strong>' + sample.id + '</strong> ';
                html += '<span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span>';
                html += '<br><small>Added: ' + sample.dateAdded + ' | ' + sample.initials + '</small>';
                
                if (sample.bapDetails) html += '<br>BAP: ' + sample.bapNumber;
                if (sample.tsbDetails) html += '<br>TSB: ' + sample.tsbNumber;
                if (sample.extractionDetails) html += '<br>Extraction: ' + sample.extractionNumber;
                if (sample.cleanExtractionDetails) html += '<br>Clean Extraction: ' + sample.cleanExtractionNumber;
                if (sample.indexingDetails) html += '<br>Indexing: ' + sample.indexingNumber;
                if (sample.qubitDetails) html += '<br>Qubit: ' + sample.qubitDetails.concentration + ' ng/uL';
                
                html += '</div>';
                html += '<div class="sample-actions">';
                html += '<button onclick="viewSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">View</button><br>';
                
                if (sample.status === 'Received') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'BAP\')">Start BAP</button>';
                } else if (sample.status === 'BAP Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'TSB\')">Start TSB</button>';
                } else if (sample.status === 'TSB Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Extraction\')">Start Extraction</button>';
                } else if (sample.status === 'Extraction Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction\')">Start Clean Extraction</button>';
                } else if (sample.status === 'Clean Extraction Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Indexing\')">Start Indexing</button>';
                } else if (sample.status === 'Indexing Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Qubit\')">Start Qubit</button>';
                } else {
                    html += '<div style="color: green; font-weight: bold; text-align: center;">âœ“ Complete</div>';
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            updateSelection();
        }

        renderSamples();
        console.log('Lab Workflow Tracker loaded successfully!');
    </script>
</body>
</html>>