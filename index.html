<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Workflow Tracker - Working Version</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #ddd;
            --header-bg: #ffffff;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --header-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        #passwordOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #passwordBox {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #passwordBox input {
            padding: 10px;
            margin: 10px 0;
            width: 250px;
            font-size: 16px;
        }

        #passwordBox button {
            padding: 10px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        #passwordBox button:hover {
            background: #0056b3;
        }

        #appContent {
            display: none;
        }
        
        .header {
            background: var(--header-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            transition: background-color 0.3s;
        }

        .add-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .sample-list {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        input, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        button {
            padding: 8px 12px;
            margin: 5px;
            border: none;
            border-radius: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .sample-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .sample-info {
            flex: 1;
        }
        
        .sample-actions {
            display: flex;
            gap: 10px;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-received { background: #e9ecef; color: #495057; }
        .status-bap-complete { background: #d4edda; color: #155724; }
        .status-tsb-complete { background: #fff3cd; color: #856404; }
        .status-extraction-complete { background: #f3e5f5; color: #7b1fa2; }
        .status-clean-extraction-complete { background: #e8f5e8; color: #2e7d32; }
        .status-indexing-complete { background: #e3f2fd; color: #1976d2; }
        .status-qubit-complete { background: #fff3e0; color: #f57c00; }
        .status-clean-extraction-qubit-complete { background: #e8f4fd; color: #1565c0; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .btn-cancel {
            background: #6c757d;
        }

        kbd {
            display: inline-block;
            padding: 3px 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            line-height: 1.4;
            color: #333;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), inset 0 0 0 2px #fff;
            white-space: nowrap;
        }

        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            min-width: 150px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .bar-wrapper {
            flex: 1;
            height: 30px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-date {
            min-width: 120px;
            font-weight: bold;
            color: var(--text-secondary);
            padding-right: 20px;
            text-align: right;
        }

        .timeline-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid var(--bg-secondary);
            position: relative;
            flex-shrink: 0;
            margin: 0 20px;
            z-index: 1;
        }

        .timeline-marker::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 50px;
            background: #ddd;
        }

        .timeline-item:last-child .timeline-marker::before {
            display: none;
        }

        .timeline-content {
            flex: 1;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .timeline-content h4 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .timeline-content p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .timeline-stage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Plate Map Styles */
        .plate-map {
            display: inline-block;
            border: 2px solid #333;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .plate-map table {
            border-collapse: collapse;
            font-size: 10px;
        }

        .plate-map th, .plate-map td {
            width: 40px;
            height: 40px;
            border: 1px solid #999;
            text-align: center;
            vertical-align: middle;
            padding: 2px;
            position: relative;
        }

        .plate-map th {
            background: #e9ecef;
            font-weight: bold;
        }

        .plate-map td {
            background: #f8f9fa;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .plate-map td:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .plate-map .well-occupied {
            background: #d4edda;
            font-weight: bold;
        }

        .plate-map .well-id {
            display: block;
            font-size: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .batch-controls {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }
        
        .batch-controls h4 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .sample-checkbox {
            margin-right: 8px;
        }
        
        .btn-batch {
            background: #ff9800;
            color: white;
        }
        
        .btn-batch:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Print Stylesheet */
        @media print {
            /* Hide interactive elements */
            #passwordOverlay,
            .add-section,
            button,
            input[type="text"],
            input[type="radio"],
            select,
            #searchInput,
            .modal,
            #quickStats,
            .close-btn {
                display: none !important;
            }

            /* Page setup */
            body {
                background: white;
                margin: 0;
                padding: 10mm;
                font-size: 11pt;
            }

            /* Header formatting */
            .header {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 18pt;
                margin: 0;
            }

            /* Dashboard cards - show as text */
            .dashboard-grid {
                display: block !important;
                margin-bottom: 20px;
            }

            .dashboard-card {
                display: inline-block;
                width: auto;
                margin-right: 20px;
                padding: 5px 10px;
                border: 1px solid #333;
                page-break-inside: avoid;
            }

            /* Sample list formatting */
            .sample-list {
                padding: 0;
                border: none;
            }

            .sample-item {
                border: 1px solid #333;
                margin-bottom: 10px;
                padding: 10px;
                page-break-inside: avoid;
                display: block !important;
            }

            /* Sample details */
            .sample-item strong {
                font-size: 12pt;
            }

            .status {
                border: 1px solid #333 !important;
                background: white !important;
                color: #000 !important;
                padding: 2px 5px;
            }

            /* Compact layout for sample details */
            .sample-item br {
                display: none;
            }

            .sample-item span {
                display: inline-block;
                margin-right: 15px;
            }

            /* Page breaks */
            h2, h3 {
                page-break-after: avoid;
            }

            /* Print timestamp */
            .header::after {
                content: "Printed: " attr(data-print-date);
                display: block;
                font-size: 9pt;
                color: #666;
                margin-top: 5px;
            }

            /* Ensure links show full URL */
            a[href]::after {
                content: " (" attr(href) ")";
            }
        }

        /* Print button - only show when not printing */
        @media screen {
            .print-btn {
                background: #17a2b8;
                margin-left: 5px;
            }

            .print-btn:hover {
                background: #138496;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="passwordOverlay">
        <div id="passwordBox">
            <h2>🔒 BWGS Tracker Access</h2>
            <p>Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter') checkPassword()">
            <br>
            <button onclick="checkPassword()">Unlock</button>
            <p id="passwordError" style="color: red; display: none; margin-top: 10px;">Incorrect password</p>
        </div>
    </div>

    <!-- Main Application Content (hidden until password verified) -->
    <div id="appContent">
    <div class="header">
        <h1>🧪 Complete Lab Workflow Tracker</h1>
        <p>BAP → TSB → Extraction → Clean Extraction → Qubit → Indexing → Final Qubit</p>
        <div style="margin-top: 15px;">
            <button onclick="exportData()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">📥 Export JSON</button>
            <button onclick="exportCSV()" style="background: #20c997; font-size: 12px; padding: 6px 12px;">📊 Export CSV</button>
            <button onclick="window.print()" class="print-btn" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">🖨️ Print</button>
            <button onclick="importData()" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">📤 Import Data</button>
            <button onclick="showPlateMap()" style="background: #9c27b0; font-size: 12px; padding: 6px 12px;">🧫 Plate Map</button>
            <button onclick="showTimeline()" style="background: #ff6b6b; font-size: 12px; padding: 6px 12px;">📅 Timeline</button>
            <button onclick="showAnalytics()" style="background: #4ecdc4; font-size: 12px; padding: 6px 12px;">📈 Analytics</button>
            <button onclick="clearAllData()" style="background: #dc3545; font-size: 12px; padding: 6px 12px;">🗑️ Clear All Data</button>
            <button onclick="showKeyboardShortcuts()" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">⌨️ Shortcuts</button>
            <button onclick="toggleDarkMode()" id="darkModeToggle" style="background: #495057; font-size: 12px; padding: 6px 12px;">🌙 Dark Mode</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
        </div>
    </div>

    <!-- Quick Stats Panel -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
        <h3 style="margin-top: 0; color: white;">⚡ Quick Stats</h3>
        <div id="quickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </div>

    <!-- Status Dashboard -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">📊 Status Dashboard</h3>
        <div id="statusDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
            <!-- Dashboard will be populated by JavaScript -->
        </div>
    </div>

    <div class="add-section">
        <h3>Add New Samples</h3>
        
        <!-- Single Sample Input -->
        <div id="singleInput">
            <h4>Single Sample:</h4>
            <input type="text" id="sampleId" placeholder="Sample ID">
            <input type="text" id="initials" placeholder="Initials" maxlength="3">
            <button onclick="addSample()">Add Sample</button>
        </div>
        
        <!-- Toggle Button -->
        <div style="margin: 20px 0; text-align: center;">
            <button id="toggleBulk" onclick="toggleBulkInput()">Switch to Bulk Input</button>
        </div>
        
        <!-- Bulk Sample Input -->
        <div id="bulkInput" style="display: none;">
            <h4>Bulk Sample Input:</h4>
            <p><small>Paste sample IDs (one per line). Your initials will be applied to all samples.</small></p>
            <input type="text" id="bulkInitials" placeholder="Your initials (for all samples)" maxlength="3">
            <textarea id="bulkSamples" rows="6" placeholder="Paste sample IDs here, one per line:&#10;25KS01-001&#10;25KS01-002&#10;25KS01-003" style="width: 100%; margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button onclick="addBulkSamples()">Add All Samples</button>
        </div>
    </div>

    <div class="sample-list">
        <h3>Samples</h3>

        <!-- Bulk Operations Bar -->
        <div id="bulkOpsBar" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                    <strong><span id="selectedCount">0</span> samples selected</strong>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="bulkDelete()" style="background: #dc3545; color: white;">🗑️ Delete Selected</button>
                    <button onclick="showBulkStatusChange()" style="background: #ffc107; color: #333;">📝 Change Status</button>
                    <button onclick="clearSelection()" style="background: #6c757d; color: white;">✖ Clear Selection</button>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="searchInput" placeholder="🔍 Search by Sample ID..."
                       onkeyup="filterSamples()"
                       style="flex: 1; min-width: 250px; max-width: 400px; padding: 10px; font-size: 14px;">

                <select id="sortSelect" onchange="sortSamples()" style="padding: 10px; font-size: 14px;">
                    <option value="dateDesc">Sort: Newest First</option>
                    <option value="dateAsc">Sort: Oldest First</option>
                    <option value="idAsc">Sort: ID (A-Z)</option>
                    <option value="idDesc">Sort: ID (Z-A)</option>
                    <option value="status">Sort: By Status</option>
                </select>

                <label style="padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <strong>Select All</strong>
                </label>
            </div>

            <div style="margin-top: 10px;">
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="all" checked onchange="filterSamples()"> All
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Received" onchange="filterSamples()"> Received
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="BAP Complete" onchange="filterSamples()"> BAP
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="TSB Complete" onchange="filterSamples()"> TSB
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Extraction Complete" onchange="filterSamples()"> Extraction
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Complete" onchange="filterSamples()"> Complete
                </label>
            </div>
        </div>

        <div class="batch-controls" id="batchControls" style="display: none;">
            <h4>🧪 Batch Processing</h4>
            <p><span id="selectedCount">0</span> samples selected</p>
            <button class="btn-batch" id="batchBtn" disabled onclick="startBatchProcess()">Start Batch</button>
            <button onclick="clearSelection()">Clear Selection</button>
        </div>
        
        <div id="sampleContainer"></div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBatchModal()">&times;</span>
            <h3 id="batchModalTitle">Batch Processing</h3>
            <p>Processing <strong id="batchSampleCount">0</strong> samples</p>
            <p id="batchNumbers"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="batchTechInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="batchLotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="batchTemperature">
                    <option value="37">37°C</option>
                    <option value="35">35°C</option>
                    <option value="42">42°C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="batchIncubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>
            
            <button onclick="completeBatchProcess()">Complete Batch</button>
            <button class="btn-cancel" onclick="closeBatchModal()">Cancel</button>
        </div>
    </div>

    <!-- Individual Modal -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Process Sample</h3>
            <p>Sample: <strong id="modalSampleId"></strong></p>
            <p id="modalNumber"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="techInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="lotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="temperature">
                    <option value="37">37°C</option>
                    <option value="35">35°C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="incubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>
            
            <div id="specificFields"></div>
            
            <button onclick="completeProcess()">Complete</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Edit Sample Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>Edit Sample</h3>
            <p>Original Sample ID: <strong id="editOriginalId"></strong></p>

            <div class="form-group">
                <label>Sample ID:</label>
                <input type="text" id="editSampleId">
            </div>

            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="editInitials" maxlength="3">
            </div>

            <div class="form-group">
                <label>Status:</label>
                <select id="editStatus">
                    <option value="Received">Received</option>
                    <option value="BAP Complete">BAP Complete</option>
                    <option value="TSB Complete">TSB Complete</option>
                    <option value="Extraction Complete">Extraction Complete</option>
                    <option value="Clean Extraction Complete">Clean Extraction Complete</option>
                    <option value="Clean Extraction Qubit Complete">Clean Extraction Qubit Complete</option>
                    <option value="Indexing Complete">Indexing Complete</option>
                    <option value="Qubit Complete">Qubit Complete</option>
                </select>
            </div>

            <button onclick="saveEditedSample()">Save Changes</button>
            <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>

    <!-- Plate Map Modal -->
    <div id="plateMapModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <span class="close-btn" onclick="closePlateMapModal()">&times;</span>
            <h3>🧫 96-Well Plate Map</h3>

            <div style="margin: 20px 0;">
                <label><strong>Select Plate:</strong></label>
                <select id="plateSelector" onchange="renderPlateMap()">
                    <option value="">-- Select a plate --</option>
                </select>
            </div>

            <div id="plateMapContainer" style="overflow-x: auto;">
                <!-- Plate map will be rendered here -->
            </div>

            <div id="plateMapLegend" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <strong>Legend:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e9ecef; border: 1px solid #999;"></span> Empty</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #d4edda; border: 1px solid #155724;"></span> BAP Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3cd; border: 1px solid #856404;"></span> TSB Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #f3e5f5; border: 1px solid #7b1fa2;"></span> Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f5e8; border: 1px solid #2e7d32;"></span> Clean Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f4fd; border: 1px solid #1565c0;"></span> CE Qubit</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e3f2fd; border: 1px solid #1976d2;"></span> Indexing</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3e0; border: 1px solid #f57c00;"></span> Complete</div>
                </div>
            </div>

            <button class="btn-cancel" onclick="closePlateMapModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-btn" onclick="closeQRCodeModal()">&times;</span>
            <h3>📱 Sample QR Code</h3>

            <div id="qrCodeContainer" style="margin: 20px 0;">
                <!-- QR Code will be generated here -->
            </div>

            <div id="qrSampleInfo" style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                <!-- Sample info will be shown here -->
            </div>

            <button onclick="printQRCode()" style="background: #28a745; color: white; margin-right: 10px;">🖨️ Print Label</button>
            <button class="btn-cancel" onclick="closeQRCodeModal()">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeAnalyticsModal()">&times;</span>
            <h3>📈 Data Analytics Dashboard</h3>

            <div id="analyticsContainer" style="overflow-y: auto; max-height: 70vh;">
                <!-- Analytics will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeAnalyticsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeTimelineModal()">&times;</span>
            <h3>📅 Sample Processing Timeline</h3>

            <div style="margin: 20px 0;">
                <label><strong>View:</strong></label>
                <select id="timelineView" onchange="renderTimeline()">
                    <option value="all">All Samples</option>
                    <option value="recent">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="stage">By Stage</option>
                </select>
            </div>

            <div id="timelineContainer" style="overflow-x: auto; overflow-y: auto; max-height: 60vh;">
                <!-- Timeline will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeTimelineModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeShortcutsModal()">&times;</span>
            <h3>⌨️ Keyboard Shortcuts</h3>

            <div style="margin-top: 20px;">
                <h4 style="color: #007bff; margin-bottom: 10px;">🔍 Navigation</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + F</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus search box</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>1</kbd> - <kbd>5</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Quick status filters (All, Received, BAP, TSB, Extraction)</td>
                    </tr>
                </table>

                <h4 style="color: #28a745; margin-bottom: 10px;">📊 Actions</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export JSON backup</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + Shift + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export CSV</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + I</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Import data</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + N</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus sample input (add new)</td>
                    </tr>
                </table>

                <h4 style="color: #6c757d; margin-bottom: 10px;">🚪 Modals</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Esc</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Close any open modal</td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <small style="color: #6c757d;">
                    <strong>Note:</strong> Number key shortcuts (1-5) only work when not typing in an input field.
                </small>
            </div>

            <button class="btn-cancel" onclick="closeShortcutsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        // Export data as JSON file
        function exportData() {
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                exportDate: new Date().toISOString()
            };

            var dataStr = JSON.stringify(data, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            var url = URL.createObjectURL(dataBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bwgs-tracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('JSON data exported successfully!');
        }

        // Export data as CSV file
        function exportCSV() {
            var csv = 'Sample ID,Status,Date Added,Initials,BAP Number,BAP Tech,BAP Date,TSB Number,TSB Tech,TSB Date,';
            csv += 'Extraction Number,Extraction Run,Extraction Tech,Extraction Date,';
            csv += 'Clean Extraction Number,CE Storage Plate,CE Well,CE Tech,CE Date,CE Qubit (ng/uL),';
            csv += 'Indexing Number,Index Storage Plate,Index Well,i5 Index,i7 Index,Index Tech,Index Date,';
            csv += 'Final Qubit (ng/uL),Final Qubit Date\n';

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var row = [
                    s.id,
                    s.status,
                    s.dateAdded,
                    s.initials,
                    s.bapNumber || '',
                    s.bapDetails ? s.bapDetails.technician : '',
                    s.bapDetails ? s.bapDetails.completedDate : '',
                    s.tsbNumber || '',
                    s.tsbDetails ? s.tsbDetails.technician : '',
                    s.tsbDetails ? s.tsbDetails.completedDate : '',
                    s.extractionNumber || '',
                    s.extractionDetails ? s.extractionDetails.extractionRun : '',
                    s.extractionDetails ? s.extractionDetails.technician : '',
                    s.extractionDetails ? s.extractionDetails.completedDate : '',
                    s.cleanExtractionNumber || '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.storagePlate : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.wellPosition : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.technician : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.completedDate : '',
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.concentration : '',
                    s.indexingNumber || '',
                    s.indexingDetails ? s.indexingDetails.storagePlate : '',
                    s.indexingDetails ? s.indexingDetails.wellPosition : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i5 : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i7 : '',
                    s.indexingDetails ? s.indexingDetails.technician : '',
                    s.indexingDetails ? s.indexingDetails.completedDate : '',
                    s.qubitDetails ? s.qubitDetails.concentration : '',
                    s.qubitDetails ? s.qubitDetails.dateQubited || s.qubitDetails.completedDate : ''
                ];

                // Escape commas and quotes in CSV
                row = row.map(function(cell) {
                    if (cell && cell.toString().indexOf(',') > -1) {
                        return '"' + cell.toString().replace(/"/g, '""') + '"';
                    }
                    return cell;
                });

                csv += row.join(',') + '\n';
            }

            var csvBlob = new Blob([csv], {type: 'text/csv'});
            var url = URL.createObjectURL(csvBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bwgs-tracker-export-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('CSV exported successfully! Open in Excel or Google Sheets.');
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Are you sure?')) {
                        samples = data.samples || [];
                        nextBapNumber = data.nextBapNumber || 1;
                        nextTsbNumber = data.nextTsbNumber || 1;
                        nextExtractionNumber = data.nextExtractionNumber || 1;
                        nextExtractionRun = data.nextExtractionRun || 1;
                        nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                        nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                        nextIndexingNumber = data.nextIndexingNumber || 1;
                        nextIndexingPlate = data.nextIndexingPlate || 1;
                        saveData();
                        renderSamples();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Clear all data
        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?\n\nConsider exporting your data first!')) {
                if (confirm('Really delete everything? This cannot be undone!')) {
                    localStorage.removeItem('bwgsTrackerData');
                    initializeDefaults();
                    renderSamples();
                    alert('All data has been cleared.');
                }
            }
        }

        // Load data from localStorage or initialize with defaults
        function loadData() {
            var savedData = localStorage.getItem('bwgsTrackerData');
            if (savedData) {
                try {
                    var data = JSON.parse(savedData);
                    samples = data.samples || [];
                    nextBapNumber = data.nextBapNumber || 1;
                    nextTsbNumber = data.nextTsbNumber || 1;
                    nextExtractionNumber = data.nextExtractionNumber || 1;
                    nextExtractionRun = data.nextExtractionRun || 1;
                    nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                    nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                    nextIndexingNumber = data.nextIndexingNumber || 1;
                    nextIndexingPlate = data.nextIndexingPlate || 1;
                    console.log('Data loaded from localStorage');
                } catch (e) {
                    console.error('Error loading data:', e);
                    initializeDefaults();
                }
            } else {
                initializeDefaults();
            }
        }

        function initializeDefaults() {
            samples = [];
            nextBapNumber = 1;
            nextTsbNumber = 1;
            nextExtractionNumber = 1;
            nextExtractionRun = 1;
            nextCleanExtractionNumber = 1;
            nextCleanExtractionPlate = 1;
            nextIndexingNumber = 1;
            nextIndexingPlate = 1;
        }

        // Save data to localStorage
        function saveData() {
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('bwgsTrackerData', JSON.stringify(data));
            console.log('Data saved to localStorage');
        }

        var samples = [];
        var nextBapNumber = 1;
        var nextTsbNumber = 1;
        var nextExtractionNumber = 1;
        var nextExtractionRun = 1;
        var nextCleanExtractionNumber = 1;
        var nextCleanExtractionPlate = 1;
        var nextIndexingNumber = 1;
        var nextIndexingPlate = 1;
        var currentProcessType = '';
        var selectedSamples = [];
        var currentBatchSamples = [];
        var currentBatchType = '';

        function generateWellPosition(index) {
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var row = rows[index % 8];
            var col = String(Math.floor(index / 8) + 1);
            if (col.length === 1) col = '0' + col;
            return row + col;
        }

        function createReferenceTable(sampleIds, sourceType, targetType, targetStartNumber) {
            var html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Sample ID</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Use ' + sourceType.toUpperCase() + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">New ' + targetType.toUpperCase() + '</th>';
            html += '</tr>';
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                var sourceNumber = 'N/A';
                var targetNumber = 'N/A';
                
                if (sourceType === 'bap' && sample && sample.bapNumber) {
                    sourceNumber = sample.bapNumber;
                } else if (sourceType === 'tsb' && sample && sample.tsbNumber) {
                    sourceNumber = sample.tsbNumber;
                } else if (sourceType === 'extraction' && sample && sample.extractionNumber) {
                    sourceNumber = sample.extractionNumber;
                } else if (sourceType === 'cleanExtraction' && sample && sample.cleanExtractionNumber) {
                    sourceNumber = sample.cleanExtractionNumber;
                } else if (sourceType === 'indexing' && sample && sample.indexingNumber) {
                    sourceNumber = sample.indexingNumber;
                }
                
                if (targetType === 'TSB') {
                    targetNumber = '25T' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Extraction') {
                    targetNumber = '25E' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Clean Extraction') {
                    targetNumber = '25CE' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Indexing') {
                    targetNumber = '25XT' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Qubit') {
                    targetNumber = 'Qubit Analysis';
                }
                
                html += '<tr>';
                html += '<td style="padding: 8px; border: 1px solid #ddd;"><strong>' + sampleId + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #1976d2;"><strong>' + sourceNumber + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #2e7d32;"><strong>' + targetNumber + '</strong></td>';
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            return html;
        }

        function addSample() {
            var sampleId = document.getElementById('sampleId').value.trim();
            var initials = document.getElementById('initials').value.trim().toUpperCase();
            
            if (!sampleId || !initials) {
                alert('Please fill in both fields');
                return;
            }
            
            // Check for duplicates
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    alert('Sample ' + sampleId + ' already exists!');
                    return;
                }
            }
            
            var newSample = {
                id: sampleId,
                initials: initials,
                status: 'Received',
                dateAdded: new Date().toLocaleDateString(),
                notes: '',
                bapNumber: null,
                bapDetails: null,
                tsbNumber: null,
                tsbDetails: null,
                extractionNumber: null,
                extractionDetails: null,
                cleanExtractionNumber: null,
                cleanExtractionDetails: null,
                indexingNumber: null,
                indexingDetails: null,
                qubitDetails: null
            };
            
            samples.push(newSample);
            saveData();
            renderSamples();

            document.getElementById('sampleId').value = '';
            document.getElementById('initials').value = '';
        }

        function toggleBulkInput() {
            var single = document.getElementById('singleInput');
            var bulk = document.getElementById('bulkInput');
            var btn = document.getElementById('toggleBulk');
            
            if (single.style.display === 'none') {
                single.style.display = 'block';
                bulk.style.display = 'none';
                btn.textContent = 'Switch to Bulk Input';
            } else {
                single.style.display = 'none';
                bulk.style.display = 'block';
                btn.textContent = 'Switch to Single Input';
            }
        }

        function addBulkSamples() {
            var text = document.getElementById('bulkSamples').value.trim();
            var initials = document.getElementById('bulkInitials').value.trim().toUpperCase();
            
            if (!text || !initials) {
                alert('Please enter initials and paste sample IDs');
                return;
            }
            
            var lines = text.split('\n');
            var sampleIds = [];
            
            // Clean up the input lines
            for (var i = 0; i < lines.length; i++) {
                var id = lines[i].trim();
                if (id.length > 0) {
                    sampleIds.push(id);
                }
            }
            
            if (sampleIds.length === 0) {
                alert('No valid sample IDs found');
                return;
            }
            
            var added = 0;
            var duplicates = [];
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                
                // Check for duplicates
                var isDuplicate = false;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        duplicates.push(sampleId);
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    var newSample = {
                        id: sampleId,
                        initials: initials,
                        status: 'Received',
                        dateAdded: new Date().toLocaleDateString(),
                        notes: '',
                        bapNumber: null,
                        bapDetails: null,
                        tsbNumber: null,
                        tsbDetails: null,
                        extractionNumber: null,
                        extractionDetails: null,
                        cleanExtractionNumber: null,
                        cleanExtractionDetails: null,
                        indexingNumber: null,
                        indexingDetails: null,
                        qubitDetails: null
                    };
                    
                    samples.push(newSample);
                    added++;
                }
            }

            saveData();
            renderSamples();

            // Clear the form
            document.getElementById('bulkSamples').value = '';
            document.getElementById('bulkInitials').value = '';

            // Show results
            var message = 'Successfully added ' + added + ' new samples!';
            if (duplicates.length > 0) {
                message += '\n\nSkipped ' + duplicates.length + ' duplicates: ' + duplicates.join(', ');
            }
            alert(message);
        }

        function startProcess(sampleId, type) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;
            
            currentProcessType = type;
            var number = '';
            
            if (type === 'BAP') {
                number = '25B' + String(nextBapNumber).padStart(3, '0');
            } else if (type === 'TSB') {
                number = '25T' + String(nextTsbNumber).padStart(3, '0');
            } else if (type === 'Extraction') {
                number = '25E' + String(nextExtractionNumber).padStart(3, '0');
            } else if (type === 'Clean Extraction') {
                number = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
            } else if (type === 'Indexing') {
                number = '25XT' + String(nextIndexingNumber).padStart(3, '0');
            } else if (type === 'Qubit') {
                number = 'Qubit Analysis';
            }
            
            document.getElementById('modalTitle').textContent = 'Start ' + type;
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';
            
            showSpecificFields(type);
            document.getElementById('processModal').style.display = 'block';
        }

        function showSpecificFields(type) {
            var container = document.getElementById('specificFields');
            var html = '';
            
            if (type === 'TSB') {
                // Add BAP reference for TSB
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.bapDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 BAP Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use BAP:</strong> ' + sample.bapNumber + '</div>';
                    html += '<div><strong>BAP Tech:</strong> ' + sample.bapDetails.technician + '</div>';
                    html += '<div><strong>BAP Date:</strong> ' + sample.bapDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Extraction') {
                // Add TSB reference for Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.tsbDetails) {
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #856404;">🧫 TSB Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use TSB:</strong> ' + sample.tsbNumber + '</div>';
                    html += '<div><strong>TSB Tech:</strong> ' + sample.tsbDetails.technician + '</div>';
                    html += '<div><strong>TSB Date:</strong> ' + sample.tsbDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add extraction-specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #7b1fa2;">Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Extraction Run:</label>';
                html += '<input type="text" id="extractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW1 Lot:</label>';
                html += '<input type="text" id="aw1Lot" placeholder="AW1LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW2 Lot:</label>';
                html += '<input type="text" id="aw2Lot" placeholder="AW2LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Ethanol Lot:</label>';
                html += '<input type="text" id="ethanolLot" placeholder="ETH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AL Lot:</label>';
                html += '<input type="text" id="bufferALLot" placeholder="AL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer ATL Lot:</label>';
                html += '<input type="text" id="bufferATLLot" placeholder="ATL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AE Lot:</label>';
                html += '<input type="text" id="bufferAELot" placeholder="AE123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Proteinase K Lot:</label>';
                html += '<input type="text" id="proteinaseKLot" placeholder="PK123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">DNeasy Column Lot:</label>';
                html += '<input type="text" id="dneasyLot" placeholder="COL123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Clean Extraction') {
                // Add Extraction reference for Clean Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.extractionDetails) {
                    html += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #9c27b0;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">🧬 Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Extraction:</strong> ' + sample.extractionNumber + '</div>';
                    html += '<div><strong>Extraction Tech:</strong> ' + sample.extractionDetails.technician + '</div>';
                    html += '<div><strong>Extraction Date:</strong> ' + sample.extractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add clean extraction specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #2e7d32;">Clean Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="storagePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                html += '<input type="text" id="wellPosition" value="A01" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-assigned, editable</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Bead Lot:</label>';
                html += '<input type="text" id="beadLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O ETOH Dilution:</label>';
                html += '<input type="text" id="nfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH Dilution:</label>';
                html += '<input type="text" id="etohDilutionLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O Elution:</label>';
                html += '<input type="text" id="nfH2oElutionLot" placeholder="ELUT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Qubit Reagent:</label>';
                html += '<input type="text" id="qubitReagentLot" placeholder="QUBIT123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Cleanup Volume:</label>';
                html += '<input type="text" id="cleanupVolume" placeholder="1.2x" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution In:</label>';
                html += '<input type="text" id="elutionVolumeIn" placeholder="50uL" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution Out:</label>';
                html += '<input type="text" id="elutionVolumeOut" placeholder="45uL" style="width: 80px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Indexing') {
                // Add Clean Extraction reference for Indexing
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.cleanExtractionDetails) {
                    html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">🧽 Clean Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
                    html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
                    html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add indexing specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #1976d2;">Indexing (XT) Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="indexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                html += '<input type="text" id="indexingWellPosition" value="A01" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-assigned, editable</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Index Assignment:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Index:</label>';
                html += '<input type="text" id="i5Index" placeholder="i5-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Index:</label>';
                html += '<input type="text" id="i7Index" placeholder="i7-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Thaws:</label>';
                html += '<input type="number" id="i5Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Thaws:</label>';
                html += '<input type="number" id="i7Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">TD Buffer:</label>';
                html += '<input type="text" id="tdBufferLot" placeholder="TD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">ATM Buffer:</label>';
                html += '<input type="text" id="atmBufferLot" placeholder="ATM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NT Buffer:</label>';
                html += '<input type="text" id="ntBufferLot" placeholder="NT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NPM:</label>';
                html += '<input type="text" id="npmLot" placeholder="NPM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Resuspension Buffer:</label>';
                html += '<input type="text" id="resuspensionBufferLot" placeholder="RES123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Indexes Kit:</label>';
                html += '<input type="text" id="indexesKitLot" placeholder="IDX123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Beads:</label>';
                html += '<input type="text" id="indexingBeadsLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH:</label>';
                html += '<input type="text" id="indexingEtohLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O:</label>';
                html += '<input type="text" id="indexingNfH2oLot" placeholder="H2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Double-Sided Clean Up:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 1 Concentrations:</label>';
                html += '<input type="text" id="cleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 2 Concentrations:</label>';
                html += '<input type="text" id="cleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;">';
                html += '</div>';
                
                html += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    // Add Clean Extraction reference for Clean Extraction Qubit
    var sampleId = document.getElementById('modalSampleId').textContent;
    var sample = null;
    for (var i = 0; i < samples.length; i++) {
        if (samples[i].id === sampleId) {
            sample = samples[i];
            break;
        }
    }
    
    if (sample && sample.cleanExtractionDetails) {
        html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
        html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">🧽 Clean Extraction Reference</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
        html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
        html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
        html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
        html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    // Add Clean Extraction Qubit-specific fields
    html += '<h4 style="margin: 20px 0 10px 0; color: #1565c0;">📊 Clean Extraction Qubit Analysis</h4>';
    
    html += '<div class="form-group">';
    html += '<label>Concentration (ng/uL):</label>';
    html += '<input type="number" id="qubitConcentration" step="0.1">';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Qubit Reagent Lot:</label>';
    html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Date Qubited:</label>';
    html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    html += '</div>';
            } else if (type === 'Final Qubit') {
                            // Add Indexing reference for Qubit
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.indexingDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">🔬 Indexing Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Indexing:</strong> ' + sample.indexingNumber + '</div>';
                    html += '<div><strong>Indexing Tech:</strong> ' + sample.indexingDetails.technician + '</div>';
                    html += '<div><strong>Indexing Date:</strong> ' + sample.indexingDetails.completedDate + '</div>';
                    if (sample.indexingDetails.i5 && sample.indexingDetails.i7) {
                        html += '<div><strong>i5 Index:</strong> ' + sample.indexingDetails.i5 + '</div>';
                        html += '<div><strong>i7 Index:</strong> ' + sample.indexingDetails.i7 + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '<h4 style="margin: 20px 0 10px 0; color: #f57c00;">📊 Qubit Analysis</h4>';

html += '<div class="form-group">';
html += '<label>Concentration (ng/uL):</label>';
html += '<input type="number" id="qubitConcentration" step="0.1">';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Qubit Reagent Lot:</label>';
html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Date Qubited:</label>';
html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function completeProcess() {
            var tech = document.getElementById('techInitials').value.trim();
            var lot = document.getElementById('lotNumber').value.trim();
            var temp = document.getElementById('temperature').value;
            var inc = document.getElementById('incubator').value;
            
            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var sampleId = document.getElementById('modalSampleId').textContent;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            
            if (sample) {
                var today = new Date().toLocaleDateString();
                
                if (currentProcessType === 'BAP') {
                    sample.bapNumber = '25B' + String(nextBapNumber).padStart(3, '0');
                    sample.status = 'BAP Complete';
                    sample.bapDetails = { technician: tech, lot: lot, completedDate: today };
                    nextBapNumber++;
                } else if (currentProcessType === 'TSB') {
                    sample.tsbNumber = '25T' + String(nextTsbNumber).padStart(3, '0');
                    sample.status = 'TSB Complete';
                    sample.tsbDetails = { technician: tech, lot: lot, completedDate: today };
                    nextTsbNumber++;
                } else if (currentProcessType === 'Extraction') {
                    sample.extractionNumber = '25E' + String(nextExtractionNumber).padStart(3, '0');
                    sample.status = 'Extraction Complete';
                    sample.extractionDetails = { 
                        technician: tech, 
                        lot: lot, 
                        completedDate: today,
                        extractionRun: document.getElementById('extractionRun').value,
                        reagentLots: {
                            aw1: document.getElementById('aw1Lot').value,
                            aw2: document.getElementById('aw2Lot').value,
                            ethanol: document.getElementById('ethanolLot').value,
                            bufferAL: document.getElementById('bufferALLot').value,
                            bufferATL: document.getElementById('bufferATLLot').value,
                            bufferAE: document.getElementById('bufferAELot').value,
                            proteinaseK: document.getElementById('proteinaseKLot').value,
                            dneasy: document.getElementById('dneasyLot').value
                        }
                    };
                    nextExtractionNumber++;
                    if (nextExtractionNumber % 24 === 1) {
                        nextExtractionRun++;
                    }
                } else if (currentProcessType === 'Clean Extraction') {
                    sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
                    sample.status = 'Clean Extraction Complete';
                    sample.cleanExtractionDetails = { 
                        technician: tech, 
                        lot: lot, 
                        completedDate: today,
                        storagePlate: document.getElementById('storagePlate').value,
                        wellPosition: document.getElementById('wellPosition').value,
                        reagentLots: {
                            bead: document.getElementById('beadLot').value,
                            nfH2oEtoh: document.getElementById('nfH2oEtohLot').value,
                            etohDilution: document.getElementById('etohDilutionLot').value,
                            nfH2oElution: document.getElementById('nfH2oElutionLot').value,
                            qubitReagent: document.getElementById('qubitReagentLot').value
                        },
                        volumes: {
                            cleanup: document.getElementById('cleanupVolume').value,
                            elutionIn: document.getElementById('elutionVolumeIn').value,
                            elutionOut: document.getElementById('elutionVolumeOut').value
                        }
                    };
                    nextCleanExtractionNumber++;
                    nextCleanExtractionPlate++;
                } else if (currentProcessType === 'Indexing') {
                    sample.indexingNumber = '25XT' + String(nextIndexingNumber).padStart(3, '0');
                    sample.status = 'Indexing Complete';
                    sample.indexingDetails = { 
                        technician: tech, 
                        lot: lot, 
                        completedDate: today,
                        storagePlate: document.getElementById('indexingStoragePlate').value,
                        wellPosition: document.getElementById('indexingWellPosition').value,
                        indexes: {
                            i5: document.getElementById('i5Index').value,
                            i7: document.getElementById('i7Index').value,
                            i5Thaws: document.getElementById('i5Thaws').value,
                            i7Thaws: document.getElementById('i7Thaws').value
                        },
                        reagentLots: {
                            tdBuffer: document.getElementById('tdBufferLot').value,
                            atmBuffer: document.getElementById('atmBufferLot').value,
                            ntBuffer: document.getElementById('ntBufferLot').value,
                            npm: document.getElementById('npmLot').value,
                            resuspensionBuffer: document.getElementById('resuspensionBufferLot').value,
                            indexesKit: document.getElementById('indexesKitLot').value,
                            beads: document.getElementById('indexingBeadsLot').value,
                            etoh: document.getElementById('indexingEtohLot').value,
                            nfH2o: document.getElementById('indexingNfH2oLot').value
                        },
                        cleanupConcentrations: {
                            step1: document.getElementById('cleanup1Concentrations').value,
                            step2: document.getElementById('cleanup2Concentrations').value
                        }
                    };
                    nextIndexingNumber++;
                    nextIndexingPlate++;
                } else if (currentProcessType === 'Clean Extraction Qubit') {
                    sample.status = 'Clean Extraction Qubit Complete';
                    sample.cleanExtractionQubitDetails = { 
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today
                    };
                } else if (currentProcessType === 'Final Qubit') {
                    sample.status = 'Qubit Complete';
                    sample.qubitDetails = { 
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today
                    };
                }

                saveData();
                renderSamples();
                closeModal();
                alert(currentProcessType + ' completed!');
            }
        }

        function startBatchProcess() {
            console.log('Batch process started');
            
            var receivedSamples = [];
            var bapSamples = [];
            var tsbSamples = [];
            var extractionSamples = [];
            var cleanExtractionSamples = [];
            var indexingSamples = [];
            var cleanExtractionQubitSamples = [];
            
            for (var i = 0; i < selectedSamples.length; i++) {
                var id = selectedSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === id) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
    if (sample.status === 'Received') receivedSamples.push(id);
    else if (sample.status === 'BAP Complete') bapSamples.push(id);
    else if (sample.status === 'TSB Complete') tsbSamples.push(id);
    else if (sample.status === 'Extraction Complete') extractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Complete') cleanExtractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Qubit Complete') cleanExtractionQubitSamples.push(id);
    else if (sample.status === 'Indexing Complete') indexingSamples.push(id);
}
            }
            
            console.log('Batch counts: received=' + receivedSamples.length + ' indexing=' + indexingSamples.length);
            
            if (receivedSamples.length >= 2) {
    openBatchModal(receivedSamples, 'BAP');
} else if (bapSamples.length >= 2) {
    openBatchModal(bapSamples, 'TSB');
} else if (tsbSamples.length >= 2) {
    openBatchModal(tsbSamples, 'Extraction');
} else if (extractionSamples.length >= 2) {
    openBatchModal(extractionSamples, 'Clean Extraction');
} else if (cleanExtractionSamples.length >= 2) {
    openBatchModal(cleanExtractionSamples, 'Clean Extraction Qubit');
} else if (cleanExtractionQubitSamples.length >= 2) {
    openBatchModal(cleanExtractionQubitSamples, 'Indexing');
} else if (indexingSamples.length >= 2) {
    openBatchModal(indexingSamples, 'Final Qubit');
} else {
    alert('Please select samples of the same type');
}
        }

        function openBatchModal(sampleIds, type) {
            console.log('Opening batch modal for type: ' + type);
            currentBatchSamples = sampleIds;
            currentBatchType = type;
            
            document.getElementById('batchModalTitle').textContent = 'Batch ' + type;
            document.getElementById('batchSampleCount').textContent = sampleIds.length;
            
            var numbersHtml = '<strong>Processing ' + sampleIds.length + ' samples</strong>';
            
            // Add reference tables for each workflow step
            if (type === 'TSB') {
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 BAP → TSB Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'bap', 'TSB', nextTsbNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the BAP plates listed above for each corresponding TSB</p>';
                numbersHtml += '</div>';
            } else if (type === 'Extraction') {
                numbersHtml += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #856404;">🧫 TSB → Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'tsb', 'Extraction', nextExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the TSB plates listed above for each corresponding Extraction</p>';
                numbersHtml += '</div>';
                
                // Add extraction reagent fields
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">🧬 Extraction Reagent Lots</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Extraction Run:</label>';
                numbersHtml += '<input type="text" id="batchExtractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW1 Lot:</label><input type="text" id="batchAw1Lot" placeholder="AW1LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW2 Lot:</label><input type="text" id="batchAw2Lot" placeholder="AW2LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Ethanol Lot:</label><input type="text" id="batchEthanolLot" placeholder="ETH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AL Lot:</label><input type="text" id="batchBufferALLot" placeholder="AL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer ATL Lot:</label><input type="text" id="batchBufferATLLot" placeholder="ATL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AE Lot:</label><input type="text" id="batchBufferAELot" placeholder="AE123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Proteinase K Lot:</label><input type="text" id="batchProteinaseKLot" placeholder="PK123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">DNeasy Column Lot:</label><input type="text" id="batchDneasyLot" placeholder="COL123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Clean Extraction') {
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">🧬 Extraction → Clean Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'extraction', 'Clean Extraction', nextCleanExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Extraction plates listed above for each corresponding Clean Extraction</p>';
                numbersHtml += '</div>';
                
                // Add clean extraction reagent fields
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">🧽 Clean Extraction Reagents & Volumes</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchStoragePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Bead Lot:</label><input type="text" id="batchBeadLot" placeholder="BEAD123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O ETOH:</label><input type="text" id="batchNfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">EtOH Dilution:</label><input type="text" id="batchEtohDilutionLot" placeholder="ETOH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O Elution:</label><input type="text" id="batchNfH2oElutionLot" placeholder="ELUT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Qubit Reagent:</label><input type="text" id="batchQubitReagentLot" placeholder="QUBIT123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Cleanup Volume:</label><input type="text" id="batchCleanupVolume" placeholder="1.2x" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution In:</label><input type="text" id="batchElutionVolumeIn" placeholder="50uL" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution Out:</label><input type="text" id="batchElutionVolumeOut" placeholder="45uL" style="width: 80px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Indexing') {
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">🧽 Clean Extraction → Indexing Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Indexing', nextIndexingNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Indexing</p>';
                numbersHtml += '</div>';
                
                // Add indexing reagent fields with well positions and indexes
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">🔬 Indexing (XT) Details</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchIndexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                
                // Well positions and indexes for each sample
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Well Positions & Indexes (unique per sample):</h5>';
                numbersHtml += '<div id="batchIndexingWellPositions" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                
                for (var i = 0; i < sampleIds.length; i++) {
                    var sampleId = sampleIds[i];
                    var autoWell = generateWellPosition(i);
                    numbersHtml += '<div style="display: grid; grid-template-columns: 100px 60px 80px 80px 40px 40px; gap: 5px; align-items: center; margin-bottom: 8px; padding: 5px; background: white; border-radius: 4px;">';
                    numbersHtml += '<span style="font-weight: bold; font-size: 11px;">' + sampleId + '</span>';
                    numbersHtml += '<input type="text" id="batchIndexingWell_' + i + '" value="' + autoWell + '" style="width: 50px; font-size: 11px;" placeholder="A01">';
                    numbersHtml += '<input type="text" id="batchI5Index_' + i + '" placeholder="i5-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="text" id="batchI7Index_' + i + '" placeholder="i7-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI5Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI7Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '</div>';
                }
                
                numbersHtml += '</div>';
                numbersHtml += '<small style="color: #666; font-size: 11px;">Each sample needs unique i5/i7 combination</small>';
                
                // Shared reagent lots
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Shared Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">TD Buffer:</label><input type="text" id="batchTdBufferLot" placeholder="TD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">ATM Buffer:</label><input type="text" id="batchAtmBufferLot" placeholder="ATM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NT Buffer:</label><input type="text" id="batchNtBufferLot" placeholder="NT123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NPM:</label><input type="text" id="batchNpmLot" placeholder="NPM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Resuspension Buffer:</label><input type="text" id="batchResuspensionBufferLot" placeholder="RES123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Indexes Kit:</label><input type="text" id="batchIndexesKitLot" placeholder="IDX123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Beads:</label><input type="text" id="batchIndexingBeadsLot" placeholder="BEAD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">EtOH:</label><input type="text" id="batchIndexingEtohLot" placeholder="ETOH123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NF H2O:</label><input type="text" id="batchIndexingNfH2oLot" placeholder="H2O123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '</div>';
                
                // Cleanup concentrations
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Cleanup Concentrations:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 1:</label><input type="text" id="batchCleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 2:</label><input type="text" id="batchCleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">🧽 Clean Extraction → Clean Extraction Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Clean Extraction Qubit specific fields
    numbersHtml += '<div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #1565c0;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1565c0;">📊 Batch Clean Extraction Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchCleanExtractionQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchCleanExtractionQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
            } else if (type === 'Final Qubit') {
    numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">🔬 Indexing → Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'indexing', 'Final Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Indexing plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Qubit specific fields
    numbersHtml += '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ff9800;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #f57c00;">📊 Batch Final Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
}
            
            document.getElementById('batchNumbers').innerHTML = numbersHtml;
            document.getElementById('batchModal').style.display = 'block';
        }

        function completeBatchProcess() {
            var tech = document.getElementById('batchTechInitials').value.trim();
            var lot = document.getElementById('batchLotNumber').value.trim();
            
            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var today = new Date().toLocaleDateString();
            
            for (var i = 0; i < currentBatchSamples.length; i++) {
                var sampleId = currentBatchSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
                    if (currentBatchType === 'BAP') {
                        sample.bapNumber = '25B' + String(nextBapNumber + i).padStart(3, '0');
                        sample.status = 'BAP Complete';
                        sample.bapDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'TSB') {
                        sample.tsbNumber = '25T' + String(nextTsbNumber + i).padStart(3, '0');
                        sample.status = 'TSB Complete';
                        sample.tsbDetails = { technician: tech, lot: lot, completedDate: today };
                    } else if (currentBatchType === 'Extraction') {
                        sample.extractionNumber = '25E' + String(nextExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Extraction Complete';
                        sample.extractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            extractionRun: document.getElementById('batchExtractionRun') ? document.getElementById('batchExtractionRun').value : '25-' + nextExtractionRun,
                            reagentLots: {
                                aw1: document.getElementById('batchAw1Lot') ? document.getElementById('batchAw1Lot').value : '',
                                aw2: document.getElementById('batchAw2Lot') ? document.getElementById('batchAw2Lot').value : '',
                                ethanol: document.getElementById('batchEthanolLot') ? document.getElementById('batchEthanolLot').value : '',
                                bufferAL: document.getElementById('batchBufferALLot') ? document.getElementById('batchBufferALLot').value : '',
                                bufferATL: document.getElementById('batchBufferATLLot') ? document.getElementById('batchBufferATLLot').value : '',
                                bufferAE: document.getElementById('batchBufferAELot') ? document.getElementById('batchBufferAELot').value : '',
                                proteinaseK: document.getElementById('batchProteinaseKLot') ? document.getElementById('batchProteinaseKLot').value : '',
                                dneasy: document.getElementById('batchDneasyLot') ? document.getElementById('batchDneasyLot').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Clean Extraction') {
                        sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Clean Extraction Complete';
                        sample.cleanExtractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchStoragePlate') ? document.getElementById('batchStoragePlate').value : '25CEP' + String(nextCleanExtractionPlate).padStart(2, '0'),
                            wellPosition: generateWellPosition(i),
                            reagentLots: {
                                bead: document.getElementById('batchBeadLot') ? document.getElementById('batchBeadLot').value : '',
                                nfH2oEtoh: document.getElementById('batchNfH2oEtohLot') ? document.getElementById('batchNfH2oEtohLot').value : '',
                                etohDilution: document.getElementById('batchEtohDilutionLot') ? document.getElementById('batchEtohDilutionLot').value : '',
                                nfH2oElution: document.getElementById('batchNfH2oElutionLot') ? document.getElementById('batchNfH2oElutionLot').value : '',
                                qubitReagent: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : ''
                            },
                            volumes: {
                                cleanup: document.getElementById('batchCleanupVolume') ? document.getElementById('batchCleanupVolume').value : '',
                                elutionIn: document.getElementById('batchElutionVolumeIn') ? document.getElementById('batchElutionVolumeIn').value : '',
                                elutionOut: document.getElementById('batchElutionVolumeOut') ? document.getElementById('batchElutionVolumeOut').value : ''
                            }
                        };
                        } else if (currentBatchType === 'Clean Extraction Qubit') {
    sample.status = 'Clean Extraction Qubit Complete';
    sample.cleanExtractionQubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchCleanExtractionQubitReagentLot') ? document.getElementById('batchCleanExtractionQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchCleanExtractionQubitDate') ? document.getElementById('batchCleanExtractionQubitDate').value : today
    };
                    } else if (currentBatchType === 'Indexing') {
                        sample.indexingNumber = '25XT' + String(nextIndexingNumber + i).padStart(3, '0');
                        sample.status = 'Indexing Complete';
                        
                        // Get custom well position and indexes from inputs
                        var wellPosition = generateWellPosition(i);
                        var wellInput = document.getElementById('batchIndexingWell_' + i);
                        if (wellInput && wellInput.value.trim()) {
                            wellPosition = wellInput.value.trim().toUpperCase();
                        }
                        
                        var i5Index = document.getElementById('batchI5Index_' + i) ? document.getElementById('batchI5Index_' + i).value : '';
                        var i7Index = document.getElementById('batchI7Index_' + i) ? document.getElementById('batchI7Index_' + i).value : '';
                        var i5Thaws = document.getElementById('batchI5Thaws_' + i) ? document.getElementById('batchI5Thaws_' + i).value : '1';
                        var i7Thaws = document.getElementById('batchI7Thaws_' + i) ? document.getElementById('batchI7Thaws_' + i).value : '1';
                        
                        sample.indexingDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchIndexingStoragePlate') ? document.getElementById('batchIndexingStoragePlate').value : '25XLP' + String(nextIndexingPlate).padStart(2, '0'),
                            wellPosition: wellPosition,
                            indexes: {
                                i5: i5Index,
                                i7: i7Index,
                                i5Thaws: i5Thaws,
                                i7Thaws: i7Thaws
                            },
                            reagentLots: {
                                tdBuffer: document.getElementById('batchTdBufferLot') ? document.getElementById('batchTdBufferLot').value : '',
                                atmBuffer: document.getElementById('batchAtmBufferLot') ? document.getElementById('batchAtmBufferLot').value : '',
                                ntBuffer: document.getElementById('batchNtBufferLot') ? document.getElementById('batchNtBufferLot').value : '',
                                npm: document.getElementById('batchNpmLot') ? document.getElementById('batchNpmLot').value : '',
                                resuspensionBuffer: document.getElementById('batchResuspensionBufferLot') ? document.getElementById('batchResuspensionBufferLot').value : '',
                                indexesKit: document.getElementById('batchIndexesKitLot') ? document.getElementById('batchIndexesKitLot').value : '',
                                beads: document.getElementById('batchIndexingBeadsLot') ? document.getElementById('batchIndexingBeadsLot').value : '',
                                etoh: document.getElementById('batchIndexingEtohLot') ? document.getElementById('batchIndexingEtohLot').value : '',
                                nfH2o: document.getElementById('batchIndexingNfH2oLot') ? document.getElementById('batchIndexingNfH2oLot').value : ''
                            },
                            cleanupConcentrations: {
                                step1: document.getElementById('batchCleanup1Concentrations') ? document.getElementById('batchCleanup1Concentrations').value : '',
                                step2: document.getElementById('batchCleanup2Concentrations') ? document.getElementById('batchCleanup2Concentrations').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Final Qubit') {
    sample.status = 'Qubit Complete';
    sample.qubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchQubitDate') ? document.getElementById('batchQubitDate').value : today
    };
}
                }
            }
            
            if (currentBatchType === 'BAP') nextBapNumber += currentBatchSamples.length;
            else if (currentBatchType === 'TSB') nextTsbNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Extraction') nextExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Clean Extraction') nextCleanExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Indexing') nextIndexingNumber += currentBatchSamples.length;
            
            clearSelection();
            saveData();
            renderSamples();
            closeBatchModal();
            alert('Batch ' + currentBatchType + ' completed!');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            currentBatchSamples = [];
            currentBatchType = '';
        }

        function closeModal() {
            document.getElementById('processModal').style.display = 'none';
        }

        function updateSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            selectedSamples = [];
            for (var i = 0; i < checkboxes.length; i++) {
                selectedSamples.push(checkboxes[i].value);
            }
            
            console.log('Selected samples: ' + selectedSamples.join(','));
            
            var count = document.getElementById('selectedCount');
            var batchBtn = document.getElementById('batchBtn');
            var batchControls = document.getElementById('batchControls');
            
            count.textContent = selectedSamples.length;
            
            if (selectedSamples.length >= 2) {
                batchControls.style.display = 'block';
                batchBtn.disabled = false;
                batchBtn.textContent = 'Start Batch Processing';
            } else {
                batchControls.style.display = 'none';
                batchBtn.disabled = true;
            }
        }

        function clearSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            selectedSamples = [];
            updateSelection();
        }

        function filterSamples() {
            var searchText = document.getElementById('searchInput').value.toLowerCase();
            var statusFilter = document.querySelector('input[name="statusFilter"]:checked').value;

            var sampleItems = document.querySelectorAll('.sample-item');
            for (var i = 0; i < sampleItems.length; i++) {
                var item = sampleItems[i];
                var sampleId = item.querySelector('strong').textContent.toLowerCase();
                var status = item.querySelector('.status').textContent;

                var matchesSearch = sampleId.includes(searchText);
                var matchesStatus = statusFilter === 'all' ||
                                  status === statusFilter ||
                                  (statusFilter === 'Complete' && status === 'Qubit Complete');

                if (matchesSearch && matchesStatus) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            }
        }

        var currentEditingSampleId = null;

        // QC Thresholds
        var QC_THRESHOLDS = {
            cleanExtractionQubit: {min: 5, max: 200, unit: 'ng/uL'},
            finalQubit: {min: 1, max: 50, unit: 'ng/uL'}
        };

        function checkQCThreshold(value, type) {
            var threshold = QC_THRESHOLDS[type];
            if (!threshold) return {pass: true, message: ''};

            var numValue = parseFloat(value);
            if (isNaN(numValue)) return {pass: true, message: ''};

            if (numValue < threshold.min) {
                return {
                    pass: false,
                    message: '⚠️ Below minimum (' + threshold.min + ' ' + threshold.unit + ')'
                };
            } else if (numValue > threshold.max) {
                return {
                    pass: false,
                    message: '⚠️ Above maximum (' + threshold.max + ' ' + threshold.unit + ')'
                };
            }
            return {pass: true, message: '✅ Within range'};
        }

        function editSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentEditingSampleId = sampleId;
            document.getElementById('editOriginalId').textContent = sampleId;
            document.getElementById('editSampleId').value = sample.id;
            document.getElementById('editInitials').value = sample.initials;
            document.getElementById('editStatus').value = sample.status;

            document.getElementById('editModal').style.display = 'block';
        }

        function saveEditedSample() {
            var newId = document.getElementById('editSampleId').value.trim();
            var newInitials = document.getElementById('editInitials').value.trim().toUpperCase();
            var newStatus = document.getElementById('editStatus').value;

            if (!newId || !newInitials) {
                alert('Sample ID and Initials are required');
                return;
            }

            // Check if new ID already exists (and it's not the current sample)
            if (newId !== currentEditingSampleId) {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === newId) {
                        alert('Sample ID ' + newId + ' already exists!');
                        return;
                    }
                }
            }

            // Find and update the sample
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === currentEditingSampleId) {
                    samples[i].id = newId;
                    samples[i].initials = newInitials;
                    samples[i].status = newStatus;
                    break;
                }
            }

            saveData();
            renderSamples();
            closeEditModal();
            alert('Sample updated successfully!');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingSampleId = null;
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').style.display = 'none';
        }

        function showPlateMap() {
            // Get all unique plates from samples
            var plates = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                // Check for plate assignments in various stages
                if (s.tsbDetails && s.tsbDetails.storagePlate) {
                    plates['TSB - ' + s.tsbDetails.storagePlate] = s.tsbDetails.storagePlate;
                }
                if (s.extractionDetails && s.extractionDetails.storagePlate) {
                    plates['Extraction - ' + s.extractionDetails.storagePlate] = s.extractionDetails.storagePlate;
                }
                if (s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate) {
                    plates['Clean Extraction - ' + s.cleanExtractionDetails.storagePlate] = s.cleanExtractionDetails.storagePlate;
                }
                if (s.indexingDetails && s.indexingDetails.storagePlate) {
                    plates['Indexing - ' + s.indexingDetails.storagePlate] = s.indexingDetails.storagePlate;
                }
            }

            // Populate plate selector
            var selector = document.getElementById('plateSelector');
            selector.innerHTML = '<option value="">-- Select a plate --</option>';
            for (var plateName in plates) {
                var option = document.createElement('option');
                option.value = plateName;
                option.textContent = plateName;
                selector.appendChild(option);
            }

            // Show modal
            document.getElementById('plateMapModal').style.display = 'block';

            // If there's only one plate, auto-select it
            if (Object.keys(plates).length === 1) {
                selector.value = Object.keys(plates)[0];
                renderPlateMap();
            }
        }

        function closePlateMapModal() {
            document.getElementById('plateMapModal').style.display = 'none';
        }

        function renderPlateMap() {
            var selectedPlate = document.getElementById('plateSelector').value;
            if (!selectedPlate) {
                document.getElementById('plateMapContainer').innerHTML = '<p style="text-align: center; color: #999;">Please select a plate to view</p>';
                return;
            }

            // Extract plate type and name
            var parts = selectedPlate.split(' - ');
            var plateType = parts[0];
            var plateName = parts[1];

            // Build a map of well positions to samples
            var wellMap = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var wellPos = null;
                var details = null;

                if (plateType === 'TSB' && s.tsbDetails && s.tsbDetails.storagePlate === plateName) {
                    wellPos = s.tsbDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Extraction' && s.extractionDetails && s.extractionDetails.storagePlate === plateName) {
                    wellPos = s.extractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Clean Extraction' && s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate === plateName) {
                    wellPos = s.cleanExtractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Indexing' && s.indexingDetails && s.indexingDetails.storagePlate === plateName) {
                    wellPos = s.indexingDetails.wellPosition;
                    details = s;
                }

                if (wellPos) {
                    wellMap[wellPos] = details;
                }
            }

            // Generate 96-well plate HTML
            var html = '<div class="plate-map"><table>';

            // Header row with column numbers
            html += '<tr><th></th>';
            for (var col = 1; col <= 12; col++) {
                html += '<th>' + col + '</th>';
            }
            html += '</tr>';

            // Data rows
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            for (var r = 0; r < rows.length; r++) {
                html += '<tr>';
                html += '<th>' + rows[r] + '</th>';

                for (var col = 1; col <= 12; col++) {
                    var wellPos = rows[r] + col;
                    var sample = wellMap[wellPos];

                    if (sample) {
                        var bgColor = getStatusColor(sample.status);
                        var title = sample.id + ' - ' + sample.status;
                        html += '<td style="background: ' + bgColor + ';" title="' + title + '" onclick="viewSample(\'' + sample.id.replace(/'/g, "\\'") + '\')">';
                        html += '<span class="well-id">' + sample.id + '</span>';
                        html += '</td>';
                    } else {
                        html += '<td title="Empty well ' + wellPos + '">';
                        html += '<span style="font-size: 8px; color: #999;">' + wellPos + '</span>';
                        html += '</td>';
                    }
                }
                html += '</tr>';
            }

            html += '</table></div>';
            document.getElementById('plateMapContainer').innerHTML = html;
        }

        function getStatusColor(status) {
            var colors = {
                'Received': '#e9ecef',
                'BAP Complete': '#d4edda',
                'TSB Complete': '#fff3cd',
                'Extraction Complete': '#f3e5f5',
                'Clean Extraction Complete': '#e8f5e8',
                'Clean Extraction Qubit Complete': '#e8f4fd',
                'Indexing Complete': '#e3f2fd',
                'Qubit Complete': '#fff3e0'
            };
            return colors[status] || '#f8f9fa';
        }

        function toggleDarkMode() {
            var currentTheme = document.documentElement.getAttribute('data-theme');
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);

            // Update button text
            var button = document.getElementById('darkModeToggle');
            if (newTheme === 'dark') {
                button.innerHTML = '☀️ Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                button.innerHTML = '🌙 Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            var button = document.getElementById('darkModeToggle');
            if (button) {
                if (savedTheme === 'dark') {
                    button.innerHTML = '☀️ Light Mode';
                } else {
                    button.innerHTML = '🌙 Dark Mode';
                }
            }
        }

        var bulkSelectedSamples = [];
        var currentQRSampleId = null;

        function showQRCode(sampleId) {
            currentQRSampleId = sampleId;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            // Generate QR code data (JSON format for comprehensive info)
            var qrData = {
                id: sample.id,
                status: sample.status,
                added: sample.dateAdded,
                initials: sample.initials
            };

            // Add BAP number if exists
            if (sample.bapNumber) {
                qrData.bap = sample.bapNumber;
            }

            var qrDataString = JSON.stringify(qrData);

            // Generate QR code using Google Charts API
            var qrSize = 300;
            var qrCodeURL = 'https://chart.googleapis.com/chart?cht=qr&chs=' + qrSize + 'x' + qrSize + '&chl=' + encodeURIComponent(qrDataString);

            // Display QR code
            var qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '<img src="' + qrCodeURL + '" alt="QR Code for ' + sample.id + '" style="max-width: 100%; border: 2px solid var(--border-color); border-radius: 8px;">';

            // Display sample info
            var infoContainer = document.getElementById('qrSampleInfo');
            var html = '<h4 style="margin-top: 0;">' + sample.id + '</h4>';
            html += '<p><strong>Status:</strong> ' + sample.status + '</p>';
            html += '<p><strong>Added:</strong> ' + sample.dateAdded + '</p>';
            html += '<p><strong>Technician:</strong> ' + sample.initials + '</p>';
            if (sample.bapNumber) {
                html += '<p><strong>BAP #:</strong> ' + sample.bapNumber + '</p>';
            }
            if (sample.notes) {
                html += '<p><strong>Notes:</strong> ' + sample.notes + '</p>';
            }
            infoContainer.innerHTML = html;

            // Show modal
            document.getElementById('qrCodeModal').style.display = 'block';
        }

        function closeQRCodeModal() {
            document.getElementById('qrCodeModal').style.display = 'none';
            currentQRSampleId = null;
        }

        function printQRCode() {
            var modal = document.getElementById('qrCodeModal');
            var qrContainer = document.getElementById('qrCodeContainer').innerHTML;
            var sampleInfo = document.getElementById('qrSampleInfo').innerHTML;

            // Open print window with QR code
            var printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write('<html><head><title>QR Code Label - ' + currentQRSampleId + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }');
            printWindow.document.write('h2 { margin: 10px 0; }');
            printWindow.document.write('.label { border: 2px solid #000; padding: 20px; display: inline-block; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="label">');
            printWindow.document.write('<h2>BWGS Sample</h2>');
            printWindow.document.write(qrContainer);
            printWindow.document.write(sampleInfo);
            printWindow.document.write('<p style="margin-top: 20px; font-size: 12px; color: #666;">Scan QR code to view sample details</p>');
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait a bit for images to load then print
            setTimeout(function() {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function toggleSampleSelection(sampleId, checkbox) {
            if (checkbox.checked) {
                if (bulkSelectedSamples.indexOf(sampleId) === -1) {
                    bulkSelectedSamples.push(sampleId);
                }
            } else {
                var index = bulkSelectedSamples.indexOf(sampleId);
                if (index > -1) {
                    bulkSelectedSamples.splice(index, 1);
                }
            }
            updateBulkOpsBar();
        }

        function toggleSelectAll() {
            var selectAll = document.getElementById('selectAllCheckbox').checked;
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            bulkSelectedSamples = [];

            for (var i = 0; i < checkboxes.length; i++) {
                var checkbox = checkboxes[i];
                var sampleItem = checkbox.closest('.sample-item');

                // Only select visible samples
                if (sampleItem && sampleItem.style.display !== 'none') {
                    checkbox.checked = selectAll;
                    if (selectAll) {
                        bulkSelectedSamples.push(checkbox.value);
                    }
                }
            }
            updateBulkOpsBar();
        }

        function clearSelection() {
            bulkSelectedSamples = [];
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkOpsBar();
        }

        function updateBulkOpsBar() {
            var bar = document.getElementById('bulkOpsBar');
            var count = bulkSelectedSamples.length;
            document.getElementById('selectedCount').textContent = count;

            if (count > 0) {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }
        }

        function bulkDelete() {
            if (bulkSelectedSamples.length === 0) return;

            var deleteCount = bulkSelectedSamples.length;
            var confirmed = confirm('Are you sure you want to delete ' + deleteCount + ' sample(s)?\n\nThis cannot be undone!');
            if (!confirmed) return;

            // Delete all selected samples (iterate backwards to avoid index issues)
            samples = samples.filter(function(sample) {
                return bulkSelectedSamples.indexOf(sample.id) === -1;
            });

            clearSelection();
            saveData();
            renderSamples();
            alert(deleteCount + ' sample(s) deleted successfully!');
        }

        function showBulkStatusChange() {
            if (bulkSelectedSamples.length === 0) return;

            var newStatus = prompt('Enter new status for ' + bulkSelectedSamples.length + ' sample(s):\n\n' +
                'Options:\n' +
                '- Received\n' +
                '- BAP Complete\n' +
                '- TSB Complete\n' +
                '- Extraction Complete\n' +
                '- Clean Extraction Complete\n' +
                '- Clean Extraction Qubit Complete\n' +
                '- Indexing Complete\n' +
                '- Qubit Complete');

            if (!newStatus) return;

            var validStatuses = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];

            if (validStatuses.indexOf(newStatus) === -1) {
                alert('Invalid status! Please use one of the listed options.');
                return;
            }

            // Update status for all selected samples
            var updated = 0;
            for (var i = 0; i < bulkSelectedSamples.length; i++) {
                var sampleId = bulkSelectedSamples[i];
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        samples[j].status = newStatus;
                        updated++;
                        break;
                    }
                }
            }

            clearSelection();
            saveData();
            renderSamples();
            alert(updated + ' sample(s) status updated to: ' + newStatus);
        }

        function showAnalytics() {
            document.getElementById('analyticsModal').style.display = 'block';
            renderAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        function renderAnalytics() {
            var html = '';

            // Calculate analytics
            var totalSamples = samples.length;
            var statusCounts = {};
            var techCounts = {};
            var dailyThroughput = {};
            var avgTimePerStage = {};

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Count by status
                statusCounts[s.status] = (statusCounts[s.status] || 0) + 1;

                // Count by technician
                if (s.initials) techCounts[s.initials] = (techCounts[s.initials] || 0) + 1;
                if (s.bapDetails && s.bapDetails.tech) techCounts[s.bapDetails.tech] = (techCounts[s.bapDetails.tech] || 0) + 1;
                if (s.tsbDetails && s.tsbDetails.tech) techCounts[s.tsbDetails.tech] = (techCounts[s.tsbDetails.tech] || 0) + 1;

                // Daily throughput (samples added per day)
                var dateKey = s.dateAdded.split('T')[0];
                dailyThroughput[dateKey] = (dailyThroughput[dateKey] || 0) + 1;
            }

            // Top stats grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">';
            html += '<div class="stat-card"><div class="stat-label">Total Samples</div><div class="stat-value">' + totalSamples + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" style="color: #28a745;">' + (statusCounts['Qubit Complete'] || 0) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">In Progress</div><div class="stat-value" style="color: #ffc107;">' + (totalSamples - (statusCounts['Qubit Complete'] || 0)) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Completion Rate</div><div class="stat-value" style="color: #17a2b8;">' + (totalSamples > 0 ? Math.round(((statusCounts['Qubit Complete'] || 0) / totalSamples) * 100) : 0) + '%</div></div>';
            html += '</div>';

            // Charts grid
            html += '<div class="analytics-grid">';

            // Status distribution chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">📊 Samples by Status</div>';
            html += '<div class="bar-chart">';
            var maxStatusCount = Math.max.apply(null, Object.values(statusCounts));
            for (var status in statusCounts) {
                var count = statusCounts[status];
                var percentage = maxStatusCount > 0 ? (count / maxStatusCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + status + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%;">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Technician workload chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">👥 Work by Technician</div>';
            html += '<div class="bar-chart">';
            var maxTechCount = Math.max.apply(null, Object.values(techCounts));
            var sortedTechs = Object.keys(techCounts).sort(function(a, b) {
                return techCounts[b] - techCounts[a];
            });
            for (var t = 0; t < sortedTechs.length && t < 10; t++) {
                var tech = sortedTechs[t];
                var count = techCounts[tech];
                var percentage = maxTechCount > 0 ? (count / maxTechCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + tech + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Daily throughput chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">📅 Daily Sample Input</div>';
            html += '<div class="bar-chart">';
            var sortedDates = Object.keys(dailyThroughput).sort().slice(-14); // Last 14 days
            var maxDailyCount = Math.max.apply(null, sortedDates.map(function(d) { return dailyThroughput[d]; }));
            for (var d = 0; d < sortedDates.length; d++) {
                var date = sortedDates[d];
                var count = dailyThroughput[date];
                var percentage = maxDailyCount > 0 ? (count / maxDailyCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + date + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Stage completion rates
            html += '<div class="chart-container">';
            html += '<div class="chart-title">🎯 Stage Completion Rates</div>';
            html += '<div class="bar-chart">';
            var stages = [
                { name: 'BAP', key: 'BAP Complete' },
                { name: 'TSB', key: 'TSB Complete' },
                { name: 'Extraction', key: 'Extraction Complete' },
                { name: 'Clean Extract', key: 'Clean Extraction Complete' },
                { name: 'CE Qubit', key: 'Clean Extraction Qubit Complete' },
                { name: 'Indexing', key: 'Indexing Complete' },
                { name: 'Final Qubit', key: 'Qubit Complete' }
            ];

            for (var st = 0; st < stages.length; st++) {
                var stage = stages[st];
                var completed = 0;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].status === stage.key || isStageComplete(samples[i], stage.key)) {
                        completed++;
                    }
                }
                var percentage = totalSamples > 0 ? (completed / totalSamples) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + stage.name + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);">' + completed + ' (' + Math.round(percentage) + '%)</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            html += '</div>'; // Close analytics-grid

            document.getElementById('analyticsContainer').innerHTML = html;
        }

        function isStageComplete(sample, stage) {
            var stageOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete', 'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];
            var currentIndex = stageOrder.indexOf(sample.status);
            var checkIndex = stageOrder.indexOf(stage);
            return currentIndex >= checkIndex;
        }

        function showTimeline() {
            document.getElementById('timelineModal').style.display = 'block';
            renderTimeline();
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        function renderTimeline() {
            var view = document.getElementById('timelineView').value;
            var events = [];

            // Collect all events from samples
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Add sample received event
                events.push({
                    date: s.dateAdded,
                    sampleId: s.id,
                    stage: 'Received',
                    tech: s.initials,
                    details: 'Sample received and logged'
                });

                // Add BAP event
                if (s.bapDetails) {
                    events.push({
                        date: s.bapDetails.completionDate,
                        sampleId: s.id,
                        stage: 'BAP Complete',
                        tech: s.bapDetails.tech,
                        details: 'Lot: ' + s.bapDetails.lotNumber + ', ' + s.bapDetails.temperature + '°C, ' + s.bapDetails.incubator
                    });
                }

                // Add TSB event
                if (s.tsbDetails) {
                    events.push({
                        date: s.tsbDetails.completionDate,
                        sampleId: s.id,
                        stage: 'TSB Complete',
                        tech: s.tsbDetails.tech,
                        details: 'Lot: ' + s.tsbDetails.lotNumber + ', Plate: ' + s.tsbDetails.storagePlate + ', Well: ' + s.tsbDetails.wellPosition
                    });
                }

                // Add Extraction event
                if (s.extractionDetails) {
                    events.push({
                        date: s.extractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Extraction Complete',
                        tech: s.extractionDetails.tech,
                        details: 'Run: ' + s.extractionDetails.extractionRun + ', Plate: ' + s.extractionDetails.storagePlate
                    });
                }

                // Add Clean Extraction event
                if (s.cleanExtractionDetails) {
                    events.push({
                        date: s.cleanExtractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Clean Extraction Complete',
                        tech: s.cleanExtractionDetails.tech,
                        details: 'Run: ' + s.cleanExtractionDetails.extractionRun + ', Plate: ' + s.cleanExtractionDetails.storagePlate
                    });
                }

                // Add CE Qubit event
                if (s.cleanExtractionQubitDetails) {
                    events.push({
                        date: s.cleanExtractionQubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'CE Qubit Complete',
                        tech: s.cleanExtractionQubitDetails.tech,
                        details: 'Concentration: ' + s.cleanExtractionQubitDetails.concentration + ' ng/uL'
                    });
                }

                // Add Indexing event
                if (s.indexingDetails) {
                    events.push({
                        date: s.indexingDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Indexing Complete',
                        tech: s.indexingDetails.tech,
                        details: 'i5: ' + s.indexingDetails.i5Index + ', i7: ' + s.indexingDetails.i7Index
                    });
                }

                // Add Final Qubit event
                if (s.qubitDetails) {
                    events.push({
                        date: s.qubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Qubit Complete',
                        tech: s.qubitDetails.tech,
                        details: 'Concentration: ' + s.qubitDetails.concentration + ' ng/uL'
                    });
                }
            }

            // Filter by view
            var now = new Date();
            if (view === 'recent') {
                var sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= sevenDaysAgo;
                });
            } else if (view === 'month') {
                var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= thirtyDaysAgo;
                });
            }

            // Sort by date (newest first)
            events.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });

            // Render timeline
            var html = '<div class="timeline">';

            if (events.length === 0) {
                html += '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No events to display</p>';
            } else {
                for (var i = 0; i < events.length; i++) {
                    var event = events[i];
                    var stageColor = getStageColor(event.stage);

                    html += '<div class="timeline-item">';
                    html += '<div class="timeline-date">' + formatDate(event.date) + '</div>';
                    html += '<div class="timeline-marker" style="background: ' + stageColor + ';"></div>';
                    html += '<div class="timeline-content" style="border-left-color: ' + stageColor + ';">';
                    html += '<h4>' + event.sampleId + ' <span class="timeline-stage" style="background: ' + stageColor + '; color: white;">' + event.stage + '</span></h4>';
                    html += '<p>👤 Technician: ' + event.tech + '</p>';
                    html += '<p>📋 ' + event.details + '</p>';
                    html += '</div>';
                    html += '</div>';
                }
            }

            html += '</div>';
            document.getElementById('timelineContainer').innerHTML = html;
        }

        function getStageColor(stage) {
            var colors = {
                'Received': '#6c757d',
                'BAP Complete': '#28a745',
                'TSB Complete': '#ffc107',
                'Extraction Complete': '#9c27b0',
                'Clean Extraction Complete': '#4caf50',
                'CE Qubit Complete': '#2196f3',
                'Indexing Complete': '#00bcd4',
                'Qubit Complete': '#ff9800'
            };
            return colors[stage] || '#007bff';
        }

        function formatDate(dateString) {
            var date = new Date(dateString);
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            var year = date.getFullYear();
            var hours = date.getHours().toString().padStart(2, '0');
            var minutes = date.getMinutes().toString().padStart(2, '0');
            return month + '/' + day + '/' + year + ' ' + hours + ':' + minutes;
        }

        function editNotes(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var currentNotes = sample.notes || '';
            var newNotes = prompt('Edit notes for sample: ' + sampleId, currentNotes);

            if (newNotes !== null) {
                sample.notes = newNotes;
                saveData();
                renderSamples();
            }
        }

        function deleteSample(sampleId) {
            if (confirm('Are you sure you want to delete sample: ' + sampleId + '?\n\nThis action cannot be undone!')) {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        samples.splice(i, 1);
                        break;
                    }
                }
                saveData();
                renderSamples();
                alert('Sample ' + sampleId + ' deleted successfully.');
            }
        }

        function viewSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var chain = 'SAMPLE: ' + sample.id + '\n';
            chain += 'Status: ' + sample.status + '\n';
            chain += 'Added: ' + sample.dateAdded + ' by ' + sample.initials + '\n\n';

            if (sample.bapDetails) chain += 'BAP: ' + sample.bapNumber + '\n';
            if (sample.tsbDetails) chain += 'TSB: ' + sample.tsbNumber + '\n';
            if (sample.extractionDetails) chain += 'Extraction: ' + sample.extractionNumber + '\n';
            if (sample.cleanExtractionDetails) chain += 'Clean Extraction: ' + sample.cleanExtractionNumber + '\n';
            if (sample.indexingDetails) chain += 'Indexing: ' + sample.indexingNumber + '\n';
            if (sample.qubitDetails) chain += 'Qubit: ' + sample.qubitDetails.concentration + ' ng/uL\n';

            alert(chain);
        }

        function updateQuickStats() {
            var statsPanel = document.getElementById('quickStats');

            // Calculate stats
            var totalSamples = samples.length;
            var completedSamples = 0;
            var inProgressSamples = 0;
            var qcFailures = 0;
            var lastAdded = null;

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                if (s.status === 'Qubit Complete') {
                    completedSamples++;
                } else if (s.status !== 'Received') {
                    inProgressSamples++;
                }

                // Check for QC failures
                if (s.cleanExtractionQubitDetails) {
                    var ceQC = checkQCThreshold(s.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
                    if (!ceQC.pass) qcFailures++;
                }
                if (s.qubitDetails) {
                    var fqQC = checkQCThreshold(s.qubitDetails.concentration, 'finalQubit');
                    if (!fqQC.pass) qcFailures++;
                }

                // Track last added
                if (!lastAdded || new Date(s.dateAdded) > new Date(lastAdded.dateAdded)) {
                    lastAdded = s;
                }
            }

            var completionRate = totalSamples > 0 ? Math.round((completedSamples / totalSamples) * 100) : 0;

            var html = '';

            // Total samples
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + totalSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Total Samples</div>';
            html += '</div>';

            // Completion rate
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + completionRate + '%</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Completion Rate</div>';
            html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + completedSamples + ' of ' + totalSamples + ' complete</div>';
            html += '</div>';

            // In progress
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + inProgressSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">In Progress</div>';
            html += '</div>';

            // QC Failures
            var qcColor = qcFailures > 0 ? '#ff6b6b' : '#51cf66';
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold; color: ' + qcColor + ';">' + qcFailures + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">QC Warnings</div>';
            html += '</div>';

            // Last added
            if (lastAdded) {
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
                html += '<div style="font-size: 16px; font-weight: bold;">' + lastAdded.id + '</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Last Added</div>';
                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + lastAdded.dateAdded + '</div>';
                html += '</div>';
            }

            statsPanel.innerHTML = html;
        }

        function updateDashboard() {
            var statusCounts = {
                'Received': 0,
                'BAP Complete': 0,
                'TSB Complete': 0,
                'Extraction Complete': 0,
                'Clean Extraction Complete': 0,
                'Clean Extraction Qubit Complete': 0,
                'Indexing Complete': 0,
                'Qubit Complete': 0
            };

            for (var i = 0; i < samples.length; i++) {
                var status = samples[i].status;
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            }

            var dashboard = document.getElementById('statusDashboard');
            var html = '';

            var statuses = [
                {name: 'Received', icon: '📥', color: '#495057', bg: '#e9ecef'},
                {name: 'BAP Complete', icon: '🧫', color: '#155724', bg: '#d4edda'},
                {name: 'TSB Complete', icon: '🧪', color: '#856404', bg: '#fff3cd'},
                {name: 'Extraction Complete', icon: '🧬', color: '#7b1fa2', bg: '#f3e5f5'},
                {name: 'Clean Extraction Complete', icon: '🧽', color: '#2e7d32', bg: '#e8f5e8'},
                {name: 'Clean Extraction Qubit Complete', icon: '📊', color: '#1565c0', bg: '#e8f4fd'},
                {name: 'Indexing Complete', icon: '🔬', color: '#1976d2', bg: '#e3f2fd'},
                {name: 'Qubit Complete', icon: '✅', color: '#f57c00', bg: '#fff3e0'}
            ];

            for (var i = 0; i < statuses.length; i++) {
                var s = statuses[i];
                html += '<div style="background: ' + s.bg + '; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ' + s.color + '20;">';
                html += '<div style="font-size: 24px;">' + s.icon + '</div>';
                html += '<div style="font-size: 28px; font-weight: bold; color: ' + s.color + '; margin: 5px 0;">' + statusCounts[s.name] + '</div>';
                html += '<div style="font-size: 11px; color: ' + s.color + '; font-weight: 600;">' + s.name.toUpperCase() + '</div>';
                html += '</div>';
            }

            html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #dee2e6;">';
            html += '<div style="font-size: 24px;">📦</div>';
            html += '<div style="font-size: 28px; font-weight: bold; color: #212529; margin: 5px 0;">' + samples.length + '</div>';
            html += '<div style="font-size: 11px; color: #495057; font-weight: 600;">TOTAL SAMPLES</div>';
            html += '</div>';

            dashboard.innerHTML = html;
        }

        function sortSamples() {
            var sortType = document.getElementById('sortSelect').value;

            if (sortType === 'dateDesc') {
                // Newest first (reverse chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(b) - samples.indexOf(a);
                });
            } else if (sortType === 'dateAsc') {
                // Oldest first (chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(a) - samples.indexOf(b);
                });
            } else if (sortType === 'idAsc') {
                // ID A-Z
                samples.sort(function(a, b) {
                    return a.id.localeCompare(b.id);
                });
            } else if (sortType === 'idDesc') {
                // ID Z-A
                samples.sort(function(a, b) {
                    return b.id.localeCompare(a.id);
                });
            } else if (sortType === 'status') {
                // By workflow status
                var statusOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                                  'Clean Extraction Complete', 'Clean Extraction Qubit Complete',
                                  'Indexing Complete', 'Qubit Complete'];
                samples.sort(function(a, b) {
                    var aIndex = statusOrder.indexOf(a.status);
                    var bIndex = statusOrder.indexOf(b.status);
                    return aIndex - bIndex;
                });
            }

            saveData();
            renderSamples();
        }

        function renderSamples() {
            var container = document.getElementById('sampleContainer');

            if (samples.length === 0) {
                container.innerHTML = '<p>No samples yet. Add one above!</p>';
                updateQuickStats();
                updateDashboard();
                return;
            }

            var receivedCount = 0;
var bapCount = 0;
var tsbCount = 0;
var extractionCount = 0;
var cleanExtractionCount = 0;
var cleanExtractionQubitCount = 0;
var indexingCount = 0;
            
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].status === 'Received') receivedCount++;
else if (samples[i].status === 'BAP Complete') bapCount++;
else if (samples[i].status === 'TSB Complete') tsbCount++;
else if (samples[i].status === 'Extraction Complete') extractionCount++;
else if (samples[i].status === 'Clean Extraction Complete') cleanExtractionCount++;
else if (samples[i].status === 'Clean Extraction Qubit Complete') cleanExtractionQubitCount++;
else if (samples[i].status === 'Indexing Complete') indexingCount++;
            }
            
            var html = '';
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var showCheckbox = false;
                
                if (receivedCount >= 2 && sample.status === 'Received') showCheckbox = true;
                else if (bapCount >= 2 && sample.status === 'BAP Complete') showCheckbox = true;
                else if (tsbCount >= 2 && sample.status === 'TSB Complete') showCheckbox = true;
                else if (extractionCount >= 2 && sample.status === 'Extraction Complete') showCheckbox = true;
                else if (cleanExtractionCount >= 2 && sample.status === 'Clean Extraction Complete') showCheckbox = true;
                else if (cleanExtractionQubitCount >= 2 && sample.status === 'Clean Extraction Qubit Complete') showCheckbox = true;
                else if (indexingCount >= 2 && sample.status === 'Indexing Complete') showCheckbox = true;
                
                html += '<div class="sample-item">';
                html += '<div class="sample-info">';

                // Always show checkbox for bulk operations
                var isChecked = bulkSelectedSamples.indexOf(sample.id) !== -1 ? ' checked' : '';
                html += '<input type="checkbox" class="sample-checkbox" value="' + sample.id + '" onchange="toggleSampleSelection(\'' + sample.id.replace(/'/g, "\\'") + '\', this)"' + isChecked + '> ';

                if (showCheckbox) {
                    // Batch processing checkbox (keep for compatibility)
                    html += '<input type="checkbox" class="sample-checkbox-batch" value="' + sample.id + '" onchange="updateSelection()"> ';
                }
                
                html += '<strong>' + sample.id + '</strong> ';
                html += '<span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span>';
                html += '<br><small>Added: ' + sample.dateAdded + ' | ' + sample.initials + '</small>';
                
                if (sample.bapDetails) html += '<br>BAP: ' + sample.bapNumber;
                if (sample.tsbDetails) html += '<br>TSB: ' + sample.tsbNumber;
                if (sample.extractionDetails) {
                    html += '<br>Extraction: ' + sample.extractionNumber + ' | Run: ' + sample.extractionDetails.extractionRun;
                    if (sample.extractionDetails.reagentLots && sample.extractionDetails.reagentLots.aw1) {
                        html += '<br><small>AW1: ' + sample.extractionDetails.reagentLots.aw1 + ' | AW2: ' + sample.extractionDetails.reagentLots.aw2 + '</small>';
                    }
                }
                if (sample.cleanExtractionDetails) {
                    html += '<br>Clean Extraction: ' + sample.cleanExtractionNumber + ' | Plate: ' + sample.cleanExtractionDetails.storagePlate + ' | Well: ' + sample.cleanExtractionDetails.wellPosition;
                    if (sample.cleanExtractionDetails.volumes && sample.cleanExtractionDetails.volumes.cleanup) {
                        html += '<br><small>Cleanup: ' + sample.cleanExtractionDetails.volumes.cleanup + ' | In: ' + sample.cleanExtractionDetails.volumes.elutionIn + ' | Out: ' + sample.cleanExtractionDetails.volumes.elutionOut + '</small>';
                    }
                }
                if (sample.indexingDetails) {
                    html += '<br>Indexing: ' + sample.indexingNumber + ' | Plate: ' + sample.indexingDetails.storagePlate + ' | Well: ' + sample.indexingDetails.wellPosition;
                    if (sample.indexingDetails.indexes && sample.indexingDetails.indexes.i5 && sample.indexingDetails.indexes.i7) {
                        html += '<br><small>i5: ' + sample.indexingDetails.indexes.i5 + ' | i7: ' + sample.indexingDetails.indexes.i7 + ' | Thaws: ' + sample.indexingDetails.indexes.i5Thaws + '/' + sample.indexingDetails.indexes.i7Thaws + '</small>';
                    }
                }
                if (sample.cleanExtractionQubitDetails) {
    var ceQC = checkQCThreshold(sample.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
    var ceStyle = ceQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Clean Extraction Qubit: <span' + ceStyle + '>' + sample.cleanExtractionQubitDetails.concentration + ' ng/uL</span>';
    if (!ceQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + ceQC.message + '</span>';
    }
    if (sample.cleanExtractionQubitDetails.reagentLot) {
        html += '<br><small>CE Qubit Reagent: ' + sample.cleanExtractionQubitDetails.reagentLot + ' | Date: ' + (sample.cleanExtractionQubitDetails.dateQubited || sample.cleanExtractionQubitDetails.completedDate) + '</small>';
    }
}
if (sample.qubitDetails) {
    var fqQC = checkQCThreshold(sample.qubitDetails.concentration, 'finalQubit');
    var fqStyle = fqQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Final Qubit: <span' + fqStyle + '>' + sample.qubitDetails.concentration + ' ng/uL</span>';
    if (!fqQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + fqQC.message + '</span>';
    }
    if (sample.qubitDetails.reagentLot) {
        html += '<br><small>Final Qubit Reagent: ' + sample.qubitDetails.reagentLot + ' | Date: ' + (sample.qubitDetails.dateQubited || sample.qubitDetails.completedDate) + '</small>';
    }
}
                
                // Show notes if they exist
                if (sample.notes && sample.notes.trim()) {
                    html += '<br><small style="color: #6c757d; font-style: italic;">📝 ' + sample.notes + '</small>';
                }

                html += '</div>';
                html += '<div class="sample-actions">';
                html += '<button onclick="viewSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">View</button><br>';
                html += '<button onclick="editSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #ffc107; color: #212529; border: none; border-radius: 4px; margin-bottom: 4px; font-weight: 600;">Edit</button><br>';
                html += '<button onclick="editNotes(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Notes</button><br>';
                html += '<button onclick="showQRCode(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">QR Code</button><br>';
                html += '<button onclick="deleteSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Delete</button><br>';

                if (sample.status === 'Received') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'BAP\')">Start BAP</button>';
                } else if (sample.status === 'BAP Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'TSB\')">Start TSB</button>';
                } else if (sample.status === 'TSB Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Extraction\')">Start Extraction</button>';
                } else if (sample.status === 'Extraction Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction\')">Start Clean Extraction</button>';
                } else if (sample.status === 'Clean Extraction Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction Qubit\')">Start Qubit</button>';
} else if (sample.status === 'Clean Extraction Qubit Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Indexing\')">Start Indexing</button>';
} else if (sample.status === 'Indexing Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Final Qubit\')">Start Final Qubit</button>';
                } else {
                    html += '<div style="color: green; font-weight: bold; text-align: center;">✓ Complete</div>';
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            updateSelection();
            updateQuickStats();
            updateDashboard();
        }

        // Password protection
        function checkPassword() {
            var password = document.getElementById('passwordInput').value;
            var correctPassword = 'bwgs2025'; // CHANGE THIS to your desired password

            if (password === correctPassword) {
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                sessionStorage.setItem('bwgsAuthenticated', 'true');
                loadData();
                renderSamples();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        // Check if already authenticated in this session
        if (sessionStorage.getItem('bwgsAuthenticated') === 'true') {
            document.getElementById('passwordOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Only if authenticated
            if (sessionStorage.getItem('bwgsAuthenticated') !== 'true') return;

            // Ctrl/Cmd + F - Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
                document.getElementById('searchInput').select();
            }

            // Ctrl/Cmd + E - Export JSON
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }

            // Ctrl/Cmd + Shift + E - Export CSV
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                exportCSV();
            }

            // Ctrl/Cmd + I - Import
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                importData();
            }

            // Ctrl/Cmd + N - Focus new sample input
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('sampleId').focus();
            }

            // Number keys 1-5 for quick filters
            if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                var activeElement = document.activeElement;
                // Only if not typing in input/textarea
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    var filters = document.getElementsByName('statusFilter');
                    if (filters[parseInt(e.key) - 1]) {
                        filters[parseInt(e.key) - 1].checked = true;
                        filterSamples();
                    }
                }
            }

            // Escape - Close modals
            if (e.key === 'Escape') {
                closeModal();
                closeBatchModal();
                closeEditModal();
                closeShortcutsModal();
                closePlateMapModal();
                closeTimelineModal();
                closeAnalyticsModal();
                closeQRCodeModal();
            }
        });

        // Load theme preference on page load (before authentication check)
        loadTheme();

        // Load saved data and render on page load (only if authenticated)
        if (sessionStorage.getItem('bwgsAuthenticated') === 'true') {
            loadData();
            renderSamples();
        }
        console.log('Lab Workflow Tracker loaded successfully!');
        console.log('Keyboard shortcuts: Ctrl+F (search), Ctrl+E (export), Ctrl+N (new sample), Esc (close), 1-5 (filters)');
    </script>
    </div> <!-- Close appContent div -->
</body>
</html>>