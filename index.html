<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Workflow Tracker - Working Version</title>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #ddd;
            --header-bg: #ffffff;
            --input-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --header-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        #passwordOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #passwordBox {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #passwordBox input {
            padding: 10px;
            margin: 10px 0;
            width: 250px;
            font-size: 16px;
        }

        #passwordBox button {
            padding: 10px 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        #passwordBox button:hover {
            background: #0056b3;
        }

        #appContent {
            display: none;
        }
        
        .header {
            background: var(--header-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            transition: background-color 0.3s;
        }

        .add-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .sample-list {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        input, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        button {
            padding: 8px 12px;
            margin: 5px;
            border: none;
            border-radius: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .sample-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .sample-info {
            flex: 1;
        }
        
        .sample-actions {
            display: flex;
            gap: 10px;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-received { background: #e9ecef; color: #495057; }
        .status-bap-in-progress { background: #fff9c4; color: #f57f17; font-weight: bold; }
        .status-bap-complete { background: #d4edda; color: #155724; }
        .status-tsb-in-progress { background: #ffe0b2; color: #e65100; font-weight: bold; }
        .status-tsb-complete { background: #fff3cd; color: #856404; }
        .status-extraction-complete { background: #f3e5f5; color: #7b1fa2; }
        .status-clean-extraction-complete { background: #e8f5e8; color: #2e7d32; }
        .status-indexing-complete { background: #e3f2fd; color: #1976d2; }
        .status-qubit-complete { background: #fff3e0; color: #f57c00; }
        .status-clean-extraction-qubit-complete { background: #e8f4fd; color: #1565c0; }
        .status-qc-failed { background: #f8d7da; color: #721c24; font-weight: bold; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .btn-cancel {
            background: #6c757d;
        }

        kbd {
            display: inline-block;
            padding: 3px 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            line-height: 1.4;
            color: #333;
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), inset 0 0 0 2px #fff;
            white-space: nowrap;
        }

        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            min-width: 150px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .bar-wrapper {
            flex: 1;
            height: 30px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 30px;
            position: relative;
        }

        .timeline-date {
            min-width: 120px;
            font-weight: bold;
            color: var(--text-secondary);
            padding-right: 20px;
            text-align: right;
        }

        .timeline-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid var(--bg-secondary);
            position: relative;
            flex-shrink: 0;
            margin: 0 20px;
            z-index: 1;
        }

        .timeline-marker::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 50px;
            background: #ddd;
        }

        .timeline-item:last-child .timeline-marker::before {
            display: none;
        }

        .timeline-content {
            flex: 1;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .timeline-content h4 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }

        .timeline-content p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .timeline-stage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Plate Map Styles */
        .plate-map {
            display: inline-block;
            border: 2px solid #333;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .plate-map table {
            border-collapse: collapse;
            font-size: 10px;
        }

        .plate-map th, .plate-map td {
            width: 40px;
            height: 40px;
            border: 1px solid #999;
            text-align: center;
            vertical-align: middle;
            padding: 2px;
            position: relative;
        }

        .plate-map th {
            background: #e9ecef;
            font-weight: bold;
        }

        .plate-map td {
            background: #f8f9fa;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .plate-map td:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .plate-map .well-occupied {
            background: #d4edda;
            font-weight: bold;
        }

        .plate-map .well-id {
            display: block;
            font-size: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .batch-controls {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }
        
        .batch-controls h4 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .sample-checkbox {
            margin-right: 8px;
        }
        
        .btn-batch {
            background: #ff9800;
            color: white;
        }
        
        .btn-batch:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Print Stylesheet */
        @media print {
            /* Hide interactive elements */
            #passwordOverlay,
            .add-section,
            button,
            input[type="text"],
            input[type="radio"],
            select,
            #searchInput,
            .modal,
            #quickStats,
            .close-btn {
                display: none !important;
            }

            /* Page setup */
            body {
                background: white;
                margin: 0;
                padding: 10mm;
                font-size: 11pt;
            }

            /* Header formatting */
            .header {
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 18pt;
                margin: 0;
            }

            /* Dashboard cards - show as text */
            .dashboard-grid {
                display: block !important;
                margin-bottom: 20px;
            }

            .dashboard-card {
                display: inline-block;
                width: auto;
                margin-right: 20px;
                padding: 5px 10px;
                border: 1px solid #333;
                page-break-inside: avoid;
            }

            /* Sample list formatting */
            .sample-list {
                padding: 0;
                border: none;
            }

            .sample-item {
                border: 1px solid #333;
                margin-bottom: 10px;
                padding: 10px;
                page-break-inside: avoid;
                display: block !important;
            }

            /* Sample details */
            .sample-item strong {
                font-size: 12pt;
            }

            .status {
                border: 1px solid #333 !important;
                background: white !important;
                color: #000 !important;
                padding: 2px 5px;
            }

            /* Compact layout for sample details */
            .sample-item br {
                display: none;
            }

            .sample-item span {
                display: inline-block;
                margin-right: 15px;
            }

            /* Page breaks */
            h2, h3 {
                page-break-after: avoid;
            }

            /* Print timestamp */
            .header::after {
                content: "Printed: " attr(data-print-date);
                display: block;
                font-size: 9pt;
                color: #666;
                margin-top: 5px;
            }

            /* Ensure links show full URL */
            a[href]::after {
                content: " (" attr(href) ")";
            }
        }

        /* Print button - only show when not printing */
        @media screen {
            .print-btn {
                background: #17a2b8;
                margin-left: 5px;
            }

            .print-btn:hover {
                background: #138496;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Overlay -->
    <div id="passwordOverlay">
        <div id="passwordBox">
            <h2>üîí BWGS Tracker Access</h2>
            <p>Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter') checkPassword()">
            <br>
            <button onclick="checkPassword()">Unlock</button>
            <p id="passwordError" style="color: red; display: none; margin-top: 10px;">Incorrect password</p>
        </div>
    </div>

    <!-- Main Application Content (hidden until password verified) -->
    <div id="appContent">
    <div class="header">
        <h1>üß™ Complete Lab Workflow Tracker</h1>
        <p>BAP ‚Üí TSB ‚Üí Extraction ‚Üí Clean Extraction ‚Üí Qubit ‚Üí Indexing ‚Üí Final Qubit</p>
        <div style="margin-top: 15px;">
            <button onclick="exportData()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">üì• Export JSON</button>
            <button onclick="exportCSV()" style="background: #20c997; font-size: 12px; padding: 6px 12px;">üìä Export CSV</button>
            <button onclick="window.print()" class="print-btn" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">üñ®Ô∏è Print</button>
            <button onclick="importData()" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">üì§ Import Data</button>
            <button onclick="showPlateMap()" style="background: #9c27b0; font-size: 12px; padding: 6px 12px;">üß´ Plate Map</button>
            <button onclick="showTimeline()" style="background: #ff6b6b; font-size: 12px; padding: 6px 12px;">üìÖ Timeline</button>
            <button onclick="showAnalytics()" style="background: #4ecdc4; font-size: 12px; padding: 6px 12px;">üìà Analytics</button>
            <button onclick="showReagentSearch()" style="background: #fd7e14; font-size: 12px; padding: 6px 12px;">üî¨ Reagent Search</button>
            <button onclick="showReagentTemplates()" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">üìã Reagent Templates</button>
            <button onclick="undo()" id="undoBtn" style="background: #6c757d; font-size: 12px; padding: 6px 12px;" disabled title="No actions to undo">‚Ü∂ Undo</button>
            <button onclick="clearAllData()" style="background: #dc3545; font-size: 12px; padding: 6px 12px;">üóëÔ∏è Clear All Data</button>
            <button onclick="showKeyboardShortcuts()" style="background: #6c757d; font-size: 12px; padding: 6px 12px;">‚å®Ô∏è Shortcuts</button>
            <button onclick="toggleDarkMode()" id="darkModeToggle" style="background: #495057; font-size: 12px; padding: 6px 12px;">üåô Dark Mode</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
        </div>
    </div>

    <!-- Quick Stats Panel -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
        <h3 style="margin-top: 0; color: white;">‚ö° Quick Stats</h3>
        <div id="quickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </div>

    <!-- Status Dashboard -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">üìä Status Dashboard</h3>
        <div id="statusDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
            <!-- Dashboard will be populated by JavaScript -->
        </div>
    </div>

    <div class="add-section">
        <h3>Add New Samples</h3>
        
        <!-- Single Sample Input -->
        <div id="singleInput">
            <h4>Single Sample:</h4>
            <input type="text" id="sampleId" placeholder="Sample ID" onkeyup="checkDuplicateRealtime(this)">
            <span id="duplicateWarning" style="color: #dc3545; font-weight: 600; margin-left: 10px; display: none;">‚ö†Ô∏è Already exists!</span>
            <input type="text" id="initials" placeholder="Initials" maxlength="3">
            <button onclick="addSample(false)">Add Sample</button>
            <button onclick="addSample(true)" style="background: #28a745; margin-left: 10px;">‚úö Add & Next</button>
            <div id="quickAddFeedback" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
        
        <!-- Toggle Button -->
        <div style="margin: 20px 0; text-align: center;">
            <button id="toggleBulk" onclick="toggleBulkInput()">Switch to Bulk Input</button>
        </div>
        
        <!-- Bulk Sample Input -->
        <div id="bulkInput" style="display: none;">
            <h4>Bulk Sample Input:</h4>
            <p><small>Paste sample IDs (one per line). Your initials will be applied to all samples.</small></p>
            <input type="text" id="bulkInitials" placeholder="Your initials (for all samples)" maxlength="3">
            <textarea id="bulkSamples" rows="6" placeholder="Paste sample IDs here, one per line:&#10;25KS01-001&#10;25KS01-002&#10;25KS01-003" style="width: 100%; margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            <button onclick="addBulkSamples()">Add All Samples</button>
        </div>
    </div>

    <div class="sample-list">
        <h3>Samples</h3>

        <!-- Bulk Operations Bar -->
        <div id="bulkOpsBar" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div>
                    <strong><span id="selectedCount">0</span> samples selected</strong>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="bulkDelete()" style="background: #dc3545; color: white;">üóëÔ∏è Delete Selected</button>
                    <button onclick="showBulkStatusChange()" style="background: #ffc107; color: #333;">üìù Change Status</button>
                    <button onclick="clearSelection()" style="background: #6c757d; color: white;">‚úñ Clear Selection</button>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="searchInput" placeholder="üîç Search by Sample ID..."
                       onkeyup="filterSamples()"
                       style="flex: 1; min-width: 250px; max-width: 400px; padding: 10px; font-size: 14px;">

                <select id="sortSelect" onchange="sortSamples()" style="padding: 10px; font-size: 14px;">
                    <option value="dateDesc">Sort: Newest First</option>
                    <option value="dateAsc">Sort: Oldest First</option>
                    <option value="idAsc">Sort: ID (A-Z)</option>
                    <option value="idDesc">Sort: ID (Z-A)</option>
                    <option value="status">Sort: By Status</option>
                </select>

                <label style="padding: 10px; background: white; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    <strong>Select All</strong>
                </label>

                <button onclick="toggleCompactView()" id="compactViewBtn" style="padding: 10px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üìã Compact View
                </button>
            </div>

            <div style="margin-top: 10px;">
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="all" checked onchange="filterSamples()"> All
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Received" onchange="filterSamples()"> Received
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="BAP In Progress" onchange="filterSamples()"> BAP Incubating
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="BAP Complete" onchange="filterSamples()"> BAP Complete
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="TSB In Progress" onchange="filterSamples()"> TSB Incubating
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="TSB Complete" onchange="filterSamples()"> TSB Complete
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Extraction Complete" onchange="filterSamples()"> Extraction
                </label>
                <label style="margin-right: 15px;">
                    <input type="radio" name="statusFilter" value="Complete" onchange="filterSamples()"> Complete
                </label>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">üìÖ Date Range:</strong>
                <button onclick="filterByDate('all')" id="dateFilterAll" class="date-filter-btn active" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">All Time</button>
                <button onclick="filterByDate('today')" id="dateFilterToday" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Today</button>
                <button onclick="filterByDate('week')" id="dateFilterWeek" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">This Week</button>
                <button onclick="filterByDate('month')" id="dateFilterMonth" class="date-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">This Month</button>
                <button onclick="filterByDate('30days')" id="dateFilter30Days" class="date-filter-btn" style="padding: 6px 12px; border: 2px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Last 30 Days</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">üö© Flag:</strong>
                <button onclick="filterByFlag('all')" id="flagFilterAll" class="flag-filter-btn active" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #28a745; background: #28a745; color: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">All</button>
                <button onclick="filterByFlag('Rush')" id="flagFilterRush" class="flag-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #dc3545; background: white; color: #dc3545; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">üî¥ Rush</button>
                <button onclick="filterByFlag('Hold')" id="flagFilterHold" class="flag-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #ffc107; background: white; color: #856404; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">‚è∏Ô∏è Hold</button>
                <button onclick="filterByFlag('Review')" id="flagFilterReview" class="flag-filter-btn" style="padding: 6px 12px; border: 2px solid #fd7e14; background: white; color: #fd7e14; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">‚ö†Ô∏è Review</button>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <strong style="margin-right: 10px;">‚ö° Ready for:</strong>
                <button onclick="filterReadyFor('BAP')" id="readyFilterBAP" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">BAP</button>
                <button onclick="filterReadyFor('TSB')" id="readyFilterTSB" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">TSB</button>
                <button onclick="filterReadyFor('Extraction')" id="readyFilterExtraction" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Extraction</button>
                <button onclick="filterReadyFor('CleanExtraction')" id="readyFilterCleanExtraction" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Clean Extraction</button>
                <button onclick="filterReadyFor('CEQubit')" id="readyFilterCEQubit" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">CE Qubit</button>
                <button onclick="filterReadyFor('Indexing')" id="readyFilterIndexing" class="ready-filter-btn" style="padding: 6px 12px; margin-right: 8px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Indexing</button>
                <button onclick="filterReadyFor('FinalQubit')" id="readyFilterFinalQubit" class="ready-filter-btn" style="padding: 6px 12px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">Final Qubit</button>
            </div>
        </div>

        <div class="batch-controls" id="batchControls" style="display: none;">
            <h4>üß™ Batch Processing</h4>
            <p><span id="selectedCount">0</span> samples selected</p>
            <button class="btn-batch" id="batchBtn" disabled onclick="startBatchProcess()">Start Batch</button>
            <button onclick="clearSelection()">Clear Selection</button>
        </div>
        
        <div id="sampleContainer"></div>
    </div>

    <!-- Batch Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeBatchModal()">&times;</span>
            <h3 id="batchModalTitle">Batch Processing</h3>
            <p>Processing <strong id="batchSampleCount">0</strong> samples</p>
            <p id="batchNumbers"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="batchTechInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="batchLotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="batchTemperature">
                    <option value="37">37¬∞C</option>
                    <option value="35">35¬∞C</option>
                    <option value="42">42¬∞C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="batchIncubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>Time In:</label>
                <input type="time" id="batchTimeIn" placeholder="HH:MM" onchange="calculateBatchIncubationDuration()">
            </div>

            <div class="form-group">
                <label>Time Out:</label>
                <input type="time" id="batchTimeOut" placeholder="HH:MM" onchange="calculateBatchIncubationDuration()">
            </div>

            <div id="batchIncubationDuration" style="padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; display: none;">
                <strong>Duration:</strong> <span id="batchDurationText"></span>
            </div>

            <button onclick="completeBatchProcess()">Complete Batch</button>
            <button class="btn-cancel" onclick="closeBatchModal()">Cancel</button>
        </div>
    </div>

    <!-- Individual Modal -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Process Sample</h3>
            <p>Sample: <strong id="modalSampleId"></strong></p>
            <p id="modalNumber"></p>
            
            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="techInitials" maxlength="3">
            </div>
            
            <div class="form-group">
                <label>Lot Number:</label>
                <input type="text" id="lotNumber">
            </div>
            
            <div class="form-group">
                <label>Temperature:</label>
                <select id="temperature">
                    <option value="37">37¬∞C</option>
                    <option value="35">35¬∞C</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Incubator:</label>
                <select id="incubator">
                    <option value="INC-1">Incubator 1</option>
                    <option value="INC-2">Incubator 2</option>
                </select>
            </div>

            <div class="form-group">
                <label>Time In:</label>
                <input type="time" id="timeIn" placeholder="HH:MM" onchange="calculateIncubationDuration()">
            </div>

            <div class="form-group">
                <label>Time Out:</label>
                <input type="time" id="timeOut" placeholder="HH:MM" onchange="calculateIncubationDuration()">
            </div>

            <div id="incubationDuration" style="padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 10px 0; display: none;">
                <strong>Duration:</strong> <span id="durationText"></span>
            </div>

            <div id="specificFields"></div>

            <div class="form-group">
                <label>Stage Notes (optional):</label>
                <textarea id="stageNotes" rows="3" placeholder="Any observations or notes about this processing stage..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;"></textarea>
                <small style="color: #6c757d;">e.g., "Sample looked cloudy", "Had to repeat step", "Extra incubation time needed"</small>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="saveAsTemplate()" style="background: #17a2b8; font-size: 13px; padding: 8px 16px;">üíæ Save as Template</button>
                <button onclick="loadTemplate()" style="background: #6c757d; font-size: 13px; padding: 8px 16px;">üìã Load Template</button>
            </div>

            <button onclick="completeProcess()">Complete</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Edit Sample Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3>Edit Sample</h3>
            <p>Original Sample ID: <strong id="editOriginalId"></strong></p>

            <div class="form-group">
                <label>Sample ID:</label>
                <input type="text" id="editSampleId">
            </div>

            <div class="form-group">
                <label>Technician Initials:</label>
                <input type="text" id="editInitials" maxlength="3">
            </div>

            <div class="form-group">
                <label>Status:</label>
                <select id="editStatus">
                    <option value="Received">Received</option>
                    <option value="BAP Complete">BAP Complete</option>
                    <option value="TSB Complete">TSB Complete</option>
                    <option value="Extraction Complete">Extraction Complete</option>
                    <option value="Clean Extraction Complete">Clean Extraction Complete</option>
                    <option value="Clean Extraction Qubit Complete">Clean Extraction Qubit Complete</option>
                    <option value="Indexing Complete">Indexing Complete</option>
                    <option value="Qubit Complete">Qubit Complete</option>
                </select>
            </div>

            <button onclick="saveEditedSample()">Save Changes</button>
            <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>

    <!-- Audit Trail Modal -->
    <div id="auditTrailModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" onclick="closeAuditTrailModal()">&times;</span>
            <h3>üìã Sample History & Audit Trail</h3>
            <div id="auditTrailContent"></div>
            <button onclick="closeAuditTrailModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Plate Map Modal -->
    <div id="plateMapModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <span class="close-btn" onclick="closePlateMapModal()">&times;</span>
            <h3>üß´ 96-Well Plate Map</h3>

            <div style="margin: 20px 0;">
                <label><strong>Select Plate:</strong></label>
                <select id="plateSelector" onchange="renderPlateMap()">
                    <option value="">-- Select a plate --</option>
                </select>
            </div>

            <div id="plateMapContainer" style="overflow-x: auto;">
                <!-- Plate map will be rendered here -->
            </div>

            <div id="plateMapLegend" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <strong>Legend:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e9ecef; border: 1px solid #999;"></span> Empty</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff9c4; border: 1px solid #f57f17;"></span> BAP Incubating</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #d4edda; border: 1px solid #155724;"></span> BAP Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #ffe0b2; border: 1px solid #e65100;"></span> TSB Incubating</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3cd; border: 1px solid #856404;"></span> TSB Complete</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #f3e5f5; border: 1px solid #7b1fa2;"></span> Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f5e8; border: 1px solid #2e7d32;"></span> Clean Extraction</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e8f4fd; border: 1px solid #1565c0;"></span> CE Qubit</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #e3f2fd; border: 1px solid #1976d2;"></span> Indexing</div>
                    <div><span style="display: inline-block; width: 12px; height: 12px; background: #fff3e0; border: 1px solid #f57c00;"></span> Complete</div>
                </div>
            </div>

            <button class="btn-cancel" onclick="closePlateMapModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-btn" onclick="closeQRCodeModal()">&times;</span>
            <h3>üì± Sample QR Code</h3>

            <div id="qrCodeContainer" style="margin: 20px 0;">
                <!-- QR Code will be generated here -->
            </div>

            <div id="qrSampleInfo" style="background: var(--bg-primary); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                <!-- Sample info will be shown here -->
            </div>

            <button onclick="printQRCode()" style="background: #28a745; color: white; margin-right: 10px;">üñ®Ô∏è Print Label</button>
            <button class="btn-cancel" onclick="closeQRCodeModal()">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeAnalyticsModal()">&times;</span>
            <h3>üìà Data Analytics Dashboard</h3>

            <div id="analyticsContainer" style="overflow-y: auto; max-height: 70vh;">
                <!-- Analytics will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeAnalyticsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="close-btn" onclick="closeTimelineModal()">&times;</span>
            <h3>üìÖ Sample Processing Timeline</h3>

            <div style="margin: 20px 0;">
                <label><strong>View:</strong></label>
                <select id="timelineView" onchange="renderTimeline()">
                    <option value="all">All Samples</option>
                    <option value="recent">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="stage">By Stage</option>
                </select>
            </div>

            <div id="timelineContainer" style="overflow-x: auto; overflow-y: auto; max-height: 60vh;">
                <!-- Timeline will be rendered here -->
            </div>

            <button class="btn-cancel" onclick="closeTimelineModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeShortcutsModal()">&times;</span>
            <h3>‚å®Ô∏è Keyboard Shortcuts</h3>

            <div style="margin-top: 20px;">
                <h4 style="color: #007bff; margin-bottom: 10px;">üîç Navigation</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + F</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus search box</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>1</kbd> - <kbd>5</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Quick status filters (All, Received, BAP, TSB, Extraction)</td>
                    </tr>
                </table>

                <h4 style="color: #28a745; margin-bottom: 10px;">üìä Actions</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export JSON backup</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + Shift + E</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Export CSV</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + I</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Import data</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + N</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Focus sample input (add new)</td>
                    </tr>
                </table>

                <h4 style="color: #fd7e14; margin-bottom: 10px;">üìà Views & Tools</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + T</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Timeline view</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + A</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Analytics dashboard</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + R</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Reagent Search</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + P</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Open Plate Map</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + K</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Show this shortcuts dialog</td>
                    </tr>
                </table>

                <h4 style="color: #9c27b0; margin-bottom: 10px;">‚öôÔ∏è Toggles</h4>
                <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + B</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Bulk Input mode</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + D</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Dark Mode</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Ctrl/Cmd + M</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Toggle Compact View</td>
                    </tr>
                </table>

                <h4 style="color: #6c757d; margin-bottom: 10px;">üö™ Modals</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;"><kbd>Esc</kbd></td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">Close any open modal</td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-align: center;">
                <strong style="font-size: 16px;">üí° Pro Tip: Use these shortcuts to navigate 10x faster!</strong><br>
                <small style="opacity: 0.9;">Total shortcuts: 17 | Number keys (1-5) only work when not typing</small>
            </div>

            <button class="btn-cancel" onclick="closeShortcutsModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Reagent Search Modal -->
    <div id="reagentSearchModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <span class="close-btn" onclick="closeReagentSearchModal()">&times;</span>
            <h3>üî¨ Reagent Lot Search & Traceability</h3>

            <div style="margin: 20px 0; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">Search for samples using a specific reagent lot number:</label>
                <input type="text" id="reagentSearchInput" placeholder="Enter lot number (e.g., AW1-LOT-2024-123)"
                       style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 4px; margin-bottom: 10px;"
                       onkeyup="if(event.key==='Enter') searchReagentLot()">
                <button onclick="searchReagentLot()" style="padding: 12px 24px; background: #fd7e14; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 16px;">
                    üîç Search
                </button>
            </div>

            <div id="reagentSearchResults" style="margin-top: 20px;">
                <!-- Search results will appear here -->
            </div>

            <button class="btn-cancel" onclick="closeReagentSearchModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Reagent Templates Modal -->
    <div id="reagentTemplatesModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <span class="close-btn" onclick="closeReagentTemplatesModal()">&times;</span>
            <h3>üìã Reagent Lot Templates</h3>
            <p style="color: #666; margin-bottom: 20px;">Save commonly used reagent lot combinations and reuse them later. Perfect when using the same lots for days or weeks!</p>

            <div style="margin: 20px 0;">
                <h4>üíæ Saved Templates:</h4>
                <div id="templatesList" style="margin-top: 15px;">
                    <!-- Templates will be listed here -->
                </div>
            </div>

            <button class="btn-cancel" onclick="closeReagentTemplatesModal()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <script>
        // Export data as JSON file
        function exportData() {
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                exportDate: new Date().toISOString()
            };

            var dataStr = JSON.stringify(data, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            var url = URL.createObjectURL(dataBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bwgs-tracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('JSON data exported successfully!');
        }

        // Export data as CSV file
        function exportCSV() {
            // Header row with ALL fields including 22+ reagent lots
            var csv = 'Sample ID,Status,Date Added,Initials,Flag,Notes,';
            // BAP
            csv += 'BAP Number,BAP Lot,BAP Tech,BAP Date,BAP Temp,BAP Incubator,BAP Time In,BAP Time Out,BAP Notes,';
            // TSB
            csv += 'TSB Number,TSB Lot,TSB Tech,TSB Date,TSB Temp,TSB Incubator,TSB Time In,TSB Time Out,TSB Notes,';
            // Extraction (8 reagent lots)
            csv += 'Extraction Number,Extraction Run,Extraction Tech,Extraction Date,';
            csv += 'Ext AW1 Lot,Ext AW2 Lot,Ext Ethanol Lot,Ext Buffer AL Lot,Ext Buffer ATL Lot,Ext Buffer AE Lot,Ext Proteinase K Lot,Ext DNeasy Lot,Extraction Notes,';
            // Clean Extraction (5 reagent lots + 3 volumes)
            csv += 'Clean Extraction Number,CE Storage Plate,CE Well,CE Tech,CE Date,';
            csv += 'CE Bead Lot,CE NF H2O ETOH Lot,CE ETOH Dilution Lot,CE NF H2O Elution Lot,CE Qubit Reagent Lot,';
            csv += 'CE Cleanup Volume,CE Elution In Volume,CE Elution Out Volume,CE Notes,';
            // CE Qubit
            csv += 'CE Qubit Concentration (ng/uL),CE Qubit Reagent Lot,CE Qubit Date,CE Qubit Tech,CE Qubit Notes,';
            // Indexing (9 reagent lots + 2 cleanup concentrations)
            csv += 'Indexing Number,Index Storage Plate,Index Well,Index Tech,Index Date,';
            csv += 'i5 Index,i7 Index,i5 Thaws,i7 Thaws,';
            csv += 'Index TD Buffer Lot,Index ATM Buffer Lot,Index NT Buffer Lot,Index NPM Lot,Index Resuspension Buffer Lot,Index Kit Lot,Index Beads Lot,Index ETOH Lot,Index NF H2O Lot,';
            csv += 'Index Cleanup Step1,Index Cleanup Step2,Index Notes,';
            // Final Qubit
            csv += 'Final Qubit Concentration (ng/uL),Final Qubit Reagent Lot,Final Qubit Date,Final Qubit Tech,Final Qubit Notes,';
            // QC and turnaround
            csv += 'QC Failures,Reprocess Count,Turnaround Days\n';

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var row = [
                    // Basic info
                    s.id,
                    s.status,
                    s.dateAdded,
                    s.initials,
                    s.flag || 'None',
                    s.notes || '',
                    // BAP
                    s.bapNumber || '',
                    s.bapDetails ? s.bapDetails.lot : '',
                    s.bapDetails ? s.bapDetails.technician : '',
                    s.bapDetails ? s.bapDetails.completedDate : '',
                    s.bapDetails ? s.bapDetails.temperature : '',
                    s.bapDetails ? s.bapDetails.incubator : '',
                    s.bapDetails ? s.bapDetails.timeIn : '',
                    s.bapDetails ? s.bapDetails.timeOut : '',
                    s.bapDetails ? (s.bapDetails.stageNotes || '') : '',
                    // TSB
                    s.tsbNumber || '',
                    s.tsbDetails ? s.tsbDetails.lot : '',
                    s.tsbDetails ? s.tsbDetails.technician : '',
                    s.tsbDetails ? s.tsbDetails.completedDate : '',
                    s.tsbDetails ? s.tsbDetails.temperature : '',
                    s.tsbDetails ? s.tsbDetails.incubator : '',
                    s.tsbDetails ? s.tsbDetails.timeIn : '',
                    s.tsbDetails ? s.tsbDetails.timeOut : '',
                    s.tsbDetails ? (s.tsbDetails.stageNotes || '') : '',
                    // Extraction
                    s.extractionNumber || '',
                    s.extractionDetails ? s.extractionDetails.extractionRun : '',
                    s.extractionDetails ? s.extractionDetails.technician : '',
                    s.extractionDetails ? s.extractionDetails.completedDate : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.aw1 : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.aw2 : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.ethanol : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferAL : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferATL : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.bufferAE : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.proteinaseK : '',
                    s.extractionDetails && s.extractionDetails.reagentLots ? s.extractionDetails.reagentLots.dneasy : '',
                    s.extractionDetails ? (s.extractionDetails.stageNotes || '') : '',
                    // Clean Extraction
                    s.cleanExtractionNumber || '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.storagePlate : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.wellPosition : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.technician : '',
                    s.cleanExtractionDetails ? s.cleanExtractionDetails.completedDate : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.bead : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.nfH2oEtoh : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.etohDilution : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.nfH2oElution : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.reagentLots ? s.cleanExtractionDetails.reagentLots.qubitReagent : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.cleanup : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.elutionIn : '',
                    s.cleanExtractionDetails && s.cleanExtractionDetails.volumes ? s.cleanExtractionDetails.volumes.elutionOut : '',
                    s.cleanExtractionDetails ? (s.cleanExtractionDetails.stageNotes || '') : '',
                    // CE Qubit
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.concentration : '',
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.reagentLot : '',
                    s.cleanExtractionQubitDetails ? (s.cleanExtractionQubitDetails.dateQubited || s.cleanExtractionQubitDetails.completedDate) : '',
                    s.cleanExtractionQubitDetails ? s.cleanExtractionQubitDetails.technician : '',
                    s.cleanExtractionQubitDetails ? (s.cleanExtractionQubitDetails.stageNotes || '') : '',
                    // Indexing
                    s.indexingNumber || '',
                    s.indexingDetails ? s.indexingDetails.storagePlate : '',
                    s.indexingDetails ? s.indexingDetails.wellPosition : '',
                    s.indexingDetails ? s.indexingDetails.technician : '',
                    s.indexingDetails ? s.indexingDetails.completedDate : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i5 : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i7 : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i5Thaws : '',
                    s.indexingDetails && s.indexingDetails.indexes ? s.indexingDetails.indexes.i7Thaws : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.tdBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.atmBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.ntBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.npm : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.resuspensionBuffer : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.indexesKit : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.beads : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.etoh : '',
                    s.indexingDetails && s.indexingDetails.reagentLots ? s.indexingDetails.reagentLots.nfH2o : '',
                    s.indexingDetails && s.indexingDetails.cleanupConcentrations ? s.indexingDetails.cleanupConcentrations.step1 : '',
                    s.indexingDetails && s.indexingDetails.cleanupConcentrations ? s.indexingDetails.cleanupConcentrations.step2 : '',
                    s.indexingDetails ? (s.indexingDetails.stageNotes || '') : '',
                    // Final Qubit
                    s.qubitDetails ? s.qubitDetails.concentration : '',
                    s.qubitDetails ? s.qubitDetails.reagentLot : '',
                    s.qubitDetails ? (s.qubitDetails.dateQubited || s.qubitDetails.completedDate) : '',
                    s.qubitDetails ? s.qubitDetails.technician : '',
                    s.qubitDetails ? (s.qubitDetails.stageNotes || '') : '',
                    // QC and turnaround
                    s.qcFailures ? s.qcFailures.length : '0',
                    s.reprocessCount || '0',
                    calculateTurnaroundDays(s) || ''
                ];

                // Escape commas and quotes in CSV
                row = row.map(function(cell) {
                    if (cell && cell.toString().indexOf(',') > -1) {
                        return '"' + cell.toString().replace(/"/g, '""') + '"';
                    }
                    return cell;
                });

                csv += row.join(',') + '\n';
            }

            var csvBlob = new Blob([csv], {type: 'text/csv'});
            var url = URL.createObjectURL(csvBlob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'bwgs-tracker-export-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('CSV exported successfully! Open in Excel or Google Sheets.');
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('This will replace all current data. Are you sure?')) {
                        samples = data.samples || [];
                        nextBapNumber = data.nextBapNumber || 1;
                        nextTsbNumber = data.nextTsbNumber || 1;
                        nextExtractionNumber = data.nextExtractionNumber || 1;
                        nextExtractionRun = data.nextExtractionRun || 1;
                        nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                        nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                        nextIndexingNumber = data.nextIndexingNumber || 1;
                        nextIndexingPlate = data.nextIndexingPlate || 1;
                        saveData();
                        renderSamples();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Clear all data
        function clearAllData() {
            if (confirm('This will delete ALL data permanently. Are you sure?\n\nConsider exporting your data first!')) {
                if (confirm('Really delete everything? This cannot be undone!')) {
                    localStorage.removeItem('bwgsTrackerData');
                    initializeDefaults();
                    renderSamples();
                    alert('All data has been cleared.');
                }
            }
        }

        // Load data from localStorage or initialize with defaults
        function loadData() {
            var savedData = localStorage.getItem('bwgsTrackerData');
            if (savedData) {
                try {
                    var data = JSON.parse(savedData);
                    samples = data.samples || [];
                    nextBapNumber = data.nextBapNumber || 1;
                    nextTsbNumber = data.nextTsbNumber || 1;
                    nextExtractionNumber = data.nextExtractionNumber || 1;
                    nextExtractionRun = data.nextExtractionRun || 1;
                    nextCleanExtractionNumber = data.nextCleanExtractionNumber || 1;
                    nextCleanExtractionPlate = data.nextCleanExtractionPlate || 1;
                    nextIndexingNumber = data.nextIndexingNumber || 1;
                    nextIndexingPlate = data.nextIndexingPlate || 1;
                    console.log('Data loaded from localStorage');
                } catch (e) {
                    console.error('Error loading data:', e);
                    initializeDefaults();
                }
            } else {
                initializeDefaults();
            }

            // Load reagent lot history
            var savedLotHistory = localStorage.getItem('reagentLotHistory');
            if (savedLotHistory) {
                try {
                    reagentLotHistory = JSON.parse(savedLotHistory);
                } catch (e) {
                    console.error('Error loading lot history:', e);
                    reagentLotHistory = {};
                }
            }
        }

        function initializeDefaults() {
            samples = [];
            nextBapNumber = 1;
            nextTsbNumber = 1;
            nextExtractionNumber = 1;
            nextExtractionRun = 1;
            nextCleanExtractionNumber = 1;
            nextCleanExtractionPlate = 1;
            nextIndexingNumber = 1;
            nextIndexingPlate = 1;
        }

        // Save data to localStorage
        function saveData() {
            var data = {
                samples: samples,
                nextBapNumber: nextBapNumber,
                nextTsbNumber: nextTsbNumber,
                nextExtractionNumber: nextExtractionNumber,
                nextExtractionRun: nextExtractionRun,
                nextCleanExtractionNumber: nextCleanExtractionNumber,
                nextCleanExtractionPlate: nextCleanExtractionPlate,
                nextIndexingNumber: nextIndexingNumber,
                nextIndexingPlate: nextIndexingPlate,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('bwgsTrackerData', JSON.stringify(data));
            console.log('Data saved to localStorage');
        }

        var samples = [];
        var nextBapNumber = 1;
        var nextTsbNumber = 1;
        var nextExtractionNumber = 1;
        var nextExtractionRun = 1;
        var nextCleanExtractionNumber = 1;
        var nextCleanExtractionPlate = 1;
        var nextIndexingNumber = 1;
        var nextIndexingPlate = 1;
        var currentProcessType = '';
        var selectedSamples = [];
        var undoStack = []; // Track last 10 actions for undo
        var reagentLotHistory = {}; // Store recently used lot numbers by field name
        var currentBatchSamples = [];
        var currentBatchType = '';
        var currentDateFilter = 'all'; // Track current date filter
        var lastWellPositions = {}; // Track last well position used per plate type
        var isCompactView = false; // Track compact view state

        function generateWellPosition(index) {
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var row = rows[index % 8];
            var col = String(Math.floor(index / 8) + 1);
            if (col.length === 1) col = '0' + col;
            return row + col;
        }

        // Get next well position based on last used
        function getNextWellPosition(plateType) {
            if (!lastWellPositions[plateType]) {
                return 'A01'; // Start at A01 if no history
            }

            var last = lastWellPositions[plateType];
            var row = last.charAt(0);
            var col = parseInt(last.substring(1));
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];

            // Increment column first (A01 ‚Üí A02 ‚Üí A03...)
            col++;

            // If we exceed 12 columns, go to next row
            if (col > 12) {
                col = 1;
                var rowIndex = rows.indexOf(row);
                rowIndex++;

                // If we exceed H row, wrap back to A01
                if (rowIndex >= rows.length) {
                    rowIndex = 0;
                }
                row = rows[rowIndex];
            }

            var colStr = String(col);
            if (colStr.length === 1) colStr = '0' + colStr;
            return row + colStr;
        }

        // Track well position usage
        function trackWellPosition(plateType, wellPosition) {
            lastWellPositions[plateType] = wellPosition;
        }

        // Calculate incubation duration
        function calculateIncubationDuration() {
            var timeIn = document.getElementById('timeIn').value;
            var timeOut = document.getElementById('timeOut').value;
            var durationDiv = document.getElementById('incubationDuration');
            var durationText = document.getElementById('durationText');

            if (!timeIn || !timeOut) {
                durationDiv.style.display = 'none';
                return;
            }

            // Parse times
            var inParts = timeIn.split(':');
            var outParts = timeOut.split(':');
            var inMinutes = parseInt(inParts[0]) * 60 + parseInt(inParts[1]);
            var outMinutes = parseInt(outParts[0]) * 60 + parseInt(outParts[1]);

            // Calculate difference (handle overnight incubations)
            var diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Add 24 hours if overnight
            }

            var hours = Math.floor(diffMinutes / 60);
            var minutes = diffMinutes % 60;

            var durationStr = hours + 'h ' + minutes + 'm';

            // Check if duration seems unusual (less than 1h or more than 24h)
            var warning = '';
            if (diffMinutes < 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Very short incubation!</span>';
            } else if (diffMinutes > 24 * 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Over 24 hours!</span>';
            }

            durationText.innerHTML = durationStr + warning;
            durationDiv.style.display = 'block';
        }

        function calculateBatchIncubationDuration() {
            var timeIn = document.getElementById('batchTimeIn').value;
            var timeOut = document.getElementById('batchTimeOut').value;
            var durationDiv = document.getElementById('batchIncubationDuration');
            var durationText = document.getElementById('batchDurationText');

            if (!timeIn || !timeOut) {
                durationDiv.style.display = 'none';
                return;
            }

            // Parse times
            var inParts = timeIn.split(':');
            var outParts = timeOut.split(':');
            var inMinutes = parseInt(inParts[0]) * 60 + parseInt(inParts[1]);
            var outMinutes = parseInt(outParts[0]) * 60 + parseInt(outParts[1]);

            // Calculate difference (handle overnight incubations)
            var diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Add 24 hours if overnight
            }

            var hours = Math.floor(diffMinutes / 60);
            var minutes = diffMinutes % 60;

            var durationStr = hours + 'h ' + minutes + 'm';

            // Check if duration seems unusual
            var warning = '';
            if (diffMinutes < 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Very short incubation!</span>';
            } else if (diffMinutes > 24 * 60) {
                warning = ' ‚ö†Ô∏è <span style="color: #d32f2f;">Over 24 hours!</span>';
            }

            durationText.innerHTML = durationStr + warning;
            durationDiv.style.display = 'block';
        }

        // Calculate turnaround time in days
        function calculateTurnaroundDays(sample) {
            if (sample.status !== 'Qubit Complete') return null;

            var startDate = new Date(sample.dateAdded);
            var endDate = sample.qubitDetails && sample.qubitDetails.completedDate
                ? new Date(sample.qubitDetails.completedDate)
                : new Date();

            var diffTime = Math.abs(endDate - startDate);
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays;
        }

        // Toggle compact view
        function toggleCompactView() {
            isCompactView = !isCompactView;
            var btn = document.getElementById('compactViewBtn');

            if (isCompactView) {
                btn.textContent = 'üìÑ Detailed View';
                btn.style.background = '#28a745';
            } else {
                btn.textContent = 'üìã Compact View';
                btn.style.background = '#6c757d';
            }

            renderSamples();
        }

        // Calculate sample progress (how many stages completed)
        function getSampleProgress(sample) {
            var stages = [
                {key: 'bapDetails', name: 'BAP'},
                {key: 'tsbDetails', name: 'TSB'},
                {key: 'extractionDetails', name: 'Extraction'},
                {key: 'cleanExtractionDetails', name: 'Clean Extraction'},
                {key: 'cleanExtractionQubitDetails', name: 'CE Qubit'},
                {key: 'indexingDetails', name: 'Indexing'},
                {key: 'qubitDetails', name: 'Final Qubit'}
            ];

            var completed = 0;
            for (var i = 0; i < stages.length; i++) {
                if (sample[stages[i].key]) {
                    completed++;
                }
            }

            var total = stages.length;
            var percentage = Math.round((completed / total) * 100);

            return {
                completed: completed,
                total: total,
                percentage: percentage
            };
        }

        // Generate progress bar HTML
        function getProgressBarHTML(sample) {
            var progress = getSampleProgress(sample);
            var color = progress.percentage === 100 ? '#28a745' :
                       progress.percentage >= 75 ? '#17a2b8' :
                       progress.percentage >= 50 ? '#ffc107' :
                       progress.percentage >= 25 ? '#fd7e14' : '#6c757d';

            var html = '<div style="margin: 8px 0;">';
            html += '<div style="display: flex; align-items: center; gap: 10px;">';
            html += '<div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">';
            html += '<div style="background: ' + color + '; height: 100%; width: ' + progress.percentage + '%; transition: width 0.3s ease;"></div>';
            html += '</div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: ' + color + '; min-width: 60px;">';
            html += progress.completed + '/' + progress.total + ' (' + progress.percentage + '%)';
            html += '</span>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        // Date filtering functions
        function filterByDate(period) {
            currentDateFilter = period;

            // Update button styles
            var buttons = document.querySelectorAll('.date-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].style.background = 'white';
                buttons[i].style.color = '#007bff';
            }

            var activeBtn = document.getElementById('dateFilter' + period.charAt(0).toUpperCase() + period.slice(1));
            if (period === 'all') activeBtn = document.getElementById('dateFilterAll');
            if (period === '30days') activeBtn = document.getElementById('dateFilter30Days');

            if (activeBtn) {
                activeBtn.style.background = '#007bff';
                activeBtn.style.color = 'white';
            }

            filterSamples();
        }

        function isWithinDateFilter(dateString) {
            if (currentDateFilter === 'all') return true;

            var sampleDate = new Date(dateString);
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if (currentDateFilter === 'today') {
                sampleDate.setHours(0, 0, 0, 0);
                return sampleDate.getTime() === today.getTime();
            }

            if (currentDateFilter === 'week') {
                var weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                return sampleDate >= weekAgo;
            }

            if (currentDateFilter === 'month') {
                var monthAgo = new Date(today);
                monthAgo.setMonth(today.getMonth() - 1);
                return sampleDate >= monthAgo;
            }

            if (currentDateFilter === '30days') {
                var thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                return sampleDate >= thirtyDaysAgo;
            }

            return true;
        }

        // Flag filtering
        var currentFlagFilter = 'all';

        function filterByFlag(flag) {
            currentFlagFilter = flag;

            // Update button styles
            var buttons = document.querySelectorAll('.flag-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                if (btn.id === 'flagFilterAll') {
                    btn.style.background = flag === 'all' ? '#28a745' : 'white';
                    btn.style.color = flag === 'all' ? 'white' : '#28a745';
                } else if (btn.id === 'flagFilterRush') {
                    btn.style.background = flag === 'Rush' ? '#dc3545' : 'white';
                    btn.style.color = flag === 'Rush' ? 'white' : '#dc3545';
                } else if (btn.id === 'flagFilterHold') {
                    btn.style.background = flag === 'Hold' ? '#ffc107' : 'white';
                    btn.style.color = flag === 'Hold' ? '#212529' : '#856404';
                } else if (btn.id === 'flagFilterReview') {
                    btn.style.background = flag === 'Review' ? '#fd7e14' : 'white';
                    btn.style.color = flag === 'Review' ? 'white' : '#fd7e14';
                }
            }

            filterSamples();
        }

        // Ready for stage filtering
        var currentReadyFilter = null;

        function filterReadyFor(stage) {
            currentReadyFilter = stage;

            // Update button styles
            var buttons = document.querySelectorAll('.ready-filter-btn');
            for (var i = 0; i < buttons.length; i++) {
                var btn = buttons[i];
                btn.style.background = 'white';
                btn.style.color = '#17a2b8';
            }

            var activeBtn = document.getElementById('readyFilter' + stage);
            if (activeBtn) {
                activeBtn.style.background = '#17a2b8';
                activeBtn.style.color = 'white';
            }

            // Determine what status to show
            var targetStatus = '';
            if (stage === 'BAP') targetStatus = 'Received';
            else if (stage === 'TSB') targetStatus = 'BAP Complete';
            else if (stage === 'Extraction') targetStatus = 'TSB Complete';
            else if (stage === 'CleanExtraction') targetStatus = 'Extraction Complete';
            else if (stage === 'CEQubit') targetStatus = 'Clean Extraction Complete';
            else if (stage === 'Indexing') targetStatus = 'Clean Extraction Qubit Complete';
            else if (stage === 'FinalQubit') targetStatus = 'Indexing Complete';

            // Set the status filter radio button
            var radios = document.getElementsByName('statusFilter');
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].value === targetStatus) {
                    radios[i].checked = true;
                    break;
                }
            }

            filterSamples();
        }

        // Change sample flag
        function changeFlag(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            var currentFlag = sample.flag || 'None';
            var options = ['None', 'Rush', 'Hold', 'Review'];
            var message = 'Current flag: ' + currentFlag + '\n\nSelect new flag:\n\n';
            message += '1 = None (no flag)\n';
            message += '2 = Rush üî¥ (expedited processing)\n';
            message += '3 = Hold ‚è∏Ô∏è (do not process)\n';
            message += '4 = Review ‚ö†Ô∏è (needs QC review)';

            var choice = prompt(message, currentFlag === 'None' ? '1' : currentFlag === 'Rush' ? '2' : currentFlag === 'Hold' ? '3' : '4');

            if (choice === null) return; // Cancelled

            var newFlag = 'None';
            if (choice === '1') newFlag = 'None';
            else if (choice === '2') newFlag = 'Rush';
            else if (choice === '3') newFlag = 'Hold';
            else if (choice === '4') newFlag = 'Review';
            else if (choice === 'None') newFlag = 'None';
            else if (choice === 'Rush') newFlag = 'Rush';
            else if (choice === 'Hold') newFlag = 'Hold';
            else if (choice === 'Review') newFlag = 'Review';

            sample.flag = newFlag;
            saveData();
            renderSamples();

            alert('Flag changed to: ' + newFlag);
        }

        // Clone/duplicate sample
        function cloneSample(sampleId) {
            var original = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    original = samples[i];
                    break;
                }
            }

            if (!original) return;

            var newId = prompt('Clone sample: ' + sampleId + '\n\nEnter new sample ID:', sampleId + '-COPY');
            if (!newId) return;

            newId = newId.trim();

            // Check for duplicates
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === newId) {
                    alert('Sample ID already exists: ' + newId);
                    return;
                }
            }

            // Create a deep copy of the sample
            var cloned = JSON.parse(JSON.stringify(original));
            cloned.id = newId;
            cloned.dateAdded = new Date().toLocaleDateString();

            samples.push(cloned);
            saveData();
            renderSamples();

            alert('Sample cloned successfully!\nOriginal: ' + sampleId + '\nNew: ' + newId);
        }

        // QC Fail tracking
        function markQCFailed(sampleId, stage) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            var reasons = [
                'Concentration too low',
                'Concentration too high',
                'No amplification',
                'Contamination suspected',
                'Reagent issue',
                'Equipment malfunction',
                'User error',
                'Other'
            ];

            var message = '‚ö†Ô∏è MARK AS QC FAILED\n\n';
            message += 'Sample: ' + sampleId + '\n';
            message += 'Stage: ' + stage + '\n\n';
            message += 'Select failure reason:\n\n';
            for (var i = 0; i < reasons.length; i++) {
                message += (i + 1) + ' = ' + reasons[i] + '\n';
            }

            var choice = prompt(message + '\nOr type a custom reason:');
            if (choice === null) return; // Cancelled

            var failReason = '';
            var choiceNum = parseInt(choice);
            if (!isNaN(choiceNum) && choiceNum >= 1 && choiceNum <= reasons.length) {
                failReason = reasons[choiceNum - 1];
            } else {
                failReason = choice.trim();
            }

            if (!failReason) {
                alert('QC failure reason is required!');
                return;
            }

            // Add additional notes
            var notes = prompt('Additional notes (optional):');

            sample.status = 'QC Failed';
            if (!sample.qcFailures) sample.qcFailures = [];

            sample.qcFailures.push({
                stage: stage,
                reason: failReason,
                notes: notes || '',
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            });

            saveData();
            renderSamples();

            alert('Sample marked as QC Failed\nReason: ' + failReason);
        }

        function reprocessSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            if (!sample.qcFailures || sample.qcFailures.length === 0) {
                alert('No QC failure history found');
                return;
            }

            var lastFailure = sample.qcFailures[sample.qcFailures.length - 1];

            var message = 'üîÑ RE-PROCESS SAMPLE\n\n';
            message += 'Sample: ' + sampleId + '\n';
            message += 'Last failure: ' + lastFailure.stage + '\n';
            message += 'Reason: ' + lastFailure.reason + '\n\n';
            message += 'Reset to which stage?\n\n';
            message += '1 = Received (start over)\n';
            message += '2 = Extraction Complete (redo clean extraction)\n';
            message += '3 = Clean Extraction Complete (redo Qubit)\n';
            message += '4 = Clean Extraction Qubit Complete (redo indexing)\n';
            message += '5 = Indexing Complete (redo final Qubit)\n';

            var choice = prompt(message, '3');
            if (choice === null) return; // Cancelled

            var newStatus = 'Received';
            if (choice === '1') newStatus = 'Received';
            else if (choice === '2') newStatus = 'Extraction Complete';
            else if (choice === '3') newStatus = 'Clean Extraction Complete';
            else if (choice === '4') newStatus = 'Clean Extraction Qubit Complete';
            else if (choice === '5') newStatus = 'Indexing Complete';

            sample.status = newStatus;

            // Track re-processing
            if (!sample.reprocessCount) sample.reprocessCount = 0;
            sample.reprocessCount++;

            saveData();
            renderSamples();

            alert('Sample reset to: ' + newStatus + '\nRe-process count: ' + sample.reprocessCount);
        }

        // Undo functionality
        function trackAction(actionType, data) {
            undoStack.push({
                type: actionType,
                data: JSON.parse(JSON.stringify(data)), // Deep copy
                timestamp: new Date().toISOString()
            });

            // Keep only last 10 actions
            if (undoStack.length > 10) {
                undoStack.shift();
            }

            updateUndoButton();
        }

        function updateUndoButton() {
            var btn = document.getElementById('undoBtn');
            if (undoStack.length > 0) {
                btn.disabled = false;
                btn.style.background = '#ffc107';
                btn.style.color = '#212529';
                var lastAction = undoStack[undoStack.length - 1];
                btn.title = 'Undo: ' + lastAction.type;
            } else {
                btn.disabled = true;
                btn.style.background = '#6c757d';
                btn.style.color = 'white';
                btn.title = 'No actions to undo';
            }
        }

        function undo() {
            if (undoStack.length === 0) {
                alert('Nothing to undo');
                return;
            }

            var action = undoStack.pop();

            if (action.type === 'Add Sample' || action.type === 'Add Bulk Samples') {
                // Remove the samples that were added
                var addedIds = action.data.sampleIds;
                samples = samples.filter(function(s) {
                    return addedIds.indexOf(s.id) === -1;
                });
                alert('Undone: ' + action.type + '\nRemoved ' + addedIds.length + ' sample(s)');
            } else if (action.type === 'Delete Sample') {
                // Restore the deleted sample
                samples.push(action.data.sample);
                alert('Undone: Delete Sample\nRestored sample: ' + action.data.sample.id);
            } else if (action.type === 'Complete Process') {
                // Restore sample to previous state
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.sampleId) {
                        samples[i] = JSON.parse(JSON.stringify(action.data.previousState));
                        break;
                    }
                }
                alert('Undone: Process completion for ' + action.data.sampleId);
            } else if (action.type === 'Batch Complete Process') {
                // Restore multiple samples
                for (var j = 0; j < action.data.samples.length; j++) {
                    var oldSample = action.data.samples[j];
                    for (var i = 0; i < samples.length; i++) {
                        if (samples[i].id === oldSample.id) {
                            samples[i] = JSON.parse(JSON.stringify(oldSample));
                            break;
                        }
                    }
                }
                alert('Undone: Batch process\nRestored ' + action.data.samples.length + ' samples');
            } else if (action.type === 'Edit Sample') {
                // Restore original values
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.newId || samples[i].id === action.data.originalId) {
                        samples[i].id = action.data.originalId;
                        samples[i].initials = action.data.originalInitials;
                        samples[i].status = action.data.originalStatus;
                        break;
                    }
                }
                alert('Undone: Edit\nRestored sample: ' + action.data.originalId);
            } else if (action.type === 'Change Flag') {
                // Restore original flag
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === action.data.sampleId) {
                        samples[i].flag = action.data.oldFlag;
                        break;
                    }
                }
                alert('Undone: Flag change for ' + action.data.sampleId);
            }

            saveData();
            renderSamples();
            updateUndoButton();
        }

        // Track recently used lot numbers
        function trackLotNumber(fieldName, value) {
            if (!value || value.trim() === '') return;

            if (!reagentLotHistory[fieldName]) {
                reagentLotHistory[fieldName] = [];
            }

            // Remove if already exists (move to front)
            var index = reagentLotHistory[fieldName].indexOf(value);
            if (index > -1) {
                reagentLotHistory[fieldName].splice(index, 1);
            }

            // Add to front, keep only last 5
            reagentLotHistory[fieldName].unshift(value);
            if (reagentLotHistory[fieldName].length > 5) {
                reagentLotHistory[fieldName].pop();
            }

            // Save to localStorage
            localStorage.setItem('reagentLotHistory', JSON.stringify(reagentLotHistory));
        }

        // Get recent lot numbers for autocomplete
        function getRecentLots(fieldName) {
            return reagentLotHistory[fieldName] || [];
        }

        // Add datalist for autocomplete to an input field
        function addAutocomplete(inputId, fieldName) {
            var input = document.getElementById(inputId);
            if (!input) return;

            var datalistId = inputId + 'List';
            var existingDatalist = document.getElementById(datalistId);
            if (existingDatalist) {
                existingDatalist.remove();
            }

            var datalist = document.createElement('datalist');
            datalist.id = datalistId;

            var recentLots = getRecentLots(fieldName);
            for (var i = 0; i < recentLots.length; i++) {
                var option = document.createElement('option');
                option.value = recentLots[i];
                datalist.appendChild(option);
            }

            document.body.appendChild(datalist);
            input.setAttribute('list', datalistId);
        }

        function createReferenceTable(sampleIds, sourceType, targetType, targetStartNumber) {
            var html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<tr style="background: #f5f5f5;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Sample ID</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Use ' + sourceType.toUpperCase() + '</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">New ' + targetType.toUpperCase() + '</th>';
            html += '</tr>';
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                var sourceNumber = 'N/A';
                var targetNumber = 'N/A';
                
                if (sourceType === 'bap' && sample && sample.bapNumber) {
                    sourceNumber = sample.bapNumber;
                } else if (sourceType === 'tsb' && sample && sample.tsbNumber) {
                    sourceNumber = sample.tsbNumber;
                } else if (sourceType === 'extraction' && sample && sample.extractionNumber) {
                    sourceNumber = sample.extractionNumber;
                } else if (sourceType === 'cleanExtraction' && sample && sample.cleanExtractionNumber) {
                    sourceNumber = sample.cleanExtractionNumber;
                } else if (sourceType === 'indexing' && sample && sample.indexingNumber) {
                    sourceNumber = sample.indexingNumber;
                }
                
                if (targetType === 'TSB') {
                    targetNumber = '25T' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Extraction') {
                    targetNumber = '25E' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Clean Extraction') {
                    targetNumber = '25CE' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Indexing') {
                    targetNumber = '25XT' + String(targetStartNumber + i).padStart(3, '0');
                } else if (targetType === 'Qubit') {
                    targetNumber = 'Qubit Analysis';
                }
                
                html += '<tr>';
                html += '<td style="padding: 8px; border: 1px solid #ddd;"><strong>' + sampleId + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #1976d2;"><strong>' + sourceNumber + '</strong></td>';
                html += '<td style="padding: 8px; border: 1px solid #ddd; color: #2e7d32;"><strong>' + targetNumber + '</strong></td>';
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            return html;
        }

        // Real-time duplicate check as user types
        function checkDuplicateRealtime(input) {
            var sampleId = input.value.trim();
            var warning = document.getElementById('duplicateWarning');

            if (!sampleId) {
                warning.style.display = 'none';
                input.style.border = '';
                input.style.background = '';
                return;
            }

            var isDuplicate = false;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    isDuplicate = true;
                    break;
                }
            }

            if (isDuplicate) {
                warning.style.display = 'inline';
                input.style.border = '2px solid #dc3545';
                input.style.background = '#ffe6e6';
            } else {
                warning.style.display = 'none';
                input.style.border = '2px solid #28a745';
                input.style.background = '#e6ffe6';
            }
        }

        function addSample(keepOpen) {
            var sampleId = document.getElementById('sampleId').value.trim();
            var initials = document.getElementById('initials').value.trim().toUpperCase();
            var feedbackDiv = document.getElementById('quickAddFeedback');

            if (!sampleId || !initials) {
                if (keepOpen && feedbackDiv) {
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.background = '#ffe6e6';
                    feedbackDiv.style.color = '#dc3545';
                    feedbackDiv.innerHTML = '‚ùå Please fill in both fields';
                    setTimeout(function() { feedbackDiv.style.display = 'none'; }, 2000);
                } else {
                    alert('Please fill in both fields');
                }
                return;
            }

            // Check for duplicates with detailed info
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    var existingSample = samples[i];

                    if (keepOpen && feedbackDiv) {
                        feedbackDiv.style.display = 'block';
                        feedbackDiv.style.background = '#ffe6e6';
                        feedbackDiv.style.color = '#dc3545';
                        feedbackDiv.innerHTML = '‚ùå Duplicate: ' + sampleId + ' already exists (added ' + existingSample.dateAdded + ')';
                    } else {
                        var msg = '‚ö†Ô∏è DUPLICATE SAMPLE ID\n\n';
                        msg += 'Sample ID: ' + sampleId + '\n';
                        msg += 'Already exists with:\n';
                        msg += '‚Ä¢ Status: ' + existingSample.status + '\n';
                        msg += '‚Ä¢ Added: ' + existingSample.dateAdded + '\n';
                        msg += '‚Ä¢ By: ' + existingSample.initials + '\n\n';
                        msg += 'Cannot add duplicate sample ID!';
                        alert(msg);
                    }

                    // Highlight the input field
                    var inputField = document.getElementById('sampleId');
                    inputField.style.border = '3px solid #dc3545';
                    inputField.style.background = '#ffe6e6';
                    setTimeout(function() {
                        inputField.style.border = '';
                        inputField.style.background = '';
                    }, 3000);

                    return;
                }
            }

            var newSample = {
                id: sampleId,
                initials: initials,
                status: 'Received',
                dateAdded: new Date().toLocaleDateString(),
                notes: '',
                flag: 'None',
                bapNumber: null,
                bapDetails: null,
                tsbNumber: null,
                tsbDetails: null,
                extractionNumber: null,
                extractionDetails: null,
                cleanExtractionNumber: null,
                cleanExtractionDetails: null,
                indexingNumber: null,
                indexingDetails: null,
                qubitDetails: null
            };

            samples.push(newSample);
            trackAction('Add Sample', {sampleIds: [sampleId]});
            saveData();
            renderSamples();

            if (keepOpen) {
                // Quick Add Mode: Keep initials, clear sample ID, show feedback, focus on ID field
                document.getElementById('sampleId').value = '';
                if (feedbackDiv) {
                    feedbackDiv.style.display = 'block';
                    feedbackDiv.style.background = '#e6ffe6';
                    feedbackDiv.style.color = '#28a745';
                    feedbackDiv.innerHTML = '‚úÖ Added: ' + sampleId + ' (' + samples.length + ' samples total)';
                    setTimeout(function() { feedbackDiv.style.display = 'none'; }, 2000);
                }
                document.getElementById('sampleId').focus();
            } else {
                // Normal mode: Clear both fields
                document.getElementById('sampleId').value = '';
                document.getElementById('initials').value = '';
            }
        }

        function toggleBulkInput() {
            var single = document.getElementById('singleInput');
            var bulk = document.getElementById('bulkInput');
            var btn = document.getElementById('toggleBulk');
            
            if (single.style.display === 'none') {
                single.style.display = 'block';
                bulk.style.display = 'none';
                btn.textContent = 'Switch to Bulk Input';
            } else {
                single.style.display = 'none';
                bulk.style.display = 'block';
                btn.textContent = 'Switch to Single Input';
            }
        }

        function addBulkSamples() {
            var text = document.getElementById('bulkSamples').value.trim();
            var initials = document.getElementById('bulkInitials').value.trim().toUpperCase();
            
            if (!text || !initials) {
                alert('Please enter initials and paste sample IDs');
                return;
            }
            
            var lines = text.split('\n');
            var sampleIds = [];
            
            // Clean up the input lines
            for (var i = 0; i < lines.length; i++) {
                var id = lines[i].trim();
                if (id.length > 0) {
                    sampleIds.push(id);
                }
            }
            
            if (sampleIds.length === 0) {
                alert('No valid sample IDs found');
                return;
            }
            
            var added = 0;
            var duplicates = [];
            
            for (var i = 0; i < sampleIds.length; i++) {
                var sampleId = sampleIds[i];
                
                // Check for duplicates
                var isDuplicate = false;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        duplicates.push(sampleId);
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    var newSample = {
                        id: sampleId,
                        initials: initials,
                        status: 'Received',
                        dateAdded: new Date().toLocaleDateString(),
                        notes: '',
                        flag: 'None',
                        bapNumber: null,
                        bapDetails: null,
                        tsbNumber: null,
                        tsbDetails: null,
                        extractionNumber: null,
                        extractionDetails: null,
                        cleanExtractionNumber: null,
                        cleanExtractionDetails: null,
                        indexingNumber: null,
                        indexingDetails: null,
                        qubitDetails: null
                    };
                    
                    samples.push(newSample);
                    added++;
                }
            }

            saveData();
            renderSamples();

            // Clear the form
            document.getElementById('bulkSamples').value = '';
            document.getElementById('bulkInitials').value = '';

            // Show results
            var message = 'Successfully added ' + added + ' new samples!';
            if (duplicates.length > 0) {
                message += '\n\nSkipped ' + duplicates.length + ' duplicates: ' + duplicates.join(', ');
            }
            alert(message);
        }

        function startProcess(sampleId, type) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentProcessType = type;
            var number = '';

            if (type === 'BAP') {
                number = '25B' + String(nextBapNumber).padStart(3, '0');
            } else if (type === 'TSB') {
                number = '25T' + String(nextTsbNumber).padStart(3, '0');
            } else if (type === 'Extraction') {
                number = '25E' + String(nextExtractionNumber).padStart(3, '0');
            } else if (type === 'Clean Extraction') {
                number = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
            } else if (type === 'Indexing') {
                number = '25XT' + String(nextIndexingNumber).padStart(3, '0');
            } else if (type === 'Qubit') {
                number = 'Qubit Analysis';
            }

            document.getElementById('modalTitle').textContent = 'Start ' + type;
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';

            showSpecificFields(type);
            document.getElementById('processModal').style.display = 'block';

            // Add autocomplete to lot number field
            setTimeout(function() {
                addAutocomplete('lotNumber', 'lotNumber');
            }, 100);
        }

        function finishProcess(sampleId, type) {
            // This function handles FINISHING incubation for BAP and TSB
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentProcessType = type + '_FINISH';
            var number = '';

            if (type === 'BAP') {
                number = sample.bapNumber || '';
            } else if (type === 'TSB') {
                number = sample.tsbNumber || '';
            }

            document.getElementById('modalTitle').textContent = 'Finish ' + type + ' Incubation';
            document.getElementById('modalSampleId').textContent = sampleId;
            document.getElementById('modalNumber').innerHTML = '<strong>' + number + '</strong>';

            // Pre-fill existing data from the start phase
            if (type === 'BAP' && sample.bapDetails) {
                document.getElementById('techInitials').value = sample.bapDetails.technician || '';
                document.getElementById('lotNumber').value = sample.bapDetails.lot || '';
                document.getElementById('temperature').value = sample.bapDetails.temperature || '37';
                document.getElementById('incubator').value = sample.bapDetails.incubator || 'INC-1';
                document.getElementById('timeIn').value = sample.bapDetails.timeIn || '';
                document.getElementById('stageNotes').value = sample.bapDetails.stageNotes || '';
            } else if (type === 'TSB' && sample.tsbDetails) {
                document.getElementById('techInitials').value = sample.tsbDetails.technician || '';
                document.getElementById('lotNumber').value = sample.tsbDetails.lot || '';
                document.getElementById('temperature').value = sample.tsbDetails.temperature || '37';
                document.getElementById('incubator').value = sample.tsbDetails.incubator || 'INC-1';
                document.getElementById('timeIn').value = sample.tsbDetails.timeIn || '';
                document.getElementById('stageNotes').value = sample.tsbDetails.stageNotes || '';
            }

            // Clear time out field and focus it
            document.getElementById('timeOut').value = '';

            showSpecificFields('');  // No specific fields needed for finish
            document.getElementById('processModal').style.display = 'block';

            // Focus on Time Out field after a brief delay
            setTimeout(function() {
                document.getElementById('timeOut').focus();
            }, 100);
        }

        function showSpecificFields(type) {
            var container = document.getElementById('specificFields');
            var html = '';
            
            if (type === 'TSB') {
                // Add BAP reference for TSB
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.bapDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã BAP Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use BAP:</strong> ' + sample.bapNumber + '</div>';
                    html += '<div><strong>BAP Tech:</strong> ' + sample.bapDetails.technician + '</div>';
                    html += '<div><strong>BAP Date:</strong> ' + sample.bapDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (type === 'Extraction') {
                // Add TSB reference for Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.tsbDetails) {
                    html += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #856404;">üß´ TSB Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use TSB:</strong> ' + sample.tsbNumber + '</div>';
                    html += '<div><strong>TSB Tech:</strong> ' + sample.tsbDetails.technician + '</div>';
                    html += '<div><strong>TSB Date:</strong> ' + sample.tsbDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add extraction-specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #7b1fa2;">Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Extraction Run:</label>';
                html += '<input type="text" id="extractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW1 Lot:</label>';
                html += '<input type="text" id="aw1Lot" placeholder="AW1LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">AW2 Lot:</label>';
                html += '<input type="text" id="aw2Lot" placeholder="AW2LOT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Ethanol Lot:</label>';
                html += '<input type="text" id="ethanolLot" placeholder="ETH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AL Lot:</label>';
                html += '<input type="text" id="bufferALLot" placeholder="AL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer ATL Lot:</label>';
                html += '<input type="text" id="bufferATLLot" placeholder="ATL123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Buffer AE Lot:</label>';
                html += '<input type="text" id="bufferAELot" placeholder="AE123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Proteinase K Lot:</label>';
                html += '<input type="text" id="proteinaseKLot" placeholder="PK123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">DNeasy Column Lot:</label>';
                html += '<input type="text" id="dneasyLot" placeholder="COL123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Clean Extraction') {
                // Add Extraction reference for Clean Extraction
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.extractionDetails) {
                    html += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #9c27b0;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Extraction:</strong> ' + sample.extractionNumber + '</div>';
                    html += '<div><strong>Extraction Tech:</strong> ' + sample.extractionDetails.technician + '</div>';
                    html += '<div><strong>Extraction Date:</strong> ' + sample.extractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add clean extraction specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #2e7d32;">Clean Extraction Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="storagePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                var nextWell = getNextWellPosition('cleanExtraction');
                html += '<input type="text" id="wellPosition" value="' + nextWell + '" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-incremented from last: ' + (lastWellPositions['cleanExtraction'] || 'none') + '</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Bead Lot:</label>';
                html += '<input type="text" id="beadLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O ETOH Dilution:</label>';
                html += '<input type="text" id="nfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH Dilution:</label>';
                html += '<input type="text" id="etohDilutionLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O Elution:</label>';
                html += '<input type="text" id="nfH2oElutionLot" placeholder="ELUT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Qubit Reagent:</label>';
                html += '<input type="text" id="qubitReagentLot" placeholder="QUBIT123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Cleanup Volume:</label>';
                html += '<input type="text" id="cleanupVolume" placeholder="1.2x" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution In:</label>';
                html += '<input type="text" id="elutionVolumeIn" placeholder="50uL" style="width: 80px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Elution Out:</label>';
                html += '<input type="text" id="elutionVolumeOut" placeholder="45uL" style="width: 80px;">';
                html += '</div>';
                
                html += '</div>';
            } else if (type === 'Indexing') {
                // Add Clean Extraction reference for Indexing
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.cleanExtractionDetails) {
                    html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
                    html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
                    html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Add indexing specific fields
                html += '<h4 style="margin: 20px 0 10px 0; color: #1976d2;">Indexing (XT) Details</h4>';
                
                html += '<div class="form-group">';
                html += '<label>Storage Plate:</label>';
                html += '<input type="text" id="indexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0;">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Well Position:</label>';
                var nextIndexWell = getNextWellPosition('indexing');
                html += '<input type="text" id="indexingWellPosition" value="' + nextIndexWell + '" style="width: 80px;">';
                html += '<small style="color: #666; margin-left: 10px;">Auto-incremented from last: ' + (lastWellPositions['indexing'] || 'none') + '</small>';
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Index Assignment:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Index:</label>';
                html += '<input type="text" id="i5Index" placeholder="i5-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Index:</label>';
                html += '<input type="text" id="i7Index" placeholder="i7-001" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i5 Thaws:</label>';
                html += '<input type="number" id="i5Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">i7 Thaws:</label>';
                html += '<input type="number" id="i7Thaws" placeholder="1" min="0" style="width: 60px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">TD Buffer:</label>';
                html += '<input type="text" id="tdBufferLot" placeholder="TD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">ATM Buffer:</label>';
                html += '<input type="text" id="atmBufferLot" placeholder="ATM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NT Buffer:</label>';
                html += '<input type="text" id="ntBufferLot" placeholder="NT123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NPM:</label>';
                html += '<input type="text" id="npmLot" placeholder="NPM123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Resuspension Buffer:</label>';
                html += '<input type="text" id="resuspensionBufferLot" placeholder="RES123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Indexes Kit:</label>';
                html += '<input type="text" id="indexesKitLot" placeholder="IDX123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Beads:</label>';
                html += '<input type="text" id="indexingBeadsLot" placeholder="BEAD123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">EtOH:</label>';
                html += '<input type="text" id="indexingEtohLot" placeholder="ETOH123" style="width: 120px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">NF H2O:</label>';
                html += '<input type="text" id="indexingNfH2oLot" placeholder="H2O123" style="width: 120px;">';
                html += '</div>';
                
                html += '</div>';
                
                html += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Double-Sided Clean Up:</h5>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 1 Concentrations:</label>';
                html += '<input type="text" id="cleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;">';
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 8px;">';
                html += '<label style="font-size: 12px;">Step 2 Concentrations:</label>';
                html += '<input type="text" id="cleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;">';
                html += '</div>';
                
                html += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    // Add Clean Extraction reference for Clean Extraction Qubit
    var sampleId = document.getElementById('modalSampleId').textContent;
    var sample = null;
    for (var i = 0; i < samples.length; i++) {
        if (samples[i].id === sampleId) {
            sample = samples[i];
            break;
        }
    }
    
    if (sample && sample.cleanExtractionDetails) {
        html += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #4caf50;">';
        html += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reference</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
        html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
        html += '<div><strong>Use Clean Extraction:</strong> ' + sample.cleanExtractionNumber + '</div>';
        html += '<div><strong>Clean Extraction Tech:</strong> ' + sample.cleanExtractionDetails.technician + '</div>';
        html += '<div><strong>Clean Extraction Date:</strong> ' + sample.cleanExtractionDetails.completedDate + '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    // Add Clean Extraction Qubit-specific fields
    html += '<h4 style="margin: 20px 0 10px 0; color: #1565c0;">üìä Clean Extraction Qubit Analysis</h4>';
    
    html += '<div class="form-group">';
    html += '<label>Concentration (ng/uL):</label>';
    html += '<input type="number" id="qubitConcentration" step="0.1" onchange="validateQubitValue(this, \'cleanExtractionQubit\')">';
    html += '<div id="qubitValidation" style="margin-top: 5px; font-size: 12px;"></div>';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Qubit Reagent Lot:</label>';
    html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
    html += '</div>';
    
    html += '<div class="form-group">';
    html += '<label>Date Qubited:</label>';
    html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    html += '</div>';
            } else if (type === 'Final Qubit') {
                            // Add Indexing reference for Qubit
                var sampleId = document.getElementById('modalSampleId').textContent;
                var sample = null;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        sample = samples[i];
                        break;
                    }
                }
                
                if (sample && sample.indexingDetails) {
                    html += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2196f3;">';
                    html += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing Reference</h4>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">';
                    html += '<div><strong>Sample:</strong> ' + sample.id + '</div>';
                    html += '<div><strong>Use Indexing:</strong> ' + sample.indexingNumber + '</div>';
                    html += '<div><strong>Indexing Tech:</strong> ' + sample.indexingDetails.technician + '</div>';
                    html += '<div><strong>Indexing Date:</strong> ' + sample.indexingDetails.completedDate + '</div>';
                    if (sample.indexingDetails.i5 && sample.indexingDetails.i7) {
                        html += '<div><strong>i5 Index:</strong> ' + sample.indexingDetails.i5 + '</div>';
                        html += '<div><strong>i7 Index:</strong> ' + sample.indexingDetails.i7 + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
                
                html += '<h4 style="margin: 20px 0 10px 0; color: #f57c00;">üìä Qubit Analysis</h4>';

html += '<div class="form-group">';
html += '<label>Concentration (ng/uL):</label>';
html += '<input type="number" id="qubitConcentration" step="0.1" onchange="validateQubitValue(this, \'finalQubit\')">';
html += '<div id="qubitValidation" style="margin-top: 5px; font-size: 12px;"></div>';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Qubit Reagent Lot:</label>';
html += '<input type="text" id="qubitReagentLot" placeholder="QR123">';
html += '</div>';

html += '<div class="form-group">';
html += '<label>Date Qubited:</label>';
html += '<input type="date" id="qubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
html += '</div>';
            }

            container.innerHTML = html;

            // Add autocomplete to all reagent lot fields after a short delay
            setTimeout(function() {
                // Extraction reagent lots
                addAutocomplete('aw1Lot', 'aw1Lot');
                addAutocomplete('aw2Lot', 'aw2Lot');
                addAutocomplete('ethanolLot', 'ethanolLot');
                addAutocomplete('bufferALLot', 'bufferALLot');
                addAutocomplete('bufferATLLot', 'bufferATLLot');
                addAutocomplete('bufferAELot', 'bufferAELot');
                addAutocomplete('proteinaseKLot', 'proteinaseKLot');
                addAutocomplete('dneasyLot', 'dneasyLot');

                // Clean Extraction reagent lots
                addAutocomplete('beadLot', 'beadLot');
                addAutocomplete('nfH2oEtohLot', 'nfH2oEtohLot');
                addAutocomplete('etohDilutionLot', 'etohDilutionLot');
                addAutocomplete('nfH2oElutionLot', 'nfH2oElutionLot');
                addAutocomplete('qubitReagentLot', 'qubitReagentLot');

                // Indexing reagent lots
                addAutocomplete('tdBufferLot', 'tdBufferLot');
                addAutocomplete('atmBufferLot', 'atmBufferLot');
                addAutocomplete('ntBufferLot', 'ntBufferLot');
                addAutocomplete('npmLot', 'npmLot');
                addAutocomplete('resuspensionBufferLot', 'resuspensionBufferLot');
                addAutocomplete('indexesKitLot', 'indexesKitLot');
                addAutocomplete('indexingBeadsLot', 'indexingBeadsLot');
                addAutocomplete('indexingEtohLot', 'indexingEtohLot');
                addAutocomplete('indexingNfH2oLot', 'indexingNfH2oLot');
            }, 100);
        }

        function completeProcess() {
            var tech = document.getElementById('techInitials').value.trim();
            var lot = document.getElementById('lotNumber').value.trim();
            var temp = document.getElementById('temperature').value;
            var inc = document.getElementById('incubator').value;
            var timeIn = document.getElementById('timeIn').value;
            var timeOut = document.getElementById('timeOut').value;
            var stageNotes = document.getElementById('stageNotes').value.trim();

            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }
            
            var sampleId = document.getElementById('modalSampleId').textContent;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            
            if (sample) {
                var today = new Date().toLocaleDateString();
                
                if (currentProcessType === 'BAP') {
                    // START BAP - Starting incubation
                    if (!timeIn) {
                        alert('Please enter Time In to start incubation');
                        return;
                    }
                    sample.bapNumber = '25B' + String(nextBapNumber).padStart(3, '0');
                    sample.status = 'BAP In Progress';
                    sample.bapDetails = {
                        technician: tech,
                        lot: lot,
                        startedDate: today,
                        temperature: temp,
                        incubator: inc,
                        timeIn: timeIn,
                        timeOut: '',
                        stageNotes: stageNotes
                    };
                    nextBapNumber++;
                    trackAction('process', sample.id, 'Started BAP incubation');
                } else if (currentProcessType === 'BAP_FINISH') {
                    // FINISH BAP - Finishing incubation
                    if (!timeOut) {
                        alert('Please enter Time Out to finish incubation');
                        return;
                    }
                    sample.status = 'BAP Complete';
                    sample.bapDetails.timeOut = timeOut;
                    sample.bapDetails.completedDate = today;
                    // Update stage notes if changed
                    if (stageNotes) {
                        sample.bapDetails.stageNotes = stageNotes;
                    }
                    trackAction('process', sample.id, 'Finished BAP incubation');
                } else if (currentProcessType === 'TSB') {
                    // START TSB - Starting incubation
                    if (!timeIn) {
                        alert('Please enter Time In to start incubation');
                        return;
                    }
                    sample.tsbNumber = '25T' + String(nextTsbNumber).padStart(3, '0');
                    sample.status = 'TSB In Progress';
                    sample.tsbDetails = {
                        technician: tech,
                        lot: lot,
                        startedDate: today,
                        temperature: temp,
                        incubator: inc,
                        timeIn: timeIn,
                        timeOut: '',
                        stageNotes: stageNotes
                    };
                    nextTsbNumber++;
                    trackAction('process', sample.id, 'Started TSB incubation');
                } else if (currentProcessType === 'TSB_FINISH') {
                    // FINISH TSB - Finishing incubation
                    if (!timeOut) {
                        alert('Please enter Time Out to finish incubation');
                        return;
                    }
                    sample.status = 'TSB Complete';
                    sample.tsbDetails.timeOut = timeOut;
                    sample.tsbDetails.completedDate = today;
                    // Update stage notes if changed
                    if (stageNotes) {
                        sample.tsbDetails.stageNotes = stageNotes;
                    }
                    trackAction('process', sample.id, 'Finished TSB incubation');
                } else if (currentProcessType === 'Extraction') {
                    sample.extractionNumber = '25E' + String(nextExtractionNumber).padStart(3, '0');
                    sample.status = 'Extraction Complete';
                    sample.extractionDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        extractionRun: document.getElementById('extractionRun').value,
                        reagentLots: {
                            aw1: document.getElementById('aw1Lot').value,
                            aw2: document.getElementById('aw2Lot').value,
                            ethanol: document.getElementById('ethanolLot').value,
                            bufferAL: document.getElementById('bufferALLot').value,
                            bufferATL: document.getElementById('bufferATLLot').value,
                            bufferAE: document.getElementById('bufferAELot').value,
                            proteinaseK: document.getElementById('proteinaseKLot').value,
                            dneasy: document.getElementById('dneasyLot').value
                        },
                        stageNotes: stageNotes
                    };
                    nextExtractionNumber++;
                    if (nextExtractionNumber % 24 === 1) {
                        nextExtractionRun++;
                    }
                } else if (currentProcessType === 'Clean Extraction') {
                    sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber).padStart(3, '0');
                    sample.status = 'Clean Extraction Complete';
                    var ceWellPos = document.getElementById('wellPosition').value;
                    sample.cleanExtractionDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        storagePlate: document.getElementById('storagePlate').value,
                        wellPosition: ceWellPos,
                        reagentLots: {
                            bead: document.getElementById('beadLot').value,
                            nfH2oEtoh: document.getElementById('nfH2oEtohLot').value,
                            etohDilution: document.getElementById('etohDilutionLot').value,
                            nfH2oElution: document.getElementById('nfH2oElutionLot').value,
                            qubitReagent: document.getElementById('qubitReagentLot').value
                        },
                        volumes: {
                            cleanup: document.getElementById('cleanupVolume').value,
                            elutionIn: document.getElementById('elutionVolumeIn').value,
                            elutionOut: document.getElementById('elutionVolumeOut').value
                        },
                        stageNotes: stageNotes
                    };
                    trackWellPosition('cleanExtraction', ceWellPos);
                    nextCleanExtractionNumber++;
                    nextCleanExtractionPlate++;
                } else if (currentProcessType === 'Indexing') {
                    sample.indexingNumber = '25XT' + String(nextIndexingNumber).padStart(3, '0');
                    sample.status = 'Indexing Complete';
                    var indexWellPos = document.getElementById('indexingWellPosition').value;
                    sample.indexingDetails = {
                        technician: tech,
                        lot: lot,
                        completedDate: today,
                        storagePlate: document.getElementById('indexingStoragePlate').value,
                        wellPosition: indexWellPos,
                        indexes: {
                            i5: document.getElementById('i5Index').value,
                            i7: document.getElementById('i7Index').value,
                            i5Thaws: document.getElementById('i5Thaws').value,
                            i7Thaws: document.getElementById('i7Thaws').value
                        },
                        reagentLots: {
                            tdBuffer: document.getElementById('tdBufferLot').value,
                            atmBuffer: document.getElementById('atmBufferLot').value,
                            ntBuffer: document.getElementById('ntBufferLot').value,
                            npm: document.getElementById('npmLot').value,
                            resuspensionBuffer: document.getElementById('resuspensionBufferLot').value,
                            indexesKit: document.getElementById('indexesKitLot').value,
                            beads: document.getElementById('indexingBeadsLot').value,
                            etoh: document.getElementById('indexingEtohLot').value,
                            nfH2o: document.getElementById('indexingNfH2oLot').value
                        },
                        cleanupConcentrations: {
                            step1: document.getElementById('cleanup1Concentrations').value,
                            step2: document.getElementById('cleanup2Concentrations').value
                        },
                        stageNotes: stageNotes
                    };
                    trackWellPosition('indexing', indexWellPos);
                    nextIndexingNumber++;
                    nextIndexingPlate++;
                } else if (currentProcessType === 'Clean Extraction Qubit') {
                    sample.status = 'Clean Extraction Qubit Complete';
                    sample.cleanExtractionQubitDetails = {
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today,
                        stageNotes: stageNotes
                    };
                } else if (currentProcessType === 'Final Qubit') {
                    sample.status = 'Qubit Complete';
                    sample.qubitDetails = {
                        concentration: document.getElementById('qubitConcentration').value,
                        reagentLot: document.getElementById('qubitReagentLot').value,
                        dateQubited: document.getElementById('qubitDate').value,
                        technician: tech,
                        completedDate: today,
                        stageNotes: stageNotes
                    };
                }

                // Track all lot numbers used in this process
                trackLotNumber('lotNumber', lot);

                if (currentProcessType === 'Extraction') {
                    trackLotNumber('aw1Lot', document.getElementById('aw1Lot').value);
                    trackLotNumber('aw2Lot', document.getElementById('aw2Lot').value);
                    trackLotNumber('ethanolLot', document.getElementById('ethanolLot').value);
                    trackLotNumber('bufferALLot', document.getElementById('bufferALLot').value);
                    trackLotNumber('bufferATLLot', document.getElementById('bufferATLLot').value);
                    trackLotNumber('bufferAELot', document.getElementById('bufferAELot').value);
                    trackLotNumber('proteinaseKLot', document.getElementById('proteinaseKLot').value);
                    trackLotNumber('dneasyLot', document.getElementById('dneasyLot').value);
                } else if (currentProcessType === 'Clean Extraction') {
                    trackLotNumber('beadLot', document.getElementById('beadLot').value);
                    trackLotNumber('nfH2oEtohLot', document.getElementById('nfH2oEtohLot').value);
                    trackLotNumber('etohDilutionLot', document.getElementById('etohDilutionLot').value);
                    trackLotNumber('nfH2oElutionLot', document.getElementById('nfH2oElutionLot').value);
                    trackLotNumber('qubitReagentLot', document.getElementById('qubitReagentLot').value);
                } else if (currentProcessType === 'Indexing') {
                    trackLotNumber('tdBufferLot', document.getElementById('tdBufferLot').value);
                    trackLotNumber('atmBufferLot', document.getElementById('atmBufferLot').value);
                    trackLotNumber('ntBufferLot', document.getElementById('ntBufferLot').value);
                    trackLotNumber('npmLot', document.getElementById('npmLot').value);
                    trackLotNumber('resuspensionBufferLot', document.getElementById('resuspensionBufferLot').value);
                    trackLotNumber('indexesKitLot', document.getElementById('indexesKitLot').value);
                    trackLotNumber('indexingBeadsLot', document.getElementById('indexingBeadsLot').value);
                    trackLotNumber('indexingEtohLot', document.getElementById('indexingEtohLot').value);
                    trackLotNumber('indexingNfH2oLot', document.getElementById('indexingNfH2oLot').value);
                } else if (currentProcessType === 'Clean Extraction Qubit' || currentProcessType === 'Final Qubit') {
                    trackLotNumber('qubitReagentLot', document.getElementById('qubitReagentLot').value);
                }

                saveData();
                renderSamples();
                closeModal();
                alert(currentProcessType + ' completed!');
            }
        }

        function startBatchProcess() {
            console.log('Batch process started');
            
            var receivedSamples = [];
            var bapSamples = [];
            var tsbSamples = [];
            var extractionSamples = [];
            var cleanExtractionSamples = [];
            var indexingSamples = [];
            var cleanExtractionQubitSamples = [];
            
            for (var i = 0; i < selectedSamples.length; i++) {
                var id = selectedSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === id) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
    if (sample.status === 'Received') receivedSamples.push(id);
    else if (sample.status === 'BAP Complete') bapSamples.push(id);
    else if (sample.status === 'TSB Complete') tsbSamples.push(id);
    else if (sample.status === 'Extraction Complete') extractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Complete') cleanExtractionSamples.push(id);
    else if (sample.status === 'Clean Extraction Qubit Complete') cleanExtractionQubitSamples.push(id);
    else if (sample.status === 'Indexing Complete') indexingSamples.push(id);
}
            }
            
            console.log('Batch counts: received=' + receivedSamples.length + ' indexing=' + indexingSamples.length);
            
            if (receivedSamples.length >= 2) {
    openBatchModal(receivedSamples, 'BAP');
} else if (bapSamples.length >= 2) {
    openBatchModal(bapSamples, 'TSB');
} else if (tsbSamples.length >= 2) {
    openBatchModal(tsbSamples, 'Extraction');
} else if (extractionSamples.length >= 2) {
    openBatchModal(extractionSamples, 'Clean Extraction');
} else if (cleanExtractionSamples.length >= 2) {
    openBatchModal(cleanExtractionSamples, 'Clean Extraction Qubit');
} else if (cleanExtractionQubitSamples.length >= 2) {
    openBatchModal(cleanExtractionQubitSamples, 'Indexing');
} else if (indexingSamples.length >= 2) {
    openBatchModal(indexingSamples, 'Final Qubit');
} else {
    alert('Please select samples of the same type');
}
        }

        function openBatchModal(sampleIds, type) {
            console.log('Opening batch modal for type: ' + type);
            currentBatchSamples = sampleIds;
            currentBatchType = type;
            
            document.getElementById('batchModalTitle').textContent = 'Batch ' + type;
            document.getElementById('batchSampleCount').textContent = sampleIds.length;
            
            var numbersHtml = '<strong>Processing ' + sampleIds.length + ' samples</strong>';
            
            // Add reference tables for each workflow step
            if (type === 'TSB') {
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã BAP ‚Üí TSB Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'bap', 'TSB', nextTsbNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the BAP plates listed above for each corresponding TSB</p>';
                numbersHtml += '</div>';
            } else if (type === 'Extraction') {
                numbersHtml += '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ffc107;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #856404;">üß´ TSB ‚Üí Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'tsb', 'Extraction', nextExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the TSB plates listed above for each corresponding Extraction</p>';
                numbersHtml += '</div>';
                
                // Add extraction reagent fields
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction Reagent Lots</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Extraction Run:</label>';
                numbersHtml += '<input type="text" id="batchExtractionRun" value="25-' + nextExtractionRun + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW1 Lot:</label><input type="text" id="batchAw1Lot" placeholder="AW1LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">AW2 Lot:</label><input type="text" id="batchAw2Lot" placeholder="AW2LOT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Ethanol Lot:</label><input type="text" id="batchEthanolLot" placeholder="ETH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AL Lot:</label><input type="text" id="batchBufferALLot" placeholder="AL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer ATL Lot:</label><input type="text" id="batchBufferATLLot" placeholder="ATL123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Buffer AE Lot:</label><input type="text" id="batchBufferAELot" placeholder="AE123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Proteinase K Lot:</label><input type="text" id="batchProteinaseKLot" placeholder="PK123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">DNeasy Column Lot:</label><input type="text" id="batchDneasyLot" placeholder="COL123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Clean Extraction') {
                numbersHtml += '<div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #9c27b0;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #7b1fa2;">üß¨ Extraction ‚Üí Clean Extraction Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'extraction', 'Clean Extraction', nextCleanExtractionNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Extraction plates listed above for each corresponding Clean Extraction</p>';
                numbersHtml += '</div>';
                
                // Add clean extraction reagent fields
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction Reagents & Volumes</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchStoragePlate" value="25CEP' + String(nextCleanExtractionPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Bead Lot:</label><input type="text" id="batchBeadLot" placeholder="BEAD123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O ETOH:</label><input type="text" id="batchNfH2oEtohLot" placeholder="NFH2O123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">EtOH Dilution:</label><input type="text" id="batchEtohDilutionLot" placeholder="ETOH123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">NF H2O Elution:</label><input type="text" id="batchNfH2oElutionLot" placeholder="ELUT123" style="width: 120px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Qubit Reagent:</label><input type="text" id="batchQubitReagentLot" placeholder="QUBIT123" style="width: 120px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Volumes:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Cleanup Volume:</label><input type="text" id="batchCleanupVolume" placeholder="1.2x" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution In:</label><input type="text" id="batchElutionVolumeIn" placeholder="50uL" style="width: 80px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Elution Out:</label><input type="text" id="batchElutionVolumeOut" placeholder="45uL" style="width: 80px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
            } else if (type === 'Indexing') {
                numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction ‚Üí Indexing Reference</h4>';
                numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Indexing', nextIndexingNumber);
                numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Indexing</p>';
                numbersHtml += '</div>';
                
                // Add indexing reagent fields with well positions and indexes
                numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
                numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing (XT) Details</h4>';
                numbersHtml += '<div class="form-group">';
                numbersHtml += '<label>Storage Plate:</label>';
                numbersHtml += '<input type="text" id="batchIndexingStoragePlate" value="25XLP' + String(nextIndexingPlate).padStart(2, '0') + '" readonly style="background-color: #f0f0f0; width: 100px;">';
                numbersHtml += '</div>';
                
                // Well positions and indexes for each sample
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Well Positions & Indexes (unique per sample):</h5>';
                numbersHtml += '<div id="batchIndexingWellPositions" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 200px; overflow-y: auto;">';
                
                for (var i = 0; i < sampleIds.length; i++) {
                    var sampleId = sampleIds[i];
                    var autoWell = generateWellPosition(i);
                    numbersHtml += '<div style="display: grid; grid-template-columns: 100px 60px 80px 80px 40px 40px; gap: 5px; align-items: center; margin-bottom: 8px; padding: 5px; background: white; border-radius: 4px;">';
                    numbersHtml += '<span style="font-weight: bold; font-size: 11px;">' + sampleId + '</span>';
                    numbersHtml += '<input type="text" id="batchIndexingWell_' + i + '" value="' + autoWell + '" style="width: 50px; font-size: 11px;" placeholder="A01">';
                    numbersHtml += '<input type="text" id="batchI5Index_' + i + '" placeholder="i5-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="text" id="batchI7Index_' + i + '" placeholder="i7-001" style="width: 70px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI5Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '<input type="number" id="batchI7Thaws_' + i + '" placeholder="1" min="0" style="width: 35px; font-size: 11px;">';
                    numbersHtml += '</div>';
                }
                
                numbersHtml += '</div>';
                numbersHtml += '<small style="color: #666; font-size: 11px;">Each sample needs unique i5/i7 combination</small>';
                
                // Shared reagent lots
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Shared Reagent Lots:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">TD Buffer:</label><input type="text" id="batchTdBufferLot" placeholder="TD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">ATM Buffer:</label><input type="text" id="batchAtmBufferLot" placeholder="ATM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NT Buffer:</label><input type="text" id="batchNtBufferLot" placeholder="NT123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NPM:</label><input type="text" id="batchNpmLot" placeholder="NPM123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Resuspension Buffer:</label><input type="text" id="batchResuspensionBufferLot" placeholder="RES123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Indexes Kit:</label><input type="text" id="batchIndexesKitLot" placeholder="IDX123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">Beads:</label><input type="text" id="batchIndexingBeadsLot" placeholder="BEAD123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">EtOH:</label><input type="text" id="batchIndexingEtohLot" placeholder="ETOH123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 6px;"><label style="font-size: 11px;">NF H2O:</label><input type="text" id="batchIndexingNfH2oLot" placeholder="H2O123" style="width: 100px; font-size: 11px;"></div>';
                numbersHtml += '</div>';
                
                // Cleanup concentrations
                numbersHtml += '<h5 style="margin: 15px 0 5px 0; font-size: 14px;">Cleanup Concentrations:</h5>';
                numbersHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 1:</label><input type="text" id="batchCleanup1Concentrations" placeholder="0.5x/1x (40uL + 20uL)" style="width: 160px;"></div>';
                numbersHtml += '<div class="form-group" style="margin-bottom: 8px;"><label style="font-size: 12px;">Step 2:</label><input type="text" id="batchCleanup2Concentrations" placeholder="55uL + 15uL beads" style="width: 160px;"></div>';
                numbersHtml += '</div>';
                numbersHtml += '</div>';
                } else if (type === 'Clean Extraction Qubit') {
    numbersHtml += '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #4caf50;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #2e7d32;">üßΩ Clean Extraction ‚Üí Clean Extraction Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'cleanExtraction', 'Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Clean Extraction plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Clean Extraction Qubit specific fields
    numbersHtml += '<div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #1565c0;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1565c0;">üìä Batch Clean Extraction Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchCleanExtractionQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchCleanExtractionQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
            } else if (type === 'Final Qubit') {
    numbersHtml += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #2196f3;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">üî¨ Indexing ‚Üí Qubit Reference</h4>';
    numbersHtml += createReferenceTable(sampleIds, 'indexing', 'Final Qubit', 0);
    numbersHtml += '<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Use the Indexing plates listed above for each corresponding Qubit</p>';
    numbersHtml += '</div>';
    
    // Add batch Qubit specific fields
    numbersHtml += '<div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #ff9800;">';
    numbersHtml += '<h4 style="margin: 0 0 10px 0; color: #f57c00;">üìä Batch Final Qubit Details</h4>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Qubit Reagent Lot:</label>';
    numbersHtml += '<input type="text" id="batchQubitReagentLot" placeholder="QR123">';
    numbersHtml += '</div>';
    numbersHtml += '<div class="form-group">';
    numbersHtml += '<label>Date Qubited:</label>';
    numbersHtml += '<input type="date" id="batchQubitDate" value="' + new Date().toISOString().split('T')[0] + '">';
    numbersHtml += '</div>';
    numbersHtml += '</div>';
}
            
            document.getElementById('batchNumbers').innerHTML = numbersHtml;
            document.getElementById('batchModal').style.display = 'block';
        }

        function completeBatchProcess() {
            var tech = document.getElementById('batchTechInitials').value.trim();
            var lot = document.getElementById('batchLotNumber').value.trim();
            var temp = document.getElementById('batchTemperature').value;
            var inc = document.getElementById('batchIncubator').value;
            var timeIn = document.getElementById('batchTimeIn').value;
            var timeOut = document.getElementById('batchTimeOut').value;

            if (!tech || !lot) {
                alert('Please fill in required fields');
                return;
            }

            var today = new Date().toLocaleDateString();
            
            for (var i = 0; i < currentBatchSamples.length; i++) {
                var sampleId = currentBatchSamples[i];
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }
                
                if (sample) {
                    if (currentBatchType === 'BAP') {
                        sample.bapNumber = '25B' + String(nextBapNumber + i).padStart(3, '0');
                        sample.status = 'BAP Complete';
                        sample.bapDetails = {
                            technician: tech,
                            lot: lot,
                            completedDate: today,
                            temperature: temp,
                            incubator: inc,
                            timeIn: timeIn,
                            timeOut: timeOut
                        };
                    } else if (currentBatchType === 'TSB') {
                        sample.tsbNumber = '25T' + String(nextTsbNumber + i).padStart(3, '0');
                        sample.status = 'TSB Complete';
                        sample.tsbDetails = {
                            technician: tech,
                            lot: lot,
                            completedDate: today,
                            temperature: temp,
                            incubator: inc,
                            timeIn: timeIn,
                            timeOut: timeOut
                        };
                    } else if (currentBatchType === 'Extraction') {
                        sample.extractionNumber = '25E' + String(nextExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Extraction Complete';
                        sample.extractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            extractionRun: document.getElementById('batchExtractionRun') ? document.getElementById('batchExtractionRun').value : '25-' + nextExtractionRun,
                            reagentLots: {
                                aw1: document.getElementById('batchAw1Lot') ? document.getElementById('batchAw1Lot').value : '',
                                aw2: document.getElementById('batchAw2Lot') ? document.getElementById('batchAw2Lot').value : '',
                                ethanol: document.getElementById('batchEthanolLot') ? document.getElementById('batchEthanolLot').value : '',
                                bufferAL: document.getElementById('batchBufferALLot') ? document.getElementById('batchBufferALLot').value : '',
                                bufferATL: document.getElementById('batchBufferATLLot') ? document.getElementById('batchBufferATLLot').value : '',
                                bufferAE: document.getElementById('batchBufferAELot') ? document.getElementById('batchBufferAELot').value : '',
                                proteinaseK: document.getElementById('batchProteinaseKLot') ? document.getElementById('batchProteinaseKLot').value : '',
                                dneasy: document.getElementById('batchDneasyLot') ? document.getElementById('batchDneasyLot').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Clean Extraction') {
                        sample.cleanExtractionNumber = '25CE' + String(nextCleanExtractionNumber + i).padStart(3, '0');
                        sample.status = 'Clean Extraction Complete';
                        sample.cleanExtractionDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchStoragePlate') ? document.getElementById('batchStoragePlate').value : '25CEP' + String(nextCleanExtractionPlate).padStart(2, '0'),
                            wellPosition: generateWellPosition(i),
                            reagentLots: {
                                bead: document.getElementById('batchBeadLot') ? document.getElementById('batchBeadLot').value : '',
                                nfH2oEtoh: document.getElementById('batchNfH2oEtohLot') ? document.getElementById('batchNfH2oEtohLot').value : '',
                                etohDilution: document.getElementById('batchEtohDilutionLot') ? document.getElementById('batchEtohDilutionLot').value : '',
                                nfH2oElution: document.getElementById('batchNfH2oElutionLot') ? document.getElementById('batchNfH2oElutionLot').value : '',
                                qubitReagent: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : ''
                            },
                            volumes: {
                                cleanup: document.getElementById('batchCleanupVolume') ? document.getElementById('batchCleanupVolume').value : '',
                                elutionIn: document.getElementById('batchElutionVolumeIn') ? document.getElementById('batchElutionVolumeIn').value : '',
                                elutionOut: document.getElementById('batchElutionVolumeOut') ? document.getElementById('batchElutionVolumeOut').value : ''
                            }
                        };
                        } else if (currentBatchType === 'Clean Extraction Qubit') {
    sample.status = 'Clean Extraction Qubit Complete';
    sample.cleanExtractionQubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchCleanExtractionQubitReagentLot') ? document.getElementById('batchCleanExtractionQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchCleanExtractionQubitDate') ? document.getElementById('batchCleanExtractionQubitDate').value : today
    };
                    } else if (currentBatchType === 'Indexing') {
                        sample.indexingNumber = '25XT' + String(nextIndexingNumber + i).padStart(3, '0');
                        sample.status = 'Indexing Complete';
                        
                        // Get custom well position and indexes from inputs
                        var wellPosition = generateWellPosition(i);
                        var wellInput = document.getElementById('batchIndexingWell_' + i);
                        if (wellInput && wellInput.value.trim()) {
                            wellPosition = wellInput.value.trim().toUpperCase();
                        }
                        
                        var i5Index = document.getElementById('batchI5Index_' + i) ? document.getElementById('batchI5Index_' + i).value : '';
                        var i7Index = document.getElementById('batchI7Index_' + i) ? document.getElementById('batchI7Index_' + i).value : '';
                        var i5Thaws = document.getElementById('batchI5Thaws_' + i) ? document.getElementById('batchI5Thaws_' + i).value : '1';
                        var i7Thaws = document.getElementById('batchI7Thaws_' + i) ? document.getElementById('batchI7Thaws_' + i).value : '1';
                        
                        sample.indexingDetails = { 
                            technician: tech, 
                            lot: lot, 
                            completedDate: today,
                            storagePlate: document.getElementById('batchIndexingStoragePlate') ? document.getElementById('batchIndexingStoragePlate').value : '25XLP' + String(nextIndexingPlate).padStart(2, '0'),
                            wellPosition: wellPosition,
                            indexes: {
                                i5: i5Index,
                                i7: i7Index,
                                i5Thaws: i5Thaws,
                                i7Thaws: i7Thaws
                            },
                            reagentLots: {
                                tdBuffer: document.getElementById('batchTdBufferLot') ? document.getElementById('batchTdBufferLot').value : '',
                                atmBuffer: document.getElementById('batchAtmBufferLot') ? document.getElementById('batchAtmBufferLot').value : '',
                                ntBuffer: document.getElementById('batchNtBufferLot') ? document.getElementById('batchNtBufferLot').value : '',
                                npm: document.getElementById('batchNpmLot') ? document.getElementById('batchNpmLot').value : '',
                                resuspensionBuffer: document.getElementById('batchResuspensionBufferLot') ? document.getElementById('batchResuspensionBufferLot').value : '',
                                indexesKit: document.getElementById('batchIndexesKitLot') ? document.getElementById('batchIndexesKitLot').value : '',
                                beads: document.getElementById('batchIndexingBeadsLot') ? document.getElementById('batchIndexingBeadsLot').value : '',
                                etoh: document.getElementById('batchIndexingEtohLot') ? document.getElementById('batchIndexingEtohLot').value : '',
                                nfH2o: document.getElementById('batchIndexingNfH2oLot') ? document.getElementById('batchIndexingNfH2oLot').value : ''
                            },
                            cleanupConcentrations: {
                                step1: document.getElementById('batchCleanup1Concentrations') ? document.getElementById('batchCleanup1Concentrations').value : '',
                                step2: document.getElementById('batchCleanup2Concentrations') ? document.getElementById('batchCleanup2Concentrations').value : ''
                            }
                        };
                    } else if (currentBatchType === 'Final Qubit') {
    sample.status = 'Qubit Complete';
    sample.qubitDetails = { 
        technician: tech, 
        completedDate: today, 
        concentration: '0.0',
        reagentLot: document.getElementById('batchQubitReagentLot') ? document.getElementById('batchQubitReagentLot').value : '',
        dateQubited: document.getElementById('batchQubitDate') ? document.getElementById('batchQubitDate').value : today
    };
}
                }
            }
            
            if (currentBatchType === 'BAP') nextBapNumber += currentBatchSamples.length;
            else if (currentBatchType === 'TSB') nextTsbNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Extraction') nextExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Clean Extraction') nextCleanExtractionNumber += currentBatchSamples.length;
            else if (currentBatchType === 'Indexing') nextIndexingNumber += currentBatchSamples.length;
            
            clearSelection();
            saveData();
            renderSamples();
            closeBatchModal();
            alert('Batch ' + currentBatchType + ' completed!');
        }

        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            currentBatchSamples = [];
            currentBatchType = '';
        }

        function closeModal() {
            document.getElementById('processModal').style.display = 'none';
        }

        function updateSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            selectedSamples = [];
            for (var i = 0; i < checkboxes.length; i++) {
                selectedSamples.push(checkboxes[i].value);
            }
            
            console.log('Selected samples: ' + selectedSamples.join(','));
            
            var count = document.getElementById('selectedCount');
            var batchBtn = document.getElementById('batchBtn');
            var batchControls = document.getElementById('batchControls');
            
            count.textContent = selectedSamples.length;
            
            if (selectedSamples.length >= 2) {
                batchControls.style.display = 'block';
                batchBtn.disabled = false;
                batchBtn.textContent = 'Start Batch Processing';
            } else {
                batchControls.style.display = 'none';
                batchBtn.disabled = true;
            }
        }

        function clearSelection() {
            var checkboxes = document.querySelectorAll('.sample-checkbox:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            selectedSamples = [];
            updateSelection();
        }

        function filterSamples() {
            var searchText = document.getElementById('searchInput').value.toLowerCase();
            var statusFilter = document.querySelector('input[name="statusFilter"]:checked').value;

            var sampleItems = document.querySelectorAll('.sample-item');
            for (var i = 0; i < sampleItems.length; i++) {
                var item = sampleItems[i];
                var sampleId = item.querySelector('strong').textContent.trim();
                var sampleIdLower = sampleId.toLowerCase();
                var status = item.querySelector('.status').textContent;

                // Find the actual sample object to get the date and flag
                var sample = null;
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        sample = samples[j];
                        break;
                    }
                }

                var matchesSearch = sampleIdLower.includes(searchText);
                var matchesStatus = statusFilter === 'all' ||
                                  status === statusFilter ||
                                  (statusFilter === 'Complete' && status === 'Qubit Complete');
                var matchesDate = sample ? isWithinDateFilter(sample.dateAdded) : true;
                var matchesFlag = currentFlagFilter === 'all' ||
                                (sample && sample.flag === currentFlagFilter) ||
                                (currentFlagFilter === 'None' && (!sample || !sample.flag || sample.flag === 'None'));

                if (matchesSearch && matchesStatus && matchesDate && matchesFlag) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            }
        }

        var currentEditingSampleId = null;

        // QC Thresholds
        var QC_THRESHOLDS = {
            cleanExtractionQubit: {min: 5, max: 200, unit: 'ng/uL'},
            finalQubit: {min: 1, max: 50, unit: 'ng/uL'}
        };

        function checkQCThreshold(value, type) {
            var threshold = QC_THRESHOLDS[type];
            if (!threshold) return {pass: true, message: ''};

            var numValue = parseFloat(value);
            if (isNaN(numValue)) return {pass: true, message: ''};

            if (numValue < threshold.min) {
                return {
                    pass: false,
                    message: '‚ö†Ô∏è Below minimum (' + threshold.min + ' ' + threshold.unit + ')'
                };
            } else if (numValue > threshold.max) {
                return {
                    pass: false,
                    message: '‚ö†Ô∏è Above maximum (' + threshold.max + ' ' + threshold.unit + ')'
                };
            }
            return {pass: true, message: '‚úÖ Within range'};
        }

        function validateQubitValue(inputElement, type) {
            var value = parseFloat(inputElement.value);
            var validationDiv = document.getElementById('qubitValidation');

            if (!validationDiv) return;

            // Check for obviously wrong values
            if (isNaN(value) || value === '') {
                validationDiv.innerHTML = '';
                inputElement.style.borderColor = '';
                return;
            }

            if (value < 0) {
                validationDiv.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå Negative value not possible!</span>';
                inputElement.style.borderColor = '#dc3545';
                inputElement.style.background = '#ffe6e6';
                return;
            }

            if (value === 0) {
                validationDiv.innerHTML = '<span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è Zero concentration - no DNA detected</span>';
                inputElement.style.borderColor = '#ffc107';
                inputElement.style.background = '#fff9e6';
                return;
            }

            if (value > 1000) {
                validationDiv.innerHTML = '<span style="color: #dc3545; font-weight: bold;">‚ùå Unusually high (>1000 ng/uL) - check dilution!</span>';
                inputElement.style.borderColor = '#dc3545';
                inputElement.style.background = '#ffe6e6';
                return;
            }

            // Use existing QC threshold check
            var qc = checkQCThreshold(value, type);
            if (qc.pass) {
                validationDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">' + qc.message + '</span>';
                inputElement.style.borderColor = '#28a745';
                inputElement.style.background = '#e6ffe6';
            } else {
                validationDiv.innerHTML = '<span style="color: #ffc107; font-weight: bold;">' + qc.message + '</span>';
                inputElement.style.borderColor = '#ffc107';
                inputElement.style.background = '#fff9e6';
            }
        }

        function editSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            currentEditingSampleId = sampleId;
            document.getElementById('editOriginalId').textContent = sampleId;
            document.getElementById('editSampleId').value = sample.id;
            document.getElementById('editInitials').value = sample.initials;
            document.getElementById('editStatus').value = sample.status;

            document.getElementById('editModal').style.display = 'block';
        }

        function saveEditedSample() {
            var newId = document.getElementById('editSampleId').value.trim();
            var newInitials = document.getElementById('editInitials').value.trim().toUpperCase();
            var newStatus = document.getElementById('editStatus').value;

            if (!newId || !newInitials) {
                alert('Sample ID and Initials are required');
                return;
            }

            // Check if new ID already exists (and it's not the current sample)
            if (newId !== currentEditingSampleId) {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === newId) {
                        alert('Sample ID ' + newId + ' already exists!');
                        return;
                    }
                }
            }

            // Find and update the sample
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === currentEditingSampleId) {
                    samples[i].id = newId;
                    samples[i].initials = newInitials;
                    samples[i].status = newStatus;
                    break;
                }
            }

            saveData();
            renderSamples();
            closeEditModal();
            alert('Sample updated successfully!');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingSampleId = null;
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').style.display = 'none';
        }

        function showPlateMap() {
            // Get all unique plates from samples
            var plates = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                // Check for plate assignments in various stages
                if (s.tsbDetails && s.tsbDetails.storagePlate) {
                    plates['TSB - ' + s.tsbDetails.storagePlate] = s.tsbDetails.storagePlate;
                }
                if (s.extractionDetails && s.extractionDetails.storagePlate) {
                    plates['Extraction - ' + s.extractionDetails.storagePlate] = s.extractionDetails.storagePlate;
                }
                if (s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate) {
                    plates['Clean Extraction - ' + s.cleanExtractionDetails.storagePlate] = s.cleanExtractionDetails.storagePlate;
                }
                if (s.indexingDetails && s.indexingDetails.storagePlate) {
                    plates['Indexing - ' + s.indexingDetails.storagePlate] = s.indexingDetails.storagePlate;
                }
            }

            // Populate plate selector
            var selector = document.getElementById('plateSelector');
            selector.innerHTML = '<option value="">-- Select a plate --</option>';
            for (var plateName in plates) {
                var option = document.createElement('option');
                option.value = plateName;
                option.textContent = plateName;
                selector.appendChild(option);
            }

            // Show modal
            document.getElementById('plateMapModal').style.display = 'block';

            // If there's only one plate, auto-select it
            if (Object.keys(plates).length === 1) {
                selector.value = Object.keys(plates)[0];
                renderPlateMap();
            }
        }

        function closePlateMapModal() {
            document.getElementById('plateMapModal').style.display = 'none';
        }

        function renderPlateMap() {
            var selectedPlate = document.getElementById('plateSelector').value;
            if (!selectedPlate) {
                document.getElementById('plateMapContainer').innerHTML = '<p style="text-align: center; color: #999;">Please select a plate to view</p>';
                return;
            }

            // Extract plate type and name
            var parts = selectedPlate.split(' - ');
            var plateType = parts[0];
            var plateName = parts[1];

            // Build a map of well positions to samples
            var wellMap = {};
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                var wellPos = null;
                var details = null;

                if (plateType === 'TSB' && s.tsbDetails && s.tsbDetails.storagePlate === plateName) {
                    wellPos = s.tsbDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Extraction' && s.extractionDetails && s.extractionDetails.storagePlate === plateName) {
                    wellPos = s.extractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Clean Extraction' && s.cleanExtractionDetails && s.cleanExtractionDetails.storagePlate === plateName) {
                    wellPos = s.cleanExtractionDetails.wellPosition;
                    details = s;
                } else if (plateType === 'Indexing' && s.indexingDetails && s.indexingDetails.storagePlate === plateName) {
                    wellPos = s.indexingDetails.wellPosition;
                    details = s;
                }

                if (wellPos) {
                    wellMap[wellPos] = details;
                }
            }

            // Generate 96-well plate HTML
            var html = '<div class="plate-map"><table>';

            // Header row with column numbers
            html += '<tr><th></th>';
            for (var col = 1; col <= 12; col++) {
                html += '<th>' + col + '</th>';
            }
            html += '</tr>';

            // Data rows
            var rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            for (var r = 0; r < rows.length; r++) {
                html += '<tr>';
                html += '<th>' + rows[r] + '</th>';

                for (var col = 1; col <= 12; col++) {
                    var wellPos = rows[r] + col;
                    var sample = wellMap[wellPos];

                    if (sample) {
                        var bgColor = getStatusColor(sample.status);
                        var title = sample.id + ' - ' + sample.status;
                        html += '<td style="background: ' + bgColor + ';" title="' + title + '" onclick="viewSample(\'' + sample.id.replace(/'/g, "\\'") + '\')">';
                        html += '<span class="well-id">' + sample.id + '</span>';
                        html += '</td>';
                    } else {
                        html += '<td title="Empty well ' + wellPos + '">';
                        html += '<span style="font-size: 8px; color: #999;">' + wellPos + '</span>';
                        html += '</td>';
                    }
                }
                html += '</tr>';
            }

            html += '</table></div>';
            document.getElementById('plateMapContainer').innerHTML = html;
        }

        function getStatusColor(status) {
            var colors = {
                'Received': '#e9ecef',
                'BAP Complete': '#d4edda',
                'TSB Complete': '#fff3cd',
                'Extraction Complete': '#f3e5f5',
                'Clean Extraction Complete': '#e8f5e8',
                'Clean Extraction Qubit Complete': '#e8f4fd',
                'Indexing Complete': '#e3f2fd',
                'Qubit Complete': '#fff3e0'
            };
            return colors[status] || '#f8f9fa';
        }

        function toggleDarkMode() {
            var currentTheme = document.documentElement.getAttribute('data-theme');
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);

            // Update button text
            var button = document.getElementById('darkModeToggle');
            if (newTheme === 'dark') {
                button.innerHTML = '‚òÄÔ∏è Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                button.innerHTML = 'üåô Dark Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        function loadTheme() {
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            var button = document.getElementById('darkModeToggle');
            if (button) {
                if (savedTheme === 'dark') {
                    button.innerHTML = '‚òÄÔ∏è Light Mode';
                } else {
                    button.innerHTML = 'üåô Dark Mode';
                }
            }
        }

        var bulkSelectedSamples = [];
        var currentQRSampleId = null;

        function showQRCode(sampleId) {
            currentQRSampleId = sampleId;
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }

            if (!sample) return;

            // Generate QR code data (JSON format for comprehensive info)
            var qrData = {
                id: sample.id,
                status: sample.status,
                added: sample.dateAdded,
                initials: sample.initials
            };

            // Add BAP number if exists
            if (sample.bapNumber) {
                qrData.bap = sample.bapNumber;
            }

            var qrDataString = JSON.stringify(qrData);

            // Generate QR code using Google Charts API
            var qrSize = 300;
            var qrCodeURL = 'https://chart.googleapis.com/chart?cht=qr&chs=' + qrSize + 'x' + qrSize + '&chl=' + encodeURIComponent(qrDataString);

            // Display QR code
            var qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '<img src="' + qrCodeURL + '" alt="QR Code for ' + sample.id + '" style="max-width: 100%; border: 2px solid var(--border-color); border-radius: 8px;">';

            // Display sample info
            var infoContainer = document.getElementById('qrSampleInfo');
            var html = '<h4 style="margin-top: 0;">' + sample.id + '</h4>';
            html += '<p><strong>Status:</strong> ' + sample.status + '</p>';
            html += '<p><strong>Added:</strong> ' + sample.dateAdded + '</p>';
            html += '<p><strong>Technician:</strong> ' + sample.initials + '</p>';
            if (sample.bapNumber) {
                html += '<p><strong>BAP #:</strong> ' + sample.bapNumber + '</p>';
            }
            if (sample.notes) {
                html += '<p><strong>Notes:</strong> ' + sample.notes + '</p>';
            }
            infoContainer.innerHTML = html;

            // Show modal
            document.getElementById('qrCodeModal').style.display = 'block';
        }

        function closeQRCodeModal() {
            document.getElementById('qrCodeModal').style.display = 'none';
            currentQRSampleId = null;
        }

        function printQRCode() {
            var modal = document.getElementById('qrCodeModal');
            var qrContainer = document.getElementById('qrCodeContainer').innerHTML;
            var sampleInfo = document.getElementById('qrSampleInfo').innerHTML;

            // Open print window with QR code
            var printWindow = window.open('', '', 'width=600,height=600');
            printWindow.document.write('<html><head><title>QR Code Label - ' + currentQRSampleId + '</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }');
            printWindow.document.write('h2 { margin: 10px 0; }');
            printWindow.document.write('.label { border: 2px solid #000; padding: 20px; display: inline-block; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="label">');
            printWindow.document.write('<h2>BWGS Sample</h2>');
            printWindow.document.write(qrContainer);
            printWindow.document.write(sampleInfo);
            printWindow.document.write('<p style="margin-top: 20px; font-size: 12px; color: #666;">Scan QR code to view sample details</p>');
            printWindow.document.write('</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait a bit for images to load then print
            setTimeout(function() {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function toggleSampleSelection(sampleId, checkbox) {
            if (checkbox.checked) {
                if (bulkSelectedSamples.indexOf(sampleId) === -1) {
                    bulkSelectedSamples.push(sampleId);
                }
            } else {
                var index = bulkSelectedSamples.indexOf(sampleId);
                if (index > -1) {
                    bulkSelectedSamples.splice(index, 1);
                }
            }
            updateBulkOpsBar();
        }

        function toggleSelectAll() {
            var selectAll = document.getElementById('selectAllCheckbox').checked;
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            bulkSelectedSamples = [];

            for (var i = 0; i < checkboxes.length; i++) {
                var checkbox = checkboxes[i];
                var sampleItem = checkbox.closest('.sample-item');

                // Only select visible samples
                if (sampleItem && sampleItem.style.display !== 'none') {
                    checkbox.checked = selectAll;
                    if (selectAll) {
                        bulkSelectedSamples.push(checkbox.value);
                    }
                }
            }
            updateBulkOpsBar();
        }

        function clearSelection() {
            bulkSelectedSamples = [];
            var checkboxes = document.querySelectorAll('.sample-checkbox');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            document.getElementById('selectAllCheckbox').checked = false;
            updateBulkOpsBar();
        }

        function updateBulkOpsBar() {
            var bar = document.getElementById('bulkOpsBar');
            var count = bulkSelectedSamples.length;
            document.getElementById('selectedCount').textContent = count;

            if (count > 0) {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }
        }

        function bulkDelete() {
            if (bulkSelectedSamples.length === 0) return;

            var deleteCount = bulkSelectedSamples.length;
            var confirmed = confirm('Are you sure you want to delete ' + deleteCount + ' sample(s)?\n\nThis cannot be undone!');
            if (!confirmed) return;

            // Delete all selected samples (iterate backwards to avoid index issues)
            samples = samples.filter(function(sample) {
                return bulkSelectedSamples.indexOf(sample.id) === -1;
            });

            clearSelection();
            saveData();
            renderSamples();
            alert(deleteCount + ' sample(s) deleted successfully!');
        }

        function showBulkStatusChange() {
            if (bulkSelectedSamples.length === 0) return;

            var newStatus = prompt('Enter new status for ' + bulkSelectedSamples.length + ' sample(s):\n\n' +
                'Options:\n' +
                '- Received\n' +
                '- BAP Complete\n' +
                '- TSB Complete\n' +
                '- Extraction Complete\n' +
                '- Clean Extraction Complete\n' +
                '- Clean Extraction Qubit Complete\n' +
                '- Indexing Complete\n' +
                '- Qubit Complete');

            if (!newStatus) return;

            var validStatuses = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];

            if (validStatuses.indexOf(newStatus) === -1) {
                alert('Invalid status! Please use one of the listed options.');
                return;
            }

            // Update status for all selected samples
            var updated = 0;
            for (var i = 0; i < bulkSelectedSamples.length; i++) {
                var sampleId = bulkSelectedSamples[i];
                for (var j = 0; j < samples.length; j++) {
                    if (samples[j].id === sampleId) {
                        samples[j].status = newStatus;
                        updated++;
                        break;
                    }
                }
            }

            clearSelection();
            saveData();
            renderSamples();
            alert(updated + ' sample(s) status updated to: ' + newStatus);
        }

        function showAnalytics() {
            document.getElementById('analyticsModal').style.display = 'block';
            renderAnalytics();
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        function showReagentSearch() {
            document.getElementById('reagentSearchModal').style.display = 'block';
            document.getElementById('reagentSearchInput').focus();
        }

        function closeReagentSearchModal() {
            document.getElementById('reagentSearchModal').style.display = 'none';
        }

        function searchReagentLot() {
            var searchLot = document.getElementById('reagentSearchInput').value.trim();
            if (!searchLot) {
                alert('Please enter a lot number to search');
                return;
            }

            var results = [];
            var searchLower = searchLot.toLowerCase();

            // Search through all samples
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var found = false;
                var foundIn = [];

                // Check main lot number field (BAP/TSB)
                if (sample.bapDetails && sample.bapDetails.lot && sample.bapDetails.lot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('BAP Lot');
                }
                if (sample.tsbDetails && sample.tsbDetails.lot && sample.tsbDetails.lot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('TSB Lot');
                }

                // Check Extraction reagent lots
                if (sample.extractionDetails && sample.extractionDetails.reagentLots) {
                    var lots = sample.extractionDetails.reagentLots;
                    if (lots.aw1 && lots.aw1.toLowerCase().includes(searchLower)) { found = true; foundIn.push('AW1'); }
                    if (lots.aw2 && lots.aw2.toLowerCase().includes(searchLower)) { found = true; foundIn.push('AW2'); }
                    if (lots.ethanol && lots.ethanol.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Ethanol'); }
                    if (lots.bufferAL && lots.bufferAL.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer AL'); }
                    if (lots.bufferATL && lots.bufferATL.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer ATL'); }
                    if (lots.bufferAE && lots.bufferAE.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Buffer AE'); }
                    if (lots.proteinaseK && lots.proteinaseK.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Proteinase K'); }
                    if (lots.dneasy && lots.dneasy.toLowerCase().includes(searchLower)) { found = true; foundIn.push('DNeasy'); }
                }

                // Check Clean Extraction reagent lots
                if (sample.cleanExtractionDetails && sample.cleanExtractionDetails.reagentLots) {
                    var lots = sample.cleanExtractionDetails.reagentLots;
                    if (lots.bead && lots.bead.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Bead'); }
                    if (lots.nfH2oEtoh && lots.nfH2oEtoh.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O ETOH'); }
                    if (lots.etohDilution && lots.etohDilution.toLowerCase().includes(searchLower)) { found = true; foundIn.push('EtOH Dilution'); }
                    if (lots.nfH2oElution && lots.nfH2oElution.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O Elution'); }
                    if (lots.qubitReagent && lots.qubitReagent.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Qubit Reagent (CE)'); }
                }

                // Check Indexing reagent lots
                if (sample.indexingDetails && sample.indexingDetails.reagentLots) {
                    var lots = sample.indexingDetails.reagentLots;
                    if (lots.tdBuffer && lots.tdBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('TD Buffer'); }
                    if (lots.atmBuffer && lots.atmBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('ATM Buffer'); }
                    if (lots.ntBuffer && lots.ntBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NT Buffer'); }
                    if (lots.npm && lots.npm.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NPM'); }
                    if (lots.resuspensionBuffer && lots.resuspensionBuffer.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Resuspension Buffer'); }
                    if (lots.indexesKit && lots.indexesKit.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Indexes Kit'); }
                    if (lots.beads && lots.beads.toLowerCase().includes(searchLower)) { found = true; foundIn.push('Beads (Indexing)'); }
                    if (lots.etoh && lots.etoh.toLowerCase().includes(searchLower)) { found = true; foundIn.push('EtOH (Indexing)'); }
                    if (lots.nfH2o && lots.nfH2o.toLowerCase().includes(searchLower)) { found = true; foundIn.push('NF H2O (Indexing)'); }
                }

                // Check Qubit reagent lots
                if (sample.cleanExtractionQubitDetails && sample.cleanExtractionQubitDetails.reagentLot &&
                    sample.cleanExtractionQubitDetails.reagentLot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('CE Qubit Reagent');
                }
                if (sample.qubitDetails && sample.qubitDetails.reagentLot &&
                    sample.qubitDetails.reagentLot.toLowerCase().includes(searchLower)) {
                    found = true;
                    foundIn.push('Final Qubit Reagent');
                }

                if (found) {
                    results.push({
                        sample: sample,
                        foundIn: foundIn
                    });
                }
            }

            // Display results
            var resultsDiv = document.getElementById('reagentSearchResults');

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; text-align: center;"><strong>‚ö†Ô∏è No samples found</strong><br>No samples use reagent lot: ' + searchLot + '</div>';
            } else {
                var html = '<div style="background: #d4edda; border: 2px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
                html += '<strong style="color: #155724;">‚úÖ Found ' + results.length + ' sample(s) using lot: ' + searchLot + '</strong>';
                html += '</div>';

                html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
                html += '<th style="padding: 12px; text-align: left;">Sample ID</th>';
                html += '<th style="padding: 12px; text-align: left;">Status</th>';
                html += '<th style="padding: 12px; text-align: left;">Date Added</th>';
                html += '<th style="padding: 12px; text-align: left;">Found In</th>';
                html += '</tr>';

                for (var i = 0; i < results.length; i++) {
                    var r = results[i];
                    html += '<tr style="border-bottom: 1px solid #dee2e6;">';
                    html += '<td style="padding: 12px; font-weight: 600;">' + r.sample.id + '</td>';
                    html += '<td style="padding: 12px;">' + r.sample.status + '</td>';
                    html += '<td style="padding: 12px;">' + r.sample.dateAdded + '</td>';
                    html += '<td style="padding: 12px; color: #fd7e14; font-weight: 600;">' + r.foundIn.join(', ') + '</td>';
                    html += '</tr>';
                }

                html += '</table></div>';

                html += '<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">';
                html += '<strong>üí° Tip:</strong> This is useful for quality control and recalls. Export this data or take a screenshot for your records.';
                html += '</div>';

                resultsDiv.innerHTML = html;
            }
        }

        // Reagent Templates System
        var reagentTemplates = JSON.parse(localStorage.getItem('reagentTemplates') || '[]');

        function showReagentTemplates() {
            document.getElementById('reagentTemplatesModal').style.display = 'block';
            renderTemplatesList();
        }

        function closeReagentTemplatesModal() {
            document.getElementById('reagentTemplatesModal').style.display = 'none';
        }

        function renderTemplatesList() {
            var listDiv = document.getElementById('templatesList');

            if (reagentTemplates.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No templates saved yet. Use "Save as Template" button when processing a sample to save reagent lots.</p>';
                return;
            }

            var html = '<div style="display: grid; gap: 15px;">';
            for (var i = 0; i < reagentTemplates.length; i++) {
                var template = reagentTemplates[i];
                html += '<div style="border: 2px solid #17a2b8; border-radius: 8px; padding: 15px; background: #f0f9ff;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: start;">';
                html += '<div>';
                html += '<h4 style="margin: 0 0 5px 0; color: #17a2b8;">' + template.name + '</h4>';
                html += '<small style="color: #666;">Stage: ' + template.stage + ' ‚Ä¢ Saved: ' + template.dateSaved + '</small>';
                html += '</div>';
                html += '<div>';
                html += '<button onclick="applyTemplate(' + i + ')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Apply</button>';
                html += '<button onclick="deleteTemplate(' + i + ')" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Delete</button>';
                html += '</div>';
                html += '</div>';

                // Show saved lots
                var lotsCount = Object.keys(template.lots).length;
                html += '<div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px;">';
                html += '<strong>' + lotsCount + ' reagent lots saved</strong>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div>';

            listDiv.innerHTML = html;
        }

        function saveAsTemplate() {
            var templateName = prompt('Enter a name for this template (e.g., "Week of Jan 15" or "Batch 2025-01"):');
            if (!templateName) return;

            var lots = {};
            var stage = currentProcessType;

            // Collect all visible reagent lot inputs
            var inputs = document.querySelectorAll('#specificFields input[type="text"], #lotNumber, #techInitials, #temperature, #incubator');
            for (var i = 0; i < inputs.length; i++) {
                var input = inputs[i];
                if (input.value && input.id) {
                    lots[input.id] = input.value;
                }
            }

            if (Object.keys(lots).length === 0) {
                alert('No reagent lots to save. Fill in some lot numbers first!');
                return;
            }

            var template = {
                name: templateName,
                stage: stage,
                lots: lots,
                dateSaved: new Date().toLocaleDateString()
            };

            reagentTemplates.push(template);
            localStorage.setItem('reagentTemplates', JSON.stringify(reagentTemplates));

            alert('‚úÖ Template "' + templateName + '" saved with ' + Object.keys(lots).length + ' fields!');
        }

        function loadTemplate() {
            if (reagentTemplates.length === 0) {
                alert('No templates saved yet. Use "Save as Template" first!');
                return;
            }

            // Filter templates for current stage
            var stage = currentProcessType;
            var stageTemplates = [];
            for (var i = 0; i < reagentTemplates.length; i++) {
                if (reagentTemplates[i].stage === stage) {
                    stageTemplates.push({index: i, template: reagentTemplates[i]});
                }
            }

            if (stageTemplates.length === 0) {
                alert('No templates saved for ' + stage + ' stage yet.');
                return;
            }

            // Show template selection
            var message = 'Select a template to load:\n\n';
            for (var i = 0; i < stageTemplates.length; i++) {
                var t = stageTemplates[i].template;
                message += (i+1) + '. ' + t.name + ' (saved ' + t.dateSaved + ')\n';
            }

            var choice = prompt(message, '1');
            if (!choice) return;

            var choiceNum = parseInt(choice);
            if (isNaN(choiceNum) || choiceNum < 1 || choiceNum > stageTemplates.length) {
                alert('Invalid selection');
                return;
            }

            var template = stageTemplates[choiceNum - 1].template;
            applyTemplateData(template.lots);
            alert('‚úÖ Template "' + template.name + '" loaded!');
        }

        function applyTemplate(templateIndex) {
            var template = reagentTemplates[templateIndex];
            applyTemplateData(template.lots);
            closeReagentTemplatesModal();
            alert('‚úÖ Template "' + template.name + '" applied!');
        }

        function applyTemplateData(lots) {
            // Fill in all matching input fields
            for (var fieldId in lots) {
                var input = document.getElementById(fieldId);
                if (input) {
                    input.value = lots[fieldId];
                }
            }
        }

        function deleteTemplate(templateIndex) {
            var template = reagentTemplates[templateIndex];
            if (confirm('Delete template "' + template.name + '"?')) {
                reagentTemplates.splice(templateIndex, 1);
                localStorage.setItem('reagentTemplates', JSON.stringify(reagentTemplates));
                renderTemplatesList();
            }
        }

        function renderAnalytics() {
            var html = '';

            // Calculate analytics
            var totalSamples = samples.length;
            var statusCounts = {};
            var techCounts = {};
            var dailyThroughput = {};
            var avgTimePerStage = {};

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Count by status
                statusCounts[s.status] = (statusCounts[s.status] || 0) + 1;

                // Count by technician
                if (s.initials) techCounts[s.initials] = (techCounts[s.initials] || 0) + 1;
                if (s.bapDetails && s.bapDetails.tech) techCounts[s.bapDetails.tech] = (techCounts[s.bapDetails.tech] || 0) + 1;
                if (s.tsbDetails && s.tsbDetails.tech) techCounts[s.tsbDetails.tech] = (techCounts[s.tsbDetails.tech] || 0) + 1;

                // Daily throughput (samples added per day)
                var dateKey = s.dateAdded.split('T')[0];
                dailyThroughput[dateKey] = (dailyThroughput[dateKey] || 0) + 1;
            }

            // Top stats grid
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">';
            html += '<div class="stat-card"><div class="stat-label">Total Samples</div><div class="stat-value">' + totalSamples + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" style="color: #28a745;">' + (statusCounts['Qubit Complete'] || 0) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">In Progress</div><div class="stat-value" style="color: #ffc107;">' + (totalSamples - (statusCounts['Qubit Complete'] || 0)) + '</div></div>';
            html += '<div class="stat-card"><div class="stat-label">Completion Rate</div><div class="stat-value" style="color: #17a2b8;">' + (totalSamples > 0 ? Math.round(((statusCounts['Qubit Complete'] || 0) / totalSamples) * 100) : 0) + '%</div></div>';
            html += '</div>';

            // Charts grid
            html += '<div class="analytics-grid">';

            // Status distribution chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üìä Samples by Status</div>';
            html += '<div class="bar-chart">';
            var maxStatusCount = Math.max.apply(null, Object.values(statusCounts));
            for (var status in statusCounts) {
                var count = statusCounts[status];
                var percentage = maxStatusCount > 0 ? (count / maxStatusCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + status + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%;">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Technician workload chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üë• Work by Technician</div>';
            html += '<div class="bar-chart">';
            var maxTechCount = Math.max.apply(null, Object.values(techCounts));
            var sortedTechs = Object.keys(techCounts).sort(function(a, b) {
                return techCounts[b] - techCounts[a];
            });
            for (var t = 0; t < sortedTechs.length && t < 10; t++) {
                var tech = sortedTechs[t];
                var count = techCounts[tech];
                var percentage = maxTechCount > 0 ? (count / maxTechCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + tech + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Daily throughput chart
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üìÖ Daily Sample Input</div>';
            html += '<div class="bar-chart">';
            var sortedDates = Object.keys(dailyThroughput).sort().slice(-14); // Last 14 days
            var maxDailyCount = Math.max.apply(null, sortedDates.map(function(d) { return dailyThroughput[d]; }));
            for (var d = 0; d < sortedDates.length; d++) {
                var date = sortedDates[d];
                var count = dailyThroughput[date];
                var percentage = maxDailyCount > 0 ? (count / maxDailyCount) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + date + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">' + count + '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            // Stage completion rates
            html += '<div class="chart-container">';
            html += '<div class="chart-title">üéØ Stage Completion Rates</div>';
            html += '<div class="bar-chart">';
            var stages = [
                { name: 'BAP', key: 'BAP Complete' },
                { name: 'TSB', key: 'TSB Complete' },
                { name: 'Extraction', key: 'Extraction Complete' },
                { name: 'Clean Extract', key: 'Clean Extraction Complete' },
                { name: 'CE Qubit', key: 'Clean Extraction Qubit Complete' },
                { name: 'Indexing', key: 'Indexing Complete' },
                { name: 'Final Qubit', key: 'Qubit Complete' }
            ];

            for (var st = 0; st < stages.length; st++) {
                var stage = stages[st];
                var completed = 0;
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].status === stage.key || isStageComplete(samples[i], stage.key)) {
                        completed++;
                    }
                }
                var percentage = totalSamples > 0 ? (completed / totalSamples) * 100 : 0;
                html += '<div class="bar-item">';
                html += '<div class="bar-label">' + stage.name + '</div>';
                html += '<div class="bar-wrapper">';
                html += '<div class="bar-fill" style="width: ' + percentage + '%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);">' + completed + ' (' + Math.round(percentage) + '%)</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div></div>';

            html += '</div>'; // Close analytics-grid

            document.getElementById('analyticsContainer').innerHTML = html;
        }

        function isStageComplete(sample, stage) {
            var stageOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete', 'Clean Extraction Complete', 'Clean Extraction Qubit Complete', 'Indexing Complete', 'Qubit Complete'];
            var currentIndex = stageOrder.indexOf(sample.status);
            var checkIndex = stageOrder.indexOf(stage);
            return currentIndex >= checkIndex;
        }

        function showTimeline() {
            document.getElementById('timelineModal').style.display = 'block';
            renderTimeline();
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').style.display = 'none';
        }

        function renderTimeline() {
            var view = document.getElementById('timelineView').value;
            var events = [];

            // Collect all events from samples
            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];

                // Add sample received event
                events.push({
                    date: s.dateAdded,
                    sampleId: s.id,
                    stage: 'Received',
                    tech: s.initials,
                    details: 'Sample received and logged'
                });

                // Add BAP event
                if (s.bapDetails) {
                    var bapDetails = 'Lot: ' + s.bapDetails.lotNumber + ', ' + s.bapDetails.temperature + '¬∞C, ' + s.bapDetails.incubator;
                    if (s.bapDetails.timeIn) bapDetails += ', In: ' + s.bapDetails.timeIn;
                    if (s.bapDetails.timeOut) bapDetails += ', Out: ' + s.bapDetails.timeOut;
                    events.push({
                        date: s.bapDetails.completionDate,
                        sampleId: s.id,
                        stage: 'BAP Complete',
                        tech: s.bapDetails.tech,
                        details: bapDetails
                    });
                }

                // Add TSB event
                if (s.tsbDetails) {
                    var tsbDetails = 'Lot: ' + s.tsbDetails.lotNumber;
                    if (s.tsbDetails.temperature && s.tsbDetails.incubator) {
                        tsbDetails += ', ' + s.tsbDetails.temperature + '¬∞C, ' + s.tsbDetails.incubator;
                    }
                    if (s.tsbDetails.timeIn) tsbDetails += ', In: ' + s.tsbDetails.timeIn;
                    if (s.tsbDetails.timeOut) tsbDetails += ', Out: ' + s.tsbDetails.timeOut;
                    if (s.tsbDetails.storagePlate) {
                        tsbDetails += ', Plate: ' + s.tsbDetails.storagePlate + ', Well: ' + s.tsbDetails.wellPosition;
                    }
                    events.push({
                        date: s.tsbDetails.completionDate,
                        sampleId: s.id,
                        stage: 'TSB Complete',
                        tech: s.tsbDetails.tech,
                        details: tsbDetails
                    });
                }

                // Add Extraction event
                if (s.extractionDetails) {
                    events.push({
                        date: s.extractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Extraction Complete',
                        tech: s.extractionDetails.tech,
                        details: 'Run: ' + s.extractionDetails.extractionRun + ', Plate: ' + s.extractionDetails.storagePlate
                    });
                }

                // Add Clean Extraction event
                if (s.cleanExtractionDetails) {
                    events.push({
                        date: s.cleanExtractionDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Clean Extraction Complete',
                        tech: s.cleanExtractionDetails.tech,
                        details: 'Run: ' + s.cleanExtractionDetails.extractionRun + ', Plate: ' + s.cleanExtractionDetails.storagePlate
                    });
                }

                // Add CE Qubit event
                if (s.cleanExtractionQubitDetails) {
                    events.push({
                        date: s.cleanExtractionQubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'CE Qubit Complete',
                        tech: s.cleanExtractionQubitDetails.tech,
                        details: 'Concentration: ' + s.cleanExtractionQubitDetails.concentration + ' ng/uL'
                    });
                }

                // Add Indexing event
                if (s.indexingDetails) {
                    events.push({
                        date: s.indexingDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Indexing Complete',
                        tech: s.indexingDetails.tech,
                        details: 'i5: ' + s.indexingDetails.i5Index + ', i7: ' + s.indexingDetails.i7Index
                    });
                }

                // Add Final Qubit event
                if (s.qubitDetails) {
                    events.push({
                        date: s.qubitDetails.completionDate,
                        sampleId: s.id,
                        stage: 'Qubit Complete',
                        tech: s.qubitDetails.tech,
                        details: 'Concentration: ' + s.qubitDetails.concentration + ' ng/uL'
                    });
                }
            }

            // Filter by view
            var now = new Date();
            if (view === 'recent') {
                var sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= sevenDaysAgo;
                });
            } else if (view === 'month') {
                var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                events = events.filter(function(e) {
                    return new Date(e.date) >= thirtyDaysAgo;
                });
            }

            // Sort by date (newest first)
            events.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });

            // Render timeline
            var html = '<div class="timeline">';

            if (events.length === 0) {
                html += '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No events to display</p>';
            } else {
                for (var i = 0; i < events.length; i++) {
                    var event = events[i];
                    var stageColor = getStageColor(event.stage);

                    html += '<div class="timeline-item">';
                    html += '<div class="timeline-date">' + formatDate(event.date) + '</div>';
                    html += '<div class="timeline-marker" style="background: ' + stageColor + ';"></div>';
                    html += '<div class="timeline-content" style="border-left-color: ' + stageColor + ';">';
                    html += '<h4>' + event.sampleId + ' <span class="timeline-stage" style="background: ' + stageColor + '; color: white;">' + event.stage + '</span></h4>';
                    html += '<p>üë§ Technician: ' + event.tech + '</p>';
                    html += '<p>üìã ' + event.details + '</p>';
                    html += '</div>';
                    html += '</div>';
                }
            }

            html += '</div>';
            document.getElementById('timelineContainer').innerHTML = html;
        }

        function getStageColor(stage) {
            var colors = {
                'Received': '#6c757d',
                'BAP Complete': '#28a745',
                'TSB Complete': '#ffc107',
                'Extraction Complete': '#9c27b0',
                'Clean Extraction Complete': '#4caf50',
                'CE Qubit Complete': '#2196f3',
                'Indexing Complete': '#00bcd4',
                'Qubit Complete': '#ff9800'
            };
            return colors[stage] || '#007bff';
        }

        function formatDate(dateString) {
            var date = new Date(dateString);
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            var day = date.getDate().toString().padStart(2, '0');
            var year = date.getFullYear();
            var hours = date.getHours().toString().padStart(2, '0');
            var minutes = date.getMinutes().toString().padStart(2, '0');
            return month + '/' + day + '/' + year + ' ' + hours + ':' + minutes;
        }

        function editNotes(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var currentNotes = sample.notes || '';
            var newNotes = prompt('Edit notes for sample: ' + sampleId, currentNotes);

            if (newNotes !== null) {
                sample.notes = newNotes;
                saveData();
                renderSamples();
            }
        }

        function deleteSample(sampleId) {
            if (confirm('Are you sure you want to delete sample: ' + sampleId + '?\n\nThis action cannot be undone!')) {
                for (var i = 0; i < samples.length; i++) {
                    if (samples[i].id === sampleId) {
                        samples.splice(i, 1);
                        break;
                    }
                }
                saveData();
                renderSamples();
                alert('Sample ' + sampleId + ' deleted successfully.');
            }
        }

        function viewSample(sampleId) {
            var sample = null;
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].id === sampleId) {
                    sample = samples[i];
                    break;
                }
            }
            if (!sample) return;

            var html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<h4 style="margin-top: 0;">Sample Information</h4>';
            html += '<p><strong>Sample ID:</strong> ' + sample.id + '</p>';
            html += '<p><strong>Current Status:</strong> <span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span></p>';
            html += '<p><strong>Date Added:</strong> ' + sample.dateAdded + '</p>';
            html += '<p><strong>Added By:</strong> ' + sample.initials + '</p>';
            if (sample.flag && sample.flag !== 'None') {
                var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                html += '<p><strong>Flag:</strong> ' + flagIcon + ' ' + sample.flag + '</p>';
            }
            if (sample.notes) {
                html += '<p><strong>Notes:</strong> ' + sample.notes + '</p>';
            }
            html += '</div>';

            // Timeline of events
            html += '<h4>üìÖ Processing Timeline</h4>';
            html += '<div style="border-left: 4px solid #007bff; padding-left: 20px;">';

            // Received
            html += '<div style="margin-bottom: 20px;">';
            html += '<div style="background: #e9ecef; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">RECEIVED</div>';
            html += '<p style="margin: 5px 0;"><strong>Date:</strong> ' + sample.dateAdded + '</p>';
            html += '<p style="margin: 5px 0;"><strong>Technician:</strong> ' + sample.initials + '</p>';
            html += '</div>';

            // BAP
            if (sample.bapDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #d4edda; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">BAP</div>';
                html += '<p style="margin: 5px 0;"><strong>BAP Number:</strong> ' + sample.bapNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Lot:</strong> ' + sample.bapDetails.lotNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Temperature:</strong> ' + sample.bapDetails.temperature + '¬∞C</p>';
                html += '<p style="margin: 5px 0;"><strong>Incubator:</strong> ' + sample.bapDetails.incubator + '</p>';
                if (sample.bapDetails.timeIn) html += '<p style="margin: 5px 0;"><strong>Time In:</strong> ' + sample.bapDetails.timeIn + '</p>';
                if (sample.bapDetails.timeOut) html += '<p style="margin: 5px 0;"><strong>Time Out:</strong> ' + sample.bapDetails.timeOut + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.bapDetails.completionDate + ' by ' + sample.bapDetails.technician + '</p>';
                html += '</div>';
            }

            // TSB
            if (sample.tsbDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #fff3cd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">TSB</div>';
                html += '<p style="margin: 5px 0;"><strong>TSB Number:</strong> ' + sample.tsbNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Lot:</strong> ' + sample.tsbDetails.lotNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Temperature:</strong> ' + sample.tsbDetails.temperature + '¬∞C</p>';
                html += '<p style="margin: 5px 0;"><strong>Incubator:</strong> ' + sample.tsbDetails.incubator + '</p>';
                if (sample.tsbDetails.timeIn) html += '<p style="margin: 5px 0;"><strong>Time In:</strong> ' + sample.tsbDetails.timeIn + '</p>';
                if (sample.tsbDetails.timeOut) html += '<p style="margin: 5px 0;"><strong>Time Out:</strong> ' + sample.tsbDetails.timeOut + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.tsbDetails.completionDate + ' by ' + sample.tsbDetails.technician + '</p>';
                html += '</div>';
            }

            // Extraction
            if (sample.extractionDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #f3e5f5; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">EXTRACTION</div>';
                html += '<p style="margin: 5px 0;"><strong>Extraction Number:</strong> ' + sample.extractionNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Run:</strong> ' + sample.extractionDetails.extractionRun + '</p>';
                if (sample.extractionDetails.reagentLots) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lots:</strong></p>';
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    if (sample.extractionDetails.reagentLots.aw1) html += '<li>AW1: ' + sample.extractionDetails.reagentLots.aw1 + '</li>';
                    if (sample.extractionDetails.reagentLots.aw2) html += '<li>AW2: ' + sample.extractionDetails.reagentLots.aw2 + '</li>';
                    if (sample.extractionDetails.reagentLots.ethanol) html += '<li>Ethanol: ' + sample.extractionDetails.reagentLots.ethanol + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferAL) html += '<li>Buffer AL: ' + sample.extractionDetails.reagentLots.bufferAL + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferATL) html += '<li>Buffer ATL: ' + sample.extractionDetails.reagentLots.bufferATL + '</li>';
                    if (sample.extractionDetails.reagentLots.bufferAE) html += '<li>Buffer AE: ' + sample.extractionDetails.reagentLots.bufferAE + '</li>';
                    if (sample.extractionDetails.reagentLots.proteinaseK) html += '<li>Proteinase K: ' + sample.extractionDetails.reagentLots.proteinaseK + '</li>';
                    if (sample.extractionDetails.reagentLots.dneasy) html += '<li>DNeasy Column: ' + sample.extractionDetails.reagentLots.dneasy + '</li>';
                    html += '</ul>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.extractionDetails.completedDate + ' by ' + sample.extractionDetails.technician + '</p>';
                html += '</div>';
            }

            // Clean Extraction
            if (sample.cleanExtractionDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e8f5e8; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">CLEAN EXTRACTION</div>';
                html += '<p style="margin: 5px 0;"><strong>Clean Extraction Number:</strong> ' + sample.cleanExtractionNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Plate:</strong> ' + sample.cleanExtractionDetails.storagePlate + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Well:</strong> ' + sample.cleanExtractionDetails.wellPosition + '</p>';
                if (sample.cleanExtractionDetails.volumes) {
                    html += '<p style="margin: 5px 0;"><strong>Cleanup Volume:</strong> ' + sample.cleanExtractionDetails.volumes.cleanup + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Elution In:</strong> ' + sample.cleanExtractionDetails.volumes.elutionIn + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Elution Out:</strong> ' + sample.cleanExtractionDetails.volumes.elutionOut + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.cleanExtractionDetails.completedDate + ' by ' + sample.cleanExtractionDetails.technician + '</p>';
                html += '</div>';
            }

            // CE Qubit
            if (sample.cleanExtractionQubitDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e8f4fd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">CE QUBIT</div>';
                html += '<p style="margin: 5px 0;"><strong>Concentration:</strong> ' + sample.cleanExtractionQubitDetails.concentration + ' ng/uL</p>';
                if (sample.cleanExtractionQubitDetails.reagentLot) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lot:</strong> ' + sample.cleanExtractionQubitDetails.reagentLot + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.cleanExtractionQubitDetails.completedDate + ' by ' + sample.cleanExtractionQubitDetails.technician + '</p>';
                html += '</div>';
            }

            // Indexing
            if (sample.indexingDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #e3f2fd; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">INDEXING</div>';
                html += '<p style="margin: 5px 0;"><strong>Indexing Number:</strong> ' + sample.indexingNumber + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Plate:</strong> ' + sample.indexingDetails.storagePlate + '</p>';
                html += '<p style="margin: 5px 0;"><strong>Well:</strong> ' + sample.indexingDetails.wellPosition + '</p>';
                if (sample.indexingDetails.indexes) {
                    html += '<p style="margin: 5px 0;"><strong>i5 Index:</strong> ' + sample.indexingDetails.indexes.i5 + ' (Thaws: ' + sample.indexingDetails.indexes.i5Thaws + ')</p>';
                    html += '<p style="margin: 5px 0;"><strong>i7 Index:</strong> ' + sample.indexingDetails.indexes.i7 + ' (Thaws: ' + sample.indexingDetails.indexes.i7Thaws + ')</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.indexingDetails.completedDate + ' by ' + sample.indexingDetails.technician + '</p>';
                html += '</div>';
            }

            // Final Qubit
            if (sample.qubitDetails) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<div style="background: #fff3e0; display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 5px;">FINAL QUBIT</div>';
                html += '<p style="margin: 5px 0;"><strong>Concentration:</strong> ' + sample.qubitDetails.concentration + ' ng/uL</p>';
                if (sample.qubitDetails.reagentLot) {
                    html += '<p style="margin: 5px 0;"><strong>Reagent Lot:</strong> ' + sample.qubitDetails.reagentLot + '</p>';
                }
                html += '<p style="margin: 5px 0;"><strong>Completed:</strong> ' + sample.qubitDetails.completedDate + ' by ' + sample.qubitDetails.technician + '</p>';
                html += '</div>';
            }

            html += '</div>';

            // QC Failures
            if (sample.qcFailures && sample.qcFailures.length > 0) {
                html += '<h4 style="color: #dc3545;">‚ö†Ô∏è QC Failure History</h4>';
                html += '<div style="background: #ffe6e6; border-left: 4px solid #dc3545; padding: 15px;">';
                for (var f = 0; f < sample.qcFailures.length; f++) {
                    var failure = sample.qcFailures[f];
                    html += '<div style="margin-bottom: 10px;">';
                    html += '<p style="margin: 5px 0;"><strong>Failure #' + (f + 1) + ':</strong></p>';
                    html += '<p style="margin: 5px 0;"><strong>Stage:</strong> ' + failure.stage + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Reason:</strong> ' + failure.reason + '</p>';
                    if (failure.notes) html += '<p style="margin: 5px 0;"><strong>Notes:</strong> ' + failure.notes + '</p>';
                    html += '<p style="margin: 5px 0;"><strong>Date:</strong> ' + failure.date + ' at ' + failure.time + '</p>';
                    if (f < sample.qcFailures.length - 1) html += '<hr style="border-top: 1px solid #dc3545;">';
                    html += '</div>';
                }
                if (sample.reprocessCount) {
                    html += '<p style="margin: 10px 0; font-weight: bold;">Total re-process count: ' + sample.reprocessCount + '</p>';
                }
                html += '</div>';
            }

            document.getElementById('auditTrailContent').innerHTML = html;
            document.getElementById('auditTrailModal').style.display = 'block';
        }

        function closeAuditTrailModal() {
            document.getElementById('auditTrailModal').style.display = 'none';
        }

        function updateQuickStats() {
            var statsPanel = document.getElementById('quickStats');

            // Calculate stats
            var totalSamples = samples.length;
            var completedSamples = 0;
            var inProgressSamples = 0;
            var qcFailures = 0;
            var lastAdded = null;

            for (var i = 0; i < samples.length; i++) {
                var s = samples[i];
                if (s.status === 'Qubit Complete') {
                    completedSamples++;
                } else if (s.status !== 'Received') {
                    inProgressSamples++;
                }

                // Check for QC failures
                if (s.cleanExtractionQubitDetails) {
                    var ceQC = checkQCThreshold(s.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
                    if (!ceQC.pass) qcFailures++;
                }
                if (s.qubitDetails) {
                    var fqQC = checkQCThreshold(s.qubitDetails.concentration, 'finalQubit');
                    if (!fqQC.pass) qcFailures++;
                }

                // Track last added
                if (!lastAdded || new Date(s.dateAdded) > new Date(lastAdded.dateAdded)) {
                    lastAdded = s;
                }
            }

            var completionRate = totalSamples > 0 ? Math.round((completedSamples / totalSamples) * 100) : 0;

            var html = '';

            // Total samples
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + totalSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Total Samples</div>';
            html += '</div>';

            // Completion rate
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + completionRate + '%</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">Completion Rate</div>';
            html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + completedSamples + ' of ' + totalSamples + ' complete</div>';
            html += '</div>';

            // In progress
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold;">' + inProgressSamples + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">In Progress</div>';
            html += '</div>';

            // QC Failures
            var qcColor = qcFailures > 0 ? '#ff6b6b' : '#51cf66';
            html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
            html += '<div style="font-size: 32px; font-weight: bold; color: ' + qcColor + ';">' + qcFailures + '</div>';
            html += '<div style="font-size: 14px; opacity: 0.9;">QC Warnings</div>';
            html += '</div>';

            // Average turnaround time
            var turnaroundDays = [];
            for (var i = 0; i < samples.length; i++) {
                var days = calculateTurnaroundDays(samples[i]);
                if (days !== null) {
                    turnaroundDays.push(days);
                }
            }
            var avgTurnaround = turnaroundDays.length > 0
                ? Math.round(turnaroundDays.reduce(function(a, b) { return a + b; }, 0) / turnaroundDays.length)
                : 0;

            if (turnaroundDays.length > 0) {
                var turnaroundColor = avgTurnaround <= 7 ? '#51cf66' : avgTurnaround <= 14 ? '#ffc107' : '#ff6b6b';
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
                html += '<div style="font-size: 32px; font-weight: bold; color: ' + turnaroundColor + ';">' + avgTurnaround + '</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Avg Days to Complete</div>';
                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Based on ' + turnaroundDays.length + ' samples</div>';
                html += '</div>';
            }

            // Last added
            if (lastAdded) {
                html += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">';
                html += '<div style="font-size: 16px; font-weight: bold;">' + lastAdded.id + '</div>';
                html += '<div style="font-size: 14px; opacity: 0.9;">Last Added</div>';
                html += '<div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">' + lastAdded.dateAdded + '</div>';
                html += '</div>';
            }

            statsPanel.innerHTML = html;
        }

        function updateDashboard() {
            var statusCounts = {
                'Received': 0,
                'BAP Complete': 0,
                'TSB Complete': 0,
                'Extraction Complete': 0,
                'Clean Extraction Complete': 0,
                'Clean Extraction Qubit Complete': 0,
                'Indexing Complete': 0,
                'Qubit Complete': 0
            };

            for (var i = 0; i < samples.length; i++) {
                var status = samples[i].status;
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            }

            var dashboard = document.getElementById('statusDashboard');
            var html = '';

            var statuses = [
                {name: 'Received', icon: 'üì•', color: '#495057', bg: '#e9ecef'},
                {name: 'BAP Complete', icon: 'üß´', color: '#155724', bg: '#d4edda'},
                {name: 'TSB Complete', icon: 'üß™', color: '#856404', bg: '#fff3cd'},
                {name: 'Extraction Complete', icon: 'üß¨', color: '#7b1fa2', bg: '#f3e5f5'},
                {name: 'Clean Extraction Complete', icon: 'üßΩ', color: '#2e7d32', bg: '#e8f5e8'},
                {name: 'Clean Extraction Qubit Complete', icon: 'üìä', color: '#1565c0', bg: '#e8f4fd'},
                {name: 'Indexing Complete', icon: 'üî¨', color: '#1976d2', bg: '#e3f2fd'},
                {name: 'Qubit Complete', icon: '‚úÖ', color: '#f57c00', bg: '#fff3e0'}
            ];

            for (var i = 0; i < statuses.length; i++) {
                var s = statuses[i];
                html += '<div style="background: ' + s.bg + '; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ' + s.color + '20;">';
                html += '<div style="font-size: 24px;">' + s.icon + '</div>';
                html += '<div style="font-size: 28px; font-weight: bold; color: ' + s.color + '; margin: 5px 0;">' + statusCounts[s.name] + '</div>';
                html += '<div style="font-size: 11px; color: ' + s.color + '; font-weight: 600;">' + s.name.toUpperCase() + '</div>';
                html += '</div>';
            }

            html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #dee2e6;">';
            html += '<div style="font-size: 24px;">üì¶</div>';
            html += '<div style="font-size: 28px; font-weight: bold; color: #212529; margin: 5px 0;">' + samples.length + '</div>';
            html += '<div style="font-size: 11px; color: #495057; font-weight: 600;">TOTAL SAMPLES</div>';
            html += '</div>';

            dashboard.innerHTML = html;
        }

        function sortSamples() {
            var sortType = document.getElementById('sortSelect').value;

            if (sortType === 'dateDesc') {
                // Newest first (reverse chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(b) - samples.indexOf(a);
                });
            } else if (sortType === 'dateAsc') {
                // Oldest first (chronological)
                samples.sort(function(a, b) {
                    return samples.indexOf(a) - samples.indexOf(b);
                });
            } else if (sortType === 'idAsc') {
                // ID A-Z
                samples.sort(function(a, b) {
                    return a.id.localeCompare(b.id);
                });
            } else if (sortType === 'idDesc') {
                // ID Z-A
                samples.sort(function(a, b) {
                    return b.id.localeCompare(a.id);
                });
            } else if (sortType === 'status') {
                // By workflow status
                var statusOrder = ['Received', 'BAP Complete', 'TSB Complete', 'Extraction Complete',
                                  'Clean Extraction Complete', 'Clean Extraction Qubit Complete',
                                  'Indexing Complete', 'Qubit Complete'];
                samples.sort(function(a, b) {
                    var aIndex = statusOrder.indexOf(a.status);
                    var bIndex = statusOrder.indexOf(b.status);
                    return aIndex - bIndex;
                });
            }

            saveData();
            renderSamples();
        }

        function renderSamples() {
            var container = document.getElementById('sampleContainer');

            if (samples.length === 0) {
                container.innerHTML = '<p>No samples yet. Add one above!</p>';
                updateQuickStats();
                updateDashboard();
                return;
            }

            var receivedCount = 0;
var bapCount = 0;
var tsbCount = 0;
var extractionCount = 0;
var cleanExtractionCount = 0;
var cleanExtractionQubitCount = 0;
var indexingCount = 0;
            
            for (var i = 0; i < samples.length; i++) {
                if (samples[i].status === 'Received') receivedCount++;
else if (samples[i].status === 'BAP Complete') bapCount++;
else if (samples[i].status === 'TSB Complete') tsbCount++;
else if (samples[i].status === 'Extraction Complete') extractionCount++;
else if (samples[i].status === 'Clean Extraction Complete') cleanExtractionCount++;
else if (samples[i].status === 'Clean Extraction Qubit Complete') cleanExtractionQubitCount++;
else if (samples[i].status === 'Indexing Complete') indexingCount++;
            }
            
            var html = '';
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                var showCheckbox = false;
                
                if (receivedCount >= 2 && sample.status === 'Received') showCheckbox = true;
                else if (bapCount >= 2 && sample.status === 'BAP Complete') showCheckbox = true;
                else if (tsbCount >= 2 && sample.status === 'TSB Complete') showCheckbox = true;
                else if (extractionCount >= 2 && sample.status === 'Extraction Complete') showCheckbox = true;
                else if (cleanExtractionCount >= 2 && sample.status === 'Clean Extraction Complete') showCheckbox = true;
                else if (cleanExtractionQubitCount >= 2 && sample.status === 'Clean Extraction Qubit Complete') showCheckbox = true;
                else if (indexingCount >= 2 && sample.status === 'Indexing Complete') showCheckbox = true;
                
                html += '<div class="sample-item">';
                html += '<div class="sample-info">';

                // Always show checkbox for bulk operations
                var isChecked = bulkSelectedSamples.indexOf(sample.id) !== -1 ? ' checked' : '';
                html += '<input type="checkbox" class="sample-checkbox" value="' + sample.id + '" onchange="toggleSampleSelection(\'' + sample.id.replace(/'/g, "\\'") + '\', this)"' + isChecked + '> ';

                if (showCheckbox) {
                    // Batch processing checkbox (keep for compatibility)
                    html += '<input type="checkbox" class="sample-checkbox-batch" value="' + sample.id + '" onchange="updateSelection()"> ';
                }
                
                html += '<strong>' + sample.id + '</strong> ';
                html += '<span class="status status-' + sample.status.toLowerCase().replace(/ /g, '-') + '">' + sample.status + '</span>';

                // Show flag if not None
                if (sample.flag && sample.flag !== 'None') {
                    var flagIcon = sample.flag === 'Rush' ? 'üî¥' : sample.flag === 'Hold' ? '‚è∏Ô∏è' : '‚ö†Ô∏è';
                    var flagColor = sample.flag === 'Rush' ? '#dc3545' : sample.flag === 'Hold' ? '#ffc107' : '#fd7e14';
                    html += ' <span style="background: ' + flagColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 4px;">' + flagIcon + ' ' + sample.flag + '</span>';
                }

                // Show turnaround time for completed samples
                var turnaroundDays = calculateTurnaroundDays(sample);
                if (turnaroundDays !== null) {
                    var turnaroundColor = turnaroundDays <= 7 ? '#28a745' : turnaroundDays <= 14 ? '#ffc107' : '#dc3545';
                    html += ' <span style="background: ' + turnaroundColor + '; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px;">‚è±Ô∏è ' + turnaroundDays + ' days</span>';
                }

                html += '<br><small>Added: ' + sample.dateAdded + ' | ' + sample.initials + '</small>';

                // Add progress bar
                html += getProgressBarHTML(sample);

                // In compact view, skip all the detailed info
                if (!isCompactView) {
                if (sample.bapDetails) {
                    html += '<br>BAP: ' + sample.bapNumber;
                    if (sample.bapDetails.timeIn || sample.bapDetails.timeOut) {
                        html += '<br><small>' + sample.bapDetails.temperature + '¬∞C, ' + sample.bapDetails.incubator;
                        if (sample.bapDetails.timeIn) html += ' | In: ' + sample.bapDetails.timeIn;
                        if (sample.bapDetails.timeOut) html += ' | Out: ' + sample.bapDetails.timeOut;
                        html += '</small>';
                    }
                }
                if (sample.tsbDetails) {
                    html += '<br>TSB: ' + sample.tsbNumber;
                    if (sample.tsbDetails.timeIn || sample.tsbDetails.timeOut) {
                        html += '<br><small>' + sample.tsbDetails.temperature + '¬∞C, ' + sample.tsbDetails.incubator;
                        if (sample.tsbDetails.timeIn) html += ' | In: ' + sample.tsbDetails.timeIn;
                        if (sample.tsbDetails.timeOut) html += ' | Out: ' + sample.tsbDetails.timeOut;
                        html += '</small>';
                    }
                }
                if (sample.extractionDetails) {
                    html += '<br>Extraction: ' + sample.extractionNumber + ' | Run: ' + sample.extractionDetails.extractionRun;
                    if (sample.extractionDetails.reagentLots && sample.extractionDetails.reagentLots.aw1) {
                        html += '<br><small>AW1: ' + sample.extractionDetails.reagentLots.aw1 + ' | AW2: ' + sample.extractionDetails.reagentLots.aw2 + '</small>';
                    }
                }
                if (sample.cleanExtractionDetails) {
                    html += '<br>Clean Extraction: ' + sample.cleanExtractionNumber + ' | Plate: ' + sample.cleanExtractionDetails.storagePlate + ' | Well: ' + sample.cleanExtractionDetails.wellPosition;
                    if (sample.cleanExtractionDetails.volumes && sample.cleanExtractionDetails.volumes.cleanup) {
                        html += '<br><small>Cleanup: ' + sample.cleanExtractionDetails.volumes.cleanup + ' | In: ' + sample.cleanExtractionDetails.volumes.elutionIn + ' | Out: ' + sample.cleanExtractionDetails.volumes.elutionOut + '</small>';
                    }
                }
                if (sample.indexingDetails) {
                    html += '<br>Indexing: ' + sample.indexingNumber + ' | Plate: ' + sample.indexingDetails.storagePlate + ' | Well: ' + sample.indexingDetails.wellPosition;
                    if (sample.indexingDetails.indexes && sample.indexingDetails.indexes.i5 && sample.indexingDetails.indexes.i7) {
                        html += '<br><small>i5: ' + sample.indexingDetails.indexes.i5 + ' | i7: ' + sample.indexingDetails.indexes.i7 + ' | Thaws: ' + sample.indexingDetails.indexes.i5Thaws + '/' + sample.indexingDetails.indexes.i7Thaws + '</small>';
                    }
                }
                if (sample.cleanExtractionQubitDetails) {
    var ceQC = checkQCThreshold(sample.cleanExtractionQubitDetails.concentration, 'cleanExtractionQubit');
    var ceStyle = ceQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Clean Extraction Qubit: <span' + ceStyle + '>' + sample.cleanExtractionQubitDetails.concentration + ' ng/uL</span>';
    if (!ceQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + ceQC.message + '</span>';
    }
    if (sample.cleanExtractionQubitDetails.reagentLot) {
        html += '<br><small>CE Qubit Reagent: ' + sample.cleanExtractionQubitDetails.reagentLot + ' | Date: ' + (sample.cleanExtractionQubitDetails.dateQubited || sample.cleanExtractionQubitDetails.completedDate) + '</small>';
    }
}
if (sample.qubitDetails) {
    var fqQC = checkQCThreshold(sample.qubitDetails.concentration, 'finalQubit');
    var fqStyle = fqQC.pass ? '' : ' style="color: #dc3545; font-weight: bold;"';
    html += '<br>Final Qubit: <span' + fqStyle + '>' + sample.qubitDetails.concentration + ' ng/uL</span>';
    if (!fqQC.pass) {
        html += ' <span style="color: #dc3545; font-size: 12px;">' + fqQC.message + '</span>';
    }
    if (sample.qubitDetails.reagentLot) {
        html += '<br><small>Final Qubit Reagent: ' + sample.qubitDetails.reagentLot + ' | Date: ' + (sample.qubitDetails.dateQubited || sample.qubitDetails.completedDate) + '</small>';
    }
}
                
                // Show notes if they exist
                if (sample.notes && sample.notes.trim()) {
                    html += '<br><small style="color: #6c757d; font-style: italic;">üìù ' + sample.notes + '</small>';
                }

                // Show QC failure history if exists
                if (sample.qcFailures && sample.qcFailures.length > 0) {
                    html += '<br><div style="background: #ffe6e6; border-left: 4px solid #dc3545; padding: 8px; margin-top: 8px; border-radius: 4px;">';
                    html += '<strong style="color: #dc3545;">‚ö†Ô∏è QC Failures (' + sample.qcFailures.length + '):</strong>';
                    for (var f = 0; f < sample.qcFailures.length; f++) {
                        var failure = sample.qcFailures[f];
                        html += '<br><small>' + (f + 1) + '. ' + failure.stage + ': ' + failure.reason;
                        if (failure.notes) html += ' - ' + failure.notes;
                        html += ' (' + failure.date + ')';
                        html += '</small>';
                    }
                    if (sample.reprocessCount) {
                        html += '<br><small><strong>Re-processed: ' + sample.reprocessCount + ' time(s)</strong></small>';
                    }
                    html += '</div>';
                }
                } // End of !isCompactView

                html += '</div>';
                html += '<div class="sample-actions">';
                html += '<button onclick="viewSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">View</button><br>';
                html += '<button onclick="editSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #ffc107; color: #212529; border: none; border-radius: 4px; margin-bottom: 4px; font-weight: 600;">Edit</button><br>';
                html += '<button onclick="editNotes(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Notes</button><br>';
                html += '<button onclick="changeFlag(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #fd7e14; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Flag</button><br>';
                html += '<button onclick="cloneSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Clone</button><br>';
                html += '<button onclick="showQRCode(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="font-size: 11px; padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">QR Code</button><br>';
                html += '<button onclick="deleteSample(\'' + sample.id + '\')" style="font-size: 11px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; margin-bottom: 4px;">Delete</button><br>';

                if (sample.status === 'Received') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'BAP\')">Start BAP</button>';
                } else if (sample.status === 'BAP In Progress') {
                    html += '<button onclick="finishProcess(\'' + sample.id + '\', \'BAP\')" style="background: #28a745;">Finish BAP</button>';
                } else if (sample.status === 'BAP Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'TSB\')">Start TSB</button>';
                } else if (sample.status === 'TSB In Progress') {
                    html += '<button onclick="finishProcess(\'' + sample.id + '\', \'TSB\')" style="background: #28a745;">Finish TSB</button>';
                } else if (sample.status === 'TSB Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Extraction\')">Start Extraction</button>';
                } else if (sample.status === 'Extraction Complete') {
                    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction\')">Start Clean Extraction</button>';
                } else if (sample.status === 'Clean Extraction Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Clean Extraction Qubit\')">Start Qubit</button>';
} else if (sample.status === 'Clean Extraction Qubit Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Indexing\')">Start Indexing</button><br>';
    html += '<button onclick="markQCFailed(\'' + sample.id.replace(/'/g, "\\'") + '\', \'CE Qubit\')" style="background: #dc3545; margin-top: 4px;">QC Failed</button>';
} else if (sample.status === 'Indexing Complete') {
    html += '<button onclick="startProcess(\'' + sample.id + '\', \'Final Qubit\')">Start Final Qubit</button>';
                } else if (sample.status === 'Qubit Complete') {
                    html += '<button onclick="markQCFailed(\'' + sample.id.replace(/'/g, "\\'") + '\', \'Final Qubit\')" style="background: #dc3545;">QC Failed</button><br>';
                    html += '<div style="color: green; font-weight: bold; text-align: center; margin-top: 4px;">‚úì Complete</div>';
                } else if (sample.status === 'QC Failed') {
                    html += '<div style="color: red; font-weight: bold; text-align: center;">‚úó QC Failed</div>';
                    html += '<button onclick="reprocessSample(\'' + sample.id.replace(/'/g, "\\'") + '\')" style="background: #28a745; margin-top: 4px;">Re-process</button>';
                } else {
                    html += '<div style="color: green; font-weight: bold; text-align: center;">‚úì Complete</div>';
                }
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            updateSelection();
            updateQuickStats();
            updateDashboard();
        }

        // Password protection
        function checkPassword() {
            var password = document.getElementById('passwordInput').value;
            var correctPassword = 'bwgs2025'; // CHANGE THIS to your desired password

            if (password === correctPassword) {
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                sessionStorage.setItem('bwgsAuthenticated', 'true');
                loadData();
                renderSamples();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        // Check if already authenticated in this session
        if (sessionStorage.getItem('bwgsAuthenticated') === 'true') {
            document.getElementById('passwordOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Only if authenticated
            if (sessionStorage.getItem('bwgsAuthenticated') !== 'true') return;

            // Ctrl/Cmd + F - Focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
                document.getElementById('searchInput').select();
            }

            // Ctrl/Cmd + E - Export JSON
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportData();
            }

            // Ctrl/Cmd + Shift + E - Export CSV
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                exportCSV();
            }

            // Ctrl/Cmd + I - Import
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                importData();
            }

            // Ctrl/Cmd + N - Focus new sample input
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('sampleId').focus();
            }

            // Number keys 1-5 for quick filters
            if (e.key >= '1' && e.key <= '5' && !e.ctrlKey && !e.metaKey && !e.shiftKey) {
                var activeElement = document.activeElement;
                // Only if not typing in input/textarea
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    var filters = document.getElementsByName('statusFilter');
                    if (filters[parseInt(e.key) - 1]) {
                        filters[parseInt(e.key) - 1].checked = true;
                        filterSamples();
                    }
                }
            }

            // Ctrl/Cmd + T - Timeline
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                showTimeline();
            }

            // Ctrl/Cmd + A - Analytics
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                showAnalytics();
            }

            // Ctrl/Cmd + R - Reagent Search
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showReagentSearch();
            }

            // Ctrl/Cmd + P - Plate Map
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                showPlateMap();
            }

            // Ctrl/Cmd + K - Keyboard Shortcuts
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                showKeyboardShortcuts();
            }

            // Ctrl/Cmd + B - Toggle Bulk Input
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleBulkInput();
            }

            // Ctrl/Cmd + D - Toggle Dark Mode
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }

            // Ctrl/Cmd + M - Toggle Compact View
            if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
                e.preventDefault();
                toggleCompactView();
            }

            // Escape - Close modals
            if (e.key === 'Escape') {
                closeModal();
                closeBatchModal();
                closeEditModal();
                closeShortcutsModal();
                closePlateMapModal();
                closeTimelineModal();
                closeAnalyticsModal();
                closeQRCodeModal();
                closeReagentSearchModal();
                closeAuditTrailModal();
            }
        });

        // Load theme preference on page load (before authentication check)
        loadTheme();

        // Load saved data and render on page load (only if authenticated)
        if (sessionStorage.getItem('bwgsAuthenticated') === 'true') {
            loadData();
            renderSamples();
        }
        console.log('Lab Workflow Tracker loaded successfully!');
        console.log('Keyboard shortcuts: Ctrl+F (search), Ctrl+E (export), Ctrl+N (new sample), Esc (close), 1-5 (filters)');
    </script>
    </div> <!-- Close appContent div -->
</body>
</html>>